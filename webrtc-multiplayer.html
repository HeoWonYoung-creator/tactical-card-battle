<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cast Me If You Can</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Pretendard:wght@300;400;500;600;700&family=MedievalSharp:wght@400&family=Uncial+Antiqua&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background: 
                linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 20px,
                    rgba(0, 0, 0, 0.03) 20px,
                    rgba(0, 0, 0, 0.03) 40px
                );
            background-size: 100% 100%, 40px 40px;
            background-position: 0 0, 0 0;
            background-repeat: no-repeat, repeat;
            color: #333333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        .font-cinzel {
            font-family: 'Cinzel Decorative', cursive;
        }
        .font-orbitron {
            font-family: 'Orbitron', monospace;
        }
        .font-exo {
            font-family: 'Pretendard', sans-serif;
        }
        .game-title {
            font-family: 'UnifrakturMaguntia', cursive;
            font-weight: 900;
            color: #333333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 2px;
        }
        .card {
            width: 70px;
            height: 100px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .card-back {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            color: #6c757d;
            border: 2px solid #dee2e6;
        }
        .card-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .card-front {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            color: #333333;
            border: 1px solid #dee2e6;
        }
        .card-front:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .card-pile {
             cursor: help;
             transition: transform 0.3s ease;
        }
        .card-pile:hover {
            transform: scale(1.05);
        }
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
        }
        .btn-primary:disabled {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        
        .btn-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: rgba(108, 117, 125, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        
        .btn-secondary:disabled {
            background: transparent;
            color: #adb5bd;
            border-color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        .memo-button {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #6c757d;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            font-family: 'Pretendard', sans-serif;
            font-weight: 500;
            font-size: 0.6rem;
            min-height: 24px;
        }
        .memo-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .memo-button.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-color: #dc3545;
        }
        .memo-button.active:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.4);
        }
        .game-log {
            height: 150px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-family: 'Pretendard', sans-serif;
        }
        .game-log p {
            margin: 2px 0;
            padding: 3px 8px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .game-log p:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .modal-bg {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #dee2e6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
            font-family: 'Pretendard', sans-serif;
            color: #333333;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº */
        #secret-stones-tooltip::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid white;
        }
        
        #used-stones-tooltip::before {
            content: '';
            position: absolute;
            right: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid white;
        }
        
        #secret-stones-tooltip::after {
            content: '';
            position: absolute;
            left: -9px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid #d1d5db;
        }
        
        #used-stones-tooltip::after {
            content: '';
            position: absolute;
            right: -9px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #d1d5db;
        }
        .player-area-glow {
            box-shadow: 0 0 10px 4px rgba(0, 123, 255, 0.6);
            animation: glowPulse 1.5s ease-in-out infinite;
            border: 1px solid rgba(0, 123, 255, 0.7);
            border-radius: 12px;
            position: relative;
        }
        .player-area-glow.opponent-turn {
            box-shadow: 0 0 10px 4px rgba(220, 53, 69, 0.6);
            border-color: rgba(220, 53, 69, 0.7);
            border: 1px solid rgba(220, 53, 69, 0.7);
        }
        .player-area-glow.opponent-turn::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.15));
            border-radius: 14px;
            z-index: -1;
            animation: backgroundPulseRed 2s ease-in-out infinite;
        }
        .player-area-glow::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, rgba(0, 123, 255, 0.05), rgba(0, 123, 255, 0.15));
            border-radius: 14px;
            z-index: -1;
            animation: backgroundPulse 2s ease-in-out infinite;
        }
        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 10px 4px rgba(0, 123, 255, 0.6);
                border-color: rgba(0, 123, 255, 0.7);
            }
            50% { 
                box-shadow: 0 0 15px 6px rgba(0, 123, 255, 0.8);
                border-color: rgba(0, 123, 255, 0.8);
            }
        }
        .player-area-glow.opponent-turn {
            animation: glowPulseRed 1.5s ease-in-out infinite;
        }
        @keyframes glowPulseRed {
            0%, 100% { 
                box-shadow: 0 0 10px 4px rgba(220, 53, 69, 0.6);
                border-color: rgba(220, 53, 69, 0.7);
            }
            50% { 
                box-shadow: 0 0 15px 6px rgba(220, 53, 69, 0.8);
                border-color: rgba(220, 53, 69, 0.8);
            }
        }
        @keyframes backgroundPulseRed {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.02);
            }
        }
        @keyframes backgroundPulse {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.02);
            }
        }
        .health-heart {
            animation: heartBeat 1s ease-in-out infinite;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        

        

        .spell-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-family: 'Pretendard', sans-serif;
            /* ÎπÑÌôúÏÑ±ÌôîÎêú Î≤ÑÌäºÎèÑ Ìï≠ÏÉÅ Î≥¥Ïù¥ÎèÑÎ°ù ÏÑ§Ï†ï */
            display: block !important;
            visibility: visible !important;
        }
        .spell-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.4);
        }
        .spell-button:active:not(:disabled) {
            transform: translateY(-1px) scale(1.02);
        }
        .success-animation {
            animation: successGlow 0.5s ease-out;
        }
        @keyframes successGlow {
            0% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
            100% { box-shadow: 0 0 0 rgba(255, 255, 255, 0); }
        }
        .failure-animation {
            animation: failureShake 0.5s ease-out;
        }
        @keyframes failureShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .turn-indicator {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 50%;
            animation: turnPulse 1s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 4px rgba(0, 123, 255, 0.3);
            z-index: 10;
        }
        .turn-indicator.opponent-turn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 1px 4px rgba(220, 53, 69, 0.3);
            animation: turnPulseRed 1s ease-in-out infinite;
        }
        @keyframes turnPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
                box-shadow: 0 1px 4px rgba(0, 123, 255, 0.3);
            }
            50% { 
                transform: scale(1.2); 
                opacity: 0.9;
                box-shadow: 0 3px 10px rgba(0, 123, 255, 0.5);
            }
        }
        .turn-indicator.opponent-turn {
            animation: turnPulseRed 1s ease-in-out infinite;
        }
        @keyframes turnPulseRed {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
                box-shadow: 0 1px 4px rgba(220, 53, 69, 0.3);
            }
            50% { 
                transform: scale(1.2); 
                opacity: 0.9;
                box-shadow: 0 3px 10px rgba(220, 53, 69, 0.5);
            }
        }
        .card-damage {
            position: absolute;
            color: #ffffff;
            font-weight: bold;
            font-size: 1.2rem;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }
        @keyframes damageFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .card-heal {
            position: absolute;
            color: #ffffff;
            font-weight: bold;
            font-size: 1.2rem;
            animation: healFloat 1s ease-out forwards;
            pointer-events: none;
        }
        

        @keyframes healFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        /* ÌååÌã∞ÌÅ¥ Ìö®Í≥º Ïä§ÌÉÄÏùº */
        .particle {
            position: fixed;
            pointer-events: none;
            font-size: 1.5rem;
            animation: particleExplode 2s ease-out forwards;
            z-index: 9999;
            will-change: transform, opacity;
            transform-origin: center;
        }
        
        @keyframes particleExplode {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }
            40% {
                opacity: 1;
            }
            100% {
                transform: scale(0.1) translate(var(--x), var(--y));
                opacity: 0;
            }
        }
        
        /* ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        #refresh-game-btn {
            transition: all 0.3s ease;
            opacity: 0.8;
        }
        #refresh-game-btn:hover {
            opacity: 1;
            transform: scale(1.02);
        }
        #refresh-game-btn:active {
            transform: scale(0.98);
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî Ïä§ÌÉÄÏùº */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Î≤ÑÌäº ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî */
            .btn-primary, .btn-secondary {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 16px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Ïπ¥Îìú ÌÅ¨Í∏∞ Ï°∞Ï†ï */
            .spell-card {
                width: 50px;
                height: 70px;
                font-size: 20px;
                margin: 0 2px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Í≤åÏûÑ Î°úÍ∑∏ Ïà®ÍπÄ */
            #game-log {
                display: none !important;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Î™®Îã¨ ÌÅ¨Í∏∞ Ï°∞Ï†ï */
            .modal-content {
                max-width: 95vw;
                margin: 10px;
                padding: 15px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Ï£ºÎ¨∏ Î≤ÑÌäº Ïª¥Ìå©Ìä∏Ìôî */
            .spell-button {
                width: 60px;
                height: 60px;
                font-size: 24px;
                margin: 4px;
                border-radius: 8px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú ÌîåÎ†àÏù¥Ïñ¥ ÏòÅÏó≠ Ï°∞Ï†ï */
            #player-area, #opponent-area {
                padding: 10px;
                margin: 5px 0;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ Ï°∞Ï†ï */
            .title-content {
                padding: 20px;
            }
            
            .title-content h1 {
                font-size: 24px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Î≤ÑÌäº Í∑∏Î£π Ï°∞Ï†ï */
            .button-group {
                gap: 8px;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú Î©îÎ™® Ìå®ÎÑê Ïà®ÍπÄ */
            #memo-panel {
                display: none !important;
            }
            
            /* Î™®Î∞îÏùºÏóêÏÑú ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ïà®ÍπÄ */
            #debug-info {
                display: none !important;
            }
        }

        /* ÌÑ∞Ïπò ÏµúÏ†ÅÌôî */
        @media (hover: none) and (pointer: coarse) {
            /* ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú Ìò∏Î≤Ñ Ìö®Í≥º Ï†úÍ±∞ */
            .spell-button:hover,
            .btn-primary:hover,
            .btn-secondary:hover {
                transform: none;
            }
            
            /* ÌÑ∞Ïπò ÌîºÎìúÎ∞± */
            .spell-button:active,
            .btn-primary:active,
            .btn-secondary:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
        }

        /* Ïª¥Ìå©Ìä∏ Î™®Îìú (Î™®Î∞îÏùº Ï†ÑÏö©) */
        .compact-mode {
            --card-size: 40px;
            --button-size: 50px;
            --spacing: 4px;
        }
        
        .compact-mode .spell-card {
            width: var(--card-size);
            height: calc(var(--card-size) * 1.4);
            font-size: 16px;
            margin: 0 var(--spacing);
        }
        
        .compact-mode .spell-button {
            width: var(--button-size);
            height: var(--button-size);
            font-size: 20px;
            margin: var(--spacing);
        }
        
        .compact-mode #game-log,
        .compact-mode #memo-panel,
        .compact-mode #debug-info {
            display: none !important;
        }
        
        .compact-mode .player-info {
            font-size: 12px;
        }
        
        .compact-mode .health-display {
            font-size: 18px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ -->
    <div id="title-screen" class="w-full max-w-2xl mx-auto text-center">
        <div class="mb-6">
            <img src="magic_battle.png" alt="MAGIC FLIP ÌÉÄÏù¥ÌãÄ" class="mx-auto max-w-xs md:max-w-sm h-auto rounded-lg">
        </div>
        <h1 class="text-5xl game-title mb-8">Cast Me If You Can</h1>
        <div class="bg-black bg-opacity-10 p-6 rounded-lg text-left mb-8 relative">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-center font-exo flex items-center justify-center"><span>üìù</span><span class="ml-1">Í≤åÏûÑ Í∑úÏπô</span></h3>
                <button id="spell-cards-btn" class="px-3 py-1 rounded-lg font-bold btn-secondary text-sm whitespace-nowrap">üßô‚Äç‚ôÇÔ∏è Ïπ¥Îìú Î≥¥Í∏∞</button>
            </div>
            <ul class="list-disc list-inside space-y-1">
                <li>ÏÉÅÎåÄÏùò ÎßàÎ≤ï Ïπ¥ÎìúÎ•º Î≥¥Í≥†, Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÏûêÏã†Ïùò Ïπ¥ÎìúÎ•º Ï∂îÏ∏°Ìï¥ ÏòÅÏ∞ΩÌïòÏÑ∏Ïöî.</li>
                <li>ÏòÅÏ∞ΩÏóê ÏÑ±Í≥µÌïòÎ©¥ Ï∂îÍ∞ÄÎ°ú Í∞ôÍ±∞ÎÇò, Îçî ÎÜíÏùÄ Ïà´ÏûêÏùò ÏòÅÏ∞ΩÏùÑ ÏãúÏ†ÑÌï† Ïàò ÏûàÏäµÎãàÎã§.</li>
                <li>ÏòÅÏ∞ΩÏóê Ïã§Ìå®ÌïòÎ©¥ Ï≤¥Î†•Ïù¥ 1 Í∞êÏÜåÌïòÍ≥† ÌÑ¥Ïù¥ Ï¢ÖÎ£åÎê©ÎãàÎã§.</li>
                <li>ÏÉÅÎåÄÏùò Ï≤¥Î†•ÏùÑ 0ÏúºÎ°ú ÎßåÎì§Í±∞ÎÇò, ÎÇ¥ ÎßàÎ≤ï Ïπ¥ÎìúÎ•º Î™®Îëê ÏÇ¨Ïö©ÌïòÎ©¥ ÏäπÎ¶¨Ìï©ÎãàÎã§!</li>
            </ul>
        </div>
        <!-- ÎßàÎ≤ïÏÇ¨ Ï†ïÎ≥¥ ÏòÅÏó≠ -->
        <div class="bg-black bg-opacity-10 p-4 rounded-lg mb-6">
            <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-bold text-white">ÎßàÎ≤ïÏÇ¨ Ï†ïÎ≥¥</label>
                <span id="account-status" class="text-xs text-green-400 hidden">‚úì Î°úÍ∑∏Ïù∏Îê®</span>
            </div>
            
            <!-- Í≤åÏä§Ìä∏ Î™®Îìú ÌëúÏãú -->
            <div id="guest-mode-display" class="mb-4 p-3 bg-gray-700 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="text-xl">üë§</div>
                        <div class="flex flex-col items-start">
                            <div class="text-sm font-bold text-white">Í≤åÏä§Ìä∏ Î™®Îìú</div>
                            <div class="text-xs text-gray-300">Î™®Ïùò Í≤∞Ìà¨Îßå Í∞ÄÎä•ÌïòÎ©∞, Ï†êÏàòÍ∞Ä Ï†ÄÏû•ÎêòÏßÄ ÏïäÏäµÎãàÎã§</div>
                        </div>
                    </div>
                    <button id="login-btn" class="px-4 py-2 rounded-lg font-bold btn-primary text-sm">Î°úÍ∑∏Ïù∏</button>
                </div>
            </div>
            
            <!-- Í≥ÑÏ†ï Î™®Îìú ÌëúÏãú -->
            <div id="account-mode-display" class="mb-4 p-3 bg-gray-100 rounded-lg hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="text-xl mr-2">üë§</div>
                        <div id="account-nickname" class="text-sm font-bold text-gray-800">ÎãâÎÑ§ÏûÑ</div>
                    </div>
                    <button id="logout-btn" class="px-3 py-1 rounded-lg font-bold bg-red-600 hover:bg-red-700 text-white text-sm">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>
            
            <!-- Í≤åÏä§Ìä∏ Ïù¥Î¶Ñ ÏûÖÎ†• -->
            <div id="guest-name-input" class="mb-4">
                <div class="flex space-x-2">
                    <div class="flex-1 relative">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl pointer-events-none">üë§</div>
                        <input type="text" id="player-name-input" 
                               class="w-full px-3 py-2 pl-10 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-400"
                               placeholder="Í≤åÏä§Ìä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="15" value="">
                    </div>
                    <button id="save-name-btn" class="px-4 py-2 rounded-lg font-bold btn-primary text-sm whitespace-nowrap">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
        
        <div class="space-y-4">
            <button id="ai-battle-btn" class="w-full py-4 rounded-lg font-bold text-xl btn-primary border-2 border-white">Î™®Ïùò Í≤∞Ìà¨ <span class="text-sm font-normal">(vs AI ÌóàÏàòÏïÑÎπÑ)</span></button>
            <button id="multiplayer-btn" class="w-full py-4 rounded-lg font-bold text-xl bg-red-600 hover:bg-red-700 text-white transition-all duration-300 hover:transform hover:-translate-y-0.5 hover:shadow-lg" style="box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);">Ï†ïÏãù Í≤∞Ìà¨ <span class="text-sm font-normal">(vs Îã§Î•∏ ÎßàÎ≤ïÏÇ¨)</span></button>
            
            <!-- ÏäπÎ¶¨Ïùò Ï¶ùÌëú ÌëúÏãú ÏòÅÏó≠ -->
            <div id="trophy-display" class="flex justify-center items-center space-x-4 mb-4 hidden">
                <div class="text-2xl">üèÖ</div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm font-bold text-yellow-300">Î™®Ïùò Í≤∞Ìà¨</div>
                    <div id="ai-trophy-count" class="text-lg font-bold text-yellow-200">0</div>
                </div>
                <div class="text-gray-400">|</div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm font-bold text-red-300">Ï†ïÏãù Í≤∞Ìà¨</div>
                    <div id="multiplayer-trophy-count" class="text-lg font-bold text-red-200">0</div>
                </div>
            </div>
            
            <div class="flex justify-center space-x-2">
                <button id="profile-btn" class="w-1/2 py-2 rounded-lg font-bold text-base btn-secondary hidden">üë§ ÎÇ¥ Ï†ïÎ≥¥</button>
                <button id="ranking-btn" class="w-1/2 py-2 rounded-lg font-bold text-base btn-secondary hidden">üèÜ Îû≠ÌÇπ Î≥¥Í∏∞</button>
            </div>
        </div>
        
        <!-- AI ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Î™®Îã¨ -->
        <div id="ai-difficulty-modal" class="fixed inset-0 flex items-center justify-center hidden modal-bg z-50">
            <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                <div class="text-center">
                                         <div class="text-4xl mb-4">üé≠</div>
                                         <h3 class="text-xl font-bold mb-4">ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù</h3>
                     <p class="text-gray-300 mb-6">Ïñ¥Îñ§ ÌóàÏàòÏïÑÎπÑÎ•º ÌòºÏ≠êÎÇ¥ÏãúÍ≤†ÏäµÎãàÍπå?<br>ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                    <div class="space-y-3">
                        <button id="easy-ai-btn" class="w-full py-3 rounded-lg font-bold btn-primary text-green-400 hover:text-green-300">
                            Ïâ¨ÏõÄ
                            <div class="text-xs text-green-300 mt-1">(Î©çÏ≤≠Ìï®, ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏùå)</div>
                        </button>
                        <button id="normal-ai-btn" class="w-full py-3 rounded-lg font-bold btn-primary text-yellow-400 hover:text-yellow-300">
                            Î≥¥ÌÜµ
                            <div class="text-xs text-yellow-300 mt-1">(ÎòëÎòëÌï®, ÏãúÍ∞Ñ Ï†úÌïú 30Ï¥à)</div>
                        </button>
                        <button id="hard-ai-btn" class="w-full py-3 rounded-lg font-bold btn-primary text-red-400 hover:text-red-300">
                            Ïñ¥Î†§ÏõÄ
                            <div class="text-xs text-red-300 mt-1">(ÎåÄÎã®Ìï®, ÏãúÍ∞Ñ Ï†úÌïú 20Ï¥à)</div>
                        </button>
                        <button id="cancel-difficulty-btn" class="w-full py-2 rounded-lg font-bold btn-secondary">Ï∑®ÏÜå</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î™®Îã¨ -->
        <div id="auth-modal" class="fixed inset-0 flex items-center justify-center hidden modal-bg z-50">
            <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîê</div>
                    <h3 id="auth-title" class="text-xl font-bold mb-2">Î°úÍ∑∏Ïù∏</h3>
                    <p id="auth-subtitle" class="text-gray-600">Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏ÌïòÏó¨ Ï†êÏàòÎ•º Ï†ÄÏû•ÌïòÏÑ∏Ïöî</p>
                </div>
                
                <!-- Î°úÍ∑∏Ïù∏ Ìèº -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ÏïÑÏù¥Îîî</label>
                        <input type="text" id="login-username" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input type="password" id="login-password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" class="flex-1 py-2 rounded-lg font-bold btn-primary">Î°úÍ∑∏Ïù∏</button>
                        <button type="button" id="switch-to-register" class="flex-1 py-2 rounded-lg font-bold btn-secondary">ÌöåÏõêÍ∞ÄÏûÖ</button>
                    </div>
                </form>
                
                <!-- ÌöåÏõêÍ∞ÄÏûÖ Ìèº -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ÏïÑÏù¥Îîî</label>
                        <input type="text" id="register-username" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="3-20Ïûê ÏòÅÎ¨∏, Ïà´Ïûê, Ïñ∏ÎçîÏä§ÏΩîÏñ¥" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input type="password" id="register-password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="6Ïûê Ïù¥ÏÉÅ" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ÎãâÎÑ§ÏûÑ</label>
                        <input type="text" id="register-nickname" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="2-15Ïûê" required>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" class="flex-1 py-2 rounded-lg font-bold btn-primary">ÌöåÏõêÍ∞ÄÏûÖ</button>
                        <button type="button" id="switch-to-login" class="flex-1 py-2 rounded-lg font-bold btn-secondary">Î°úÍ∑∏Ïù∏</button>
                    </div>
                </form>
                
                <div class="text-center mt-4">
                    <button id="close-auth-btn" class="px-4 py-2 rounded-lg font-bold btn-secondary">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
        
        <!-- ÎßàÎ≤ï Ïπ¥Îìú Ï†ïÎ≥¥ Î™®Îã¨ -->
        <div id="spell-cards-modal" class="fixed inset-0 flex items-center justify-center hidden modal-bg z-50">
            <div class="modal-content p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="text-center">
                    <div class="text-4xl mb-4">üßô‚Äç‚ôÇÔ∏è</div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">ÎßàÎ≤ï Ïπ¥Îìú Ï†ïÎ≥¥</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-purple-100 to-purple-200 border-2 border-purple-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üîÆ</div>
                                <div class="font-bold text-purple-800">1: Ïö¥Î™Ö Î≥ÄÌôò</div>
                            </div>
                            <div class="text-sm text-purple-700 text-left">ÎπÑÎ∞Ä Ï£ºÎ¨∏ 3Í∞úÎ•º ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 border-2 border-yellow-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üí´</div>
                                <div class="font-bold text-yellow-800">2: ÎßàÎ†• Ï∞©Ï∑®</div>
                            </div>
                            <div class="text-sm text-yellow-700 text-left">ÌîºÌï¥ 1, ÌöåÎ≥µ 1</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-100 to-blue-200 border-2 border-blue-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üåÄ</div>
                                <div class="font-bold text-blue-800">3: Ï†ïÏã† ÍµêÎûÄ</div>
                            </div>
                            <div class="text-sm text-blue-700 text-left">Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÌïòÎÇòÎ•º ÏÉÅÎåÄ Ìå®Ïóê Ìà¨ÏûÖ</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-100 to-red-200 border-2 border-red-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üî•</div>
                                <div class="font-bold text-red-800">4: ÌôîÏóº ÌôîÏÇ¥</div>
                            </div>
                            <div class="text-sm text-red-700 text-left">ÌîºÌï¥ 1</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-100 to-green-200 border-2 border-green-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üß™</div>
                                <div class="font-bold text-green-800">5: ÏÉùÎ™Ö Î¨ºÏïΩ</div>
                            </div>
                            <div class="text-sm text-green-700 text-left">ÌöåÎ≥µ 1</div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-100 to-indigo-200 border-2 border-indigo-300 p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-2xl">üí§</div>
                                <div class="font-bold text-indigo-800">6: Î™ÖÏÉÅ</div>
                            </div>
                            <div class="text-sm text-indigo-700 text-left">ÎπÑÎ∞Ä Ï£ºÎ¨∏ 1Í∞úÎ•º Ï†ÑÏ≤¥ Í≥µÍ∞ú</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-300 p-4 rounded-lg mb-6 shadow-md">
                        <h4 class="font-bold text-gray-800 mb-2">üìä Îç± Íµ¨ÏÑ±</h4>
                        <p class="text-sm text-gray-700">
                            Í≤åÏûÑÏóêÏÑú ÏÇ¨Ïö©ÎêòÎäî ÎßàÎ≤ï Ïπ¥ÎìúÎäî Ï¥ù 21Ïû•Ïù¥Î©∞, Í∞ÅÍ∞Å Ï£ºÎ¨∏Ïóê Ï†ÅÌûå Ïà´ÏûêÎßåÌÅº Ï°¥Ïû¨Ìï©ÎãàÎã§.<br>
                            <span class="text-purple-600 font-semibold">1Î≤à Ï£ºÎ¨∏: 1Ïû•</span> | 
                            <span class="text-yellow-600 font-semibold">2Î≤à Ï£ºÎ¨∏: 2Ïû•</span> | 
                            <span class="text-blue-600 font-semibold">3Î≤à Ï£ºÎ¨∏: 3Ïû•</span> | 
                            <span class="text-red-600 font-semibold">4Î≤à Ï£ºÎ¨∏: 4Ïû•</span> | 
                            <span class="text-green-600 font-semibold">5Î≤à Ï£ºÎ¨∏: 5Ïû•</span> | 
                            <span class="text-indigo-600 font-semibold">6Î≤à Ï£ºÎ¨∏: 6Ïû•</span>
                        </p>
                    </div>
                    <button id="close-spell-cards-btn" class="px-6 py-2 rounded-lg btn-primary">ÌôïÏù∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
    <div id="game-screen" class="w-full max-w-4xl mx-auto space-y-2 hidden">
        <!-- ÏÉÅÎåÄ ÏòÅÏó≠ (Ìï≠ÏÉÅ ÏÉÅÎã®) -->
        <div id="opponent-area" class="p-4 border-2 border-red-400 rounded-lg transition-all duration-500 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-red-300">ÏÉÅÎåÄ</h2>
                <div id="opponent-health" class="flex items-center space-x-1 text-2xl"></div>
            </div>
            <div id="opponent-hand" class="flex justify-center space-x-2"></div>
            <div id="opponent-turn-indicator" class="turn-indicator hidden">ÏÉÅÎåÄ ÌÑ¥!</div>
        </div>

                <!-- Ï§ëÏïô ÏòÅÏó≠ -->
        <div class="flex justify-between items-center p-4 h-48">
            <div id="secret-stones-pile" class="flex flex-col items-center space-y-1 card-pile relative z-20">
                <div class="card card-back flex flex-col items-center justify-center" 
                     ontouchstart="startLongPress('secret')" ontouchend="hideTooltips()" 
                     onmousedown="startLongPress('secret')" onmouseup="hideTooltips()" onmouseleave="hideTooltips()"
                     onmouseenter="showSecretStonesTooltip()" onmouseleave="hideTooltips()">
                    <div class="text-2xl mb-1">‚ùì</div>
                    <div class="text-sm font-bold">?</div>
                </div>
                <div class="font-bold">ÎπÑÎ∞Ä Ï£ºÎ¨∏</div>
                <div id="secret-stones-count" class="text-lg"></div>
                
                <!-- ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÎßêÌíçÏÑ† ÌåùÏóÖ -->
                <div id="secret-stones-tooltip" class="absolute right-0 top-0 transform translate-x-full ml-12 bg-white border border-gray-200 rounded-lg p-3 shadow-lg hidden z-[60] min-w-[280px] max-w-[380px]">
                    <div class="text-center font-bold mb-3 text-sm text-gray-800 border-b border-gray-200 pb-2">ÎπÑÎ∞Ä Ï£ºÎ¨∏ Î™©Î°ù</div>
                    
                    <!-- ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ -->
                    <div id="personal-revealed-section" class="mb-3 hidden">
                        <div class="text-xs font-bold text-blue-600 mb-2 flex items-center">
                            <span class="mr-1">üëÅÔ∏è</span>
                            <span>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú</span>
                            <span class="ml-auto text-xs text-blue-500">(${state.personalRevealedStones ? state.personalRevealedStones.length : 0}Í∞ú)</span>
                        </div>
                        <div id="personal-revealed-list" class="text-xs text-blue-700 space-y-1 bg-blue-50 p-2 rounded"></div>
                    </div>
                    
                    <!-- ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ -->
                    <div id="opponent-personal-revealed-section" class="mb-3 hidden">
                        <div class="text-xs font-bold text-orange-600 mb-2 flex items-center">
                            <span class="mr-1">üë§</span>
                            <span>ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞ú</span>
                            <span class="ml-auto text-xs text-orange-500">(${state.opponentPersonalRevealedStones ? state.opponentPersonalRevealedStones.length : 0}Í∞ú)</span>
                        </div>
                        <div id="opponent-personal-revealed-list" class="text-xs text-orange-700 space-y-1 bg-orange-50 p-2 rounded"></div>
                    </div>
                    
                    <!-- Ï†ÑÏ≤¥ Í≥µÍ∞úÎêú Ï£ºÎ¨∏ -->
                    <div id="publicly-revealed-section" class="mb-3 hidden">
                        <div class="text-xs font-bold text-green-600 mb-2 flex items-center">
                            <span class="mr-1">üåê</span>
                            <span>Ï†ÑÏ≤¥ Í≥µÍ∞ú</span>
                            <span class="ml-auto text-xs text-green-500">(${state.publiclyRevealedSecretStones ? state.publiclyRevealedSecretStones.length : 0}Í∞ú)</span>
                        </div>
                        <div id="publicly-revealed-list" class="text-xs text-green-700 space-y-1 bg-green-50 p-2 rounded"></div>
                    </div>
                    
                    <!-- ÎπÑÎ∞Ä Ï£ºÎ¨∏ -->
                    <div id="secret-stones-section">
                        <div class="text-xs font-bold text-gray-600 mb-2 flex items-center">
                            <span class="mr-1">üîí</span>
                            <span>ÎπÑÎ∞Ä Ï£ºÎ¨∏</span>
                            <span class="ml-auto text-xs text-gray-500">(${state.secretStones ? state.secretStones.length : 0}Í∞ú)</span>
                        </div>
                        <div id="secret-stones-list" class="text-xs text-gray-700 space-y-1 bg-gray-50 p-2 rounded"></div>
                    </div>
                </div>
            </div>
            <div class="flex-grow mx-4">
                <div id="game-log" class="game-log p-2 rounded-lg overflow-y-auto flex flex-col-reverse relative z-0"></div>
            </div>
            <div id="used-stones-pile" class="flex flex-col items-center space-y-1 card-pile relative z-20">
                <div class="card card-back flex flex-col items-center justify-center"
                     ontouchstart="startLongPress('used')" ontouchend="hideTooltips()" 
                     onmousedown="startLongPress('used')" onmouseup="hideTooltips()" onmouseleave="hideTooltips()"
                     onmouseenter="showUsedStonesTooltip()" onmouseleave="hideTooltips()">
                    <div class="text-2xl mb-1">üóëÔ∏è</div>
                    <div class="text-sm font-bold">X</div>
                </div>
                <div class="font-bold">ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏</div>
                <div id="used-stones-count" class="text-lg"></div>
                
                <!-- ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏ ÎßêÌíçÏÑ† ÌåùÏóÖ -->
                <div id="used-stones-tooltip" class="absolute left-0 top-0 transform -translate-x-full mr-12 bg-white border border-gray-200 rounded-lg p-3 shadow-lg hidden z-[60] min-w-[200px] max-w-[300px]">
                    <div class="text-center font-bold mb-2 text-sm text-gray-800">ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏ Î™©Î°ù</div>
                    <div id="used-stones-list" class="text-xs text-gray-700 space-y-1"></div>
                </div>
            </div>
        </div>

        <!-- ÎÇ¥ ÏòÅÏó≠ (Ìï≠ÏÉÅ ÌïòÎã®) -->
        <div id="my-area" class="p-4 border-2 border-blue-400 rounded-lg transition-all duration-500 relative">
            <div id="my-hand" class="flex justify-center space-x-2 mb-4"></div>
            <div class="flex justify-between items-center">
                <div id="my-health" class="flex items-center space-x-1 text-2xl"></div>
                <h2 id="my-title" class="text-xl font-bold text-blue-300">ÎÇò</h2>
            </div>
            <div id="my-turn-indicator" class="turn-indicator hidden">ÎÇ¥ ÌÑ¥!</div>
        </div>

        <!-- Ïª®Ìä∏Î°§ ÏòÅÏó≠ -->
        <div class="p-4 bg-black bg-opacity-20 rounded-lg">
            <div id="spell-buttons" class="relative mb-4">
                <!-- Í≤åÏù¥ÏßÄÎ∞î Î∞∞Í≤Ω -->
                <div class="absolute inset-0 bg-gray-800 bg-opacity-30 rounded-lg border border-gray-600"></div>
                
                <!-- Í≤åÏù¥ÏßÄÎ∞î -->
                <div id="turn-gauge" class="absolute inset-0 rounded-lg overflow-hidden">
                    <div id="blue-gauge" class="absolute left-0 top-0 h-full bg-blue-500 bg-opacity-30 transition-all duration-50 ease-out" style="width: 0%"></div>
                    <div id="red-gauge" class="absolute right-0 top-0 h-full bg-red-500 bg-opacity-30 transition-all duration-50 ease-out" style="width: 0%"></div>
                </div>
                
                <!-- ÏòÅÏ∞Ω Î≤ÑÌäºÎì§ -->
                <div id="spell-buttons-container" class="relative grid grid-cols-6 gap-2 p-4"></div>
            </div>
            <div id="memo-buttons" class="grid grid-cols-6 gap-2 mb-4"></div>
            <button id="end-turn-btn" class="w-full py-3 rounded-lg font-bold text-lg btn-primary">ÌÑ¥ Ï¢ÖÎ£å</button>
        </div>
        
        <!-- ÌïòÎã® Î≤ÑÌäº ÏòÅÏó≠ -->
        <div class="flex justify-between items-center p-2">
            <button id="surrender-btn" class="px-6 py-2 rounded-lg font-bold btn-secondary text-sm whitespace-nowrap">ÎèÑÎßù</button>
            
            <div class="relative">
                <button id="help-btn" class="px-6 py-2 rounded-lg font-bold btn-secondary text-sm whitespace-nowrap min-w-[100px]" 
                        onmousedown="showHelpTooltip()" onmouseup="hideHelpTooltip()" onmouseleave="hideHelpTooltip()"
                        ontouchstart="showHelpTooltip()" ontouchend="hideHelpTooltip()">üìù Í≤åÏûÑ Í∑úÏπô</button>
                <div id="help-tooltip" class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 p-4 bg-white border border-gray-200 rounded-lg text-sm w-80 hidden z-50 shadow-lg">
                    <div class="text-center font-bold mb-3 text-base text-gray-800">Í≤åÏûÑ Í∑úÏπô</div>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                        <li>ÏÉÅÎåÄÏùò ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ Î≥¥Í≥†, Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÏûêÏã†Ïùò Ï£ºÎ¨∏ÏùÑ Ï∂îÏ∏°Ìï¥ ÏòÅÏ∞ΩÌïòÏÑ∏Ïöî.</li>
                        <li>ÏòÅÏ∞ΩÏóê ÏÑ±Í≥µÌïòÎ©¥ Ï∂îÍ∞ÄÎ°ú Í∞ôÍ±∞ÎÇò, Îçî ÎÜíÏùÄ Ïà´ÏûêÏùò ÏòÅÏ∞ΩÏùÑ ÏãúÏ†ÑÌï† Ïàò ÏûàÏäµÎãàÎã§.</li>
                        <li>ÏòÅÏ∞ΩÏóê Ïã§Ìå®ÌïòÎ©¥ Ï≤¥Î†•Ïù¥ 1 Í∞êÏÜåÌïòÍ≥† ÌÑ¥Ïù¥ Ï¢ÖÎ£åÎê©ÎãàÎã§.</li>
                        <li>ÏÉÅÎåÄÏùò Ï≤¥Î†•ÏùÑ 0ÏúºÎ°ú ÎßåÎì§Í±∞ÎÇò, ÎÇ¥ ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ Î™®Îëê ÏÇ¨Ïö©ÌïòÎ©¥ ÏäπÎ¶¨Ìï©ÎãàÎã§!</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê (Í∞úÎ∞úÏûêÏö©) -->
        <div id="debug-panel" class="p-4 bg-red-900 bg-opacity-20 rounded-lg border border-red-400 hidden">
            <h3 class="text-lg font-bold text-red-300 mb-2">üîß ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                <button id="debug-show-state" class="px-2 py-1 bg-blue-600 rounded text-white">Í≤åÏûÑ ÏÉÅÌÉú Ï∂úÎ†•</button>
                <button id="debug-show-player-hand" class="px-2 py-1 bg-green-600 rounded text-white">ÌîåÎ†àÏù¥Ïñ¥ ÏÜêÌå® Î≥¥Í∏∞</button>
                <button id="debug-show-ai-hand" class="px-2 py-1 bg-yellow-600 rounded text-white">AI ÏÜêÌå® Î≥¥Í∏∞</button>
                <button id="debug-reset-game" class="px-2 py-1 bg-red-600 rounded text-white">Í≤åÏûÑ Î¶¨ÏÖã</button>
                <button id="debug-player-win" class="px-2 py-1 bg-purple-600 rounded text-white">ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨</button>
                <button id="debug-ai-win" class="px-2 py-1 bg-orange-600 rounded text-white">AI ÏäπÎ¶¨</button>
                <button id="debug-add-player-health" class="px-2 py-1 bg-green-600 rounded text-white">ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†• +1</button>
                <button id="debug-add-ai-health" class="px-2 py-1 bg-yellow-600 rounded text-white">AI Ï≤¥Î†• +1</button>
            </div>
            <div id="debug-info" class="mt-2 p-2 bg-black bg-opacity-30 rounded text-xs font-mono"></div>
        </div>
    </div>

    <!-- Î™®Îã¨ -->
    <div id="modal" class="fixed inset-0 items-center justify-center hidden modal-bg z-50">
        <div class="modal-content p-8 rounded-lg text-center max-w-lg w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <div id="modal-body" class="mb-6"></div>
            <button id="modal-close-btn" class="px-6 py-2 rounded-lg btn-primary">ÌôïÏù∏</button>
        </div>
    </div>
    
    <!-- ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden">
        <span id="toast-message"></span>
    </div>
    
    <!-- Îß§Ïπ≠ Î™®Îã¨ -->
    <div id="matching-modal" class="fixed inset-0 flex items-center justify-center hidden modal-bg z-50">
        <div class="modal-content p-8 rounded-lg text-center max-w-md w-full mx-4">
            <div class="text-4xl mb-4">üîç</div>
                            <h3 class="text-xl font-bold mb-4">Í≤∞Ìà¨ ÏÉÅÎåÄÎ•º Îß§Ïπ≠ Ï§ëÏûÖÎãàÎã§</h3>
            <div class="flex justify-center space-x-2 mb-6">
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-sm text-gray-300 mb-4" id="matching-message">ÏÉÅÎåÄÎ∞©ÏùÑ Ï∞æÎäî Ï§ëÏûÖÎãàÎã§...</p>
            <p class="text-xs text-gray-400 mb-4">ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
            <button id="cancel-matching-btn" class="px-6 py-2 rounded-lg btn-primary">Îß§Ïπ≠ Ï∑®ÏÜå</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // ÏÇ¨Ïö¥Îìú Ìö®Í≥º (Web Audio API ÏÇ¨Ïö©)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // AudioContext ÌôúÏÑ±Ìôî Ìï®Ïàò
        function activateAudioContext() {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('üîä AudioContext ÌôúÏÑ±Ìôî ÏôÑÎ£å');
                }).catch(err => {
                    console.error('‚ùå AudioContext ÌôúÏÑ±Ìôî Ïã§Ìå®:', err);
                });
            }
        }
        
        // ÏÇ¨Ïö¥Îìú ÏÑ§Ï†ï Í∞ùÏ≤¥
        const SOUNDS = {
            card: { freq: 150, dur: 0.1, type: 'square', sequence: [[200, 0.1, 'square', 50]] },
            success: { freq: 523.25, dur: 0.2, type: 'sine', sequence: [
                [659.25, 0.2, 'sine', 100], [783.99, 0.3, 'sine', 200]
            ]},
            failure: { freq: 220, dur: 0.3, type: 'sawtooth', sequence: [
                [196, 0.3, 'sawtooth', 150]
            ]},
            damage: { freq: 100, dur: 0.2, type: 'square', sequence: [
                [80, 0.2, 'square', 100], [60, 0.3, 'square', 200]
            ]},
            heal: { freq: 660, dur: 0.2, type: 'triangle', sequence: [
                [880, 0.2, 'triangle', 100], [1108.73, 0.3, 'triangle', 200]
            ]},
            gameStart: { freq: 523.25, dur: 0.15, type: 'sine', sequence: [
                [659.25, 0.15, 'sine', 50], [783.99, 0.2, 'sine', 150], [1046.50, 0.3, 'sine', 300], [1318.51, 0.4, 'sine', 500]
            ]},
            gameWin: { freq: 523.25, dur: 0.3, type: 'sine', sequence: [
                [659.25, 0.3, 'sine', 200], [783.99, 0.3, 'sine', 400], [1046.50, 0.4, 'sine', 600]
            ]},
            gameLose: { freq: 220, dur: 0.4, type: 'sawtooth', sequence: [
                [196, 0.4, 'sawtooth', 300], [174.61, 0.5, 'sawtooth', 600]
            ]}
        };
        
        function playSound(frequency, duration, type = 'sine') {
            // AudioContextÍ∞Ä ÏùºÏãú Ï§ëÎã® ÏÉÅÌÉúÎ©¥ ÌôúÏÑ±Ìôî ÏãúÎèÑ
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('üîä AudioContext ÌôúÏÑ±ÌôîÎê® - ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù');
                    playSoundInternal(frequency, duration, type);
                }).catch(err => {
                    console.error('‚ùå AudioContext ÌôúÏÑ±Ìôî Ïã§Ìå®:', err);
                });
            } else {
                playSoundInternal(frequency, duration, type);
            }
        }
        
        function playSoundInternal(frequency, duration, type = 'sine') {
            try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
                
                console.log(`üîä ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù: ${frequency}Hz, ${duration}s, ${type}`);
            } catch (error) {
                console.error('‚ùå ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ïã§Ìå®:', error);
            }
        }
        
        function playSoundEffect(type) {
            console.log(`üéµ Ìö®Í≥ºÏùå Ïû¨ÏÉù ÏãúÎèÑ: ${type}`);
            const sound = SOUNDS[type];
            if (!sound) {
                console.error(`‚ùå Ïïå Ïàò ÏóÜÎäî Ìö®Í≥ºÏùå ÌÉÄÏûÖ: ${type}`);
                return;
            }
            
            console.log(`üéµ Ìö®Í≥ºÏùå Ï†ïÎ≥¥:`, sound);
            playSound(sound.freq, sound.dur, sound.type);
            
            // ÏãúÌÄÄÏä§ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù
            sound.sequence?.forEach(([freq, dur, type, delay], index) => {
                console.log(`üéµ ÏãúÌÄÄÏä§ ${index + 1}: ${freq}Hz, ${dur}s, ${type}, ${delay}ms ÌõÑ`);
                setTimeout(() => playSound(freq, dur, type), delay);
            });
        }
        
        // Í∏∞Ï°¥ Ìï®ÏàòÎ™Ö Ìò∏ÌôòÏÑ± Ïú†ÏßÄ
        const playCardSound = () => playSoundEffect('card');
        const playSuccessSound = () => playSoundEffect('success');
        const playFailureSound = () => playSoundEffect('failure');
        const playDamageSound = () => playSoundEffect('damage');
        const playHealSound = () => playSoundEffect('heal');
        const playGameStartSound = () => playSoundEffect('gameStart');
        const playGameOverSound = (isWin) => playSoundEffect(isWin ? 'gameWin' : 'gameLose');

        /**
         * DOM ÏöîÏÜå Ï∫êÏãú Î∞è Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú
         * ÏÑ±Îä• Ìñ•ÏÉÅÍ≥º ÏΩîÎìú Í∞ÄÎèÖÏÑ±ÏùÑ ÏúÑÌïú DOM Ï†ëÍ∑º ÏµúÏ†ÅÌôî
         */
        const DOM = {
            elements: {},
            
            /**
             * DOM ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∫êÏãú ÌôúÏö©)
             * @param {string} id - ÏöîÏÜå ID
             * @returns {HTMLElement|null} DOM ÏöîÏÜå
             */
            get(id) {
                if (!this.elements[id]) {
                    this.elements[id] = document.getElementById(id);
                }
                return this.elements[id];
            },
            
            /**
             * Ïó¨Îü¨ DOM ÏöîÏÜåÎ•º Ìïú Î≤àÏóê Í∞ÄÏ†∏Ïò§Í∏∞
             * @param {string[]} ids - ÏöîÏÜå ID Î∞∞Ïó¥
             * @returns {Object} IDÎ≥Ñ DOM ÏöîÏÜå Í∞ùÏ≤¥
             */
            getMultiple(ids) {
                const elements = {};
                ids.forEach(id => {
                    elements[id] = this.get(id);
                });
                return elements;
            },
            
            /**
             * ÏûêÏ£º ÏÇ¨Ïö©ÎêòÎäî ÏöîÏÜåÎì§ ÎØ∏Î¶¨ Ï∫êÏãú
             * ÏÑ±Îä• Ìñ•ÏÉÅÏùÑ ÏúÑÌïú Ï¥àÍ∏∞Ìôî
             */
            init() {
                const commonElements = [
                    'title-screen', 'game-screen', 'start-game-btn',
                    'my-area', 'opponent-area', 'my-health', 'opponent-health',
                    'my-hand', 'opponent-hand', 'secret-stones-pile', 'used-stones-pile',
                    'secret-stones-count', 'used-stones-count', 'game-log',
                    'spell-buttons-container', 'end-turn-btn', 'modal',
                    'modal-title', 'modal-body', 'modal-close-btn',
                    'debug-panel', 'debug-info', 'memo-buttons', 'my-title',
                    'help-tooltip', 'matching-modal', 'matching-message',
                    'ai-difficulty-modal', 'toast', 'toast-message',
                    'player-name-input', 'save-name-btn', 'name-save-status',
                    'my-turn-indicator', 'opponent-turn-indicator',
                    'ai-trophy-count', 'multiplayer-trophy-count'
                ];
                
                commonElements.forEach(id => this.get(id));
                // DOM Ï∫êÏãú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å
            }
        };

        // DOM ÏöîÏÜå (Í∏∞Ï°¥ Î≥ÄÏàòÎ™Ö Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
        const titleScreen = DOM.get('title-screen');
        const gameScreen = DOM.get('game-screen');
        const startGameBtn = DOM.get('start-game-btn');
        const myArea = DOM.get('my-area');
        const opponentArea = DOM.get('opponent-area');
        const myHealthEl = DOM.get('my-health');
        const opponentHealthEl = DOM.get('opponent-health');
        const myHandEl = DOM.get('my-hand');
        const opponentHandEl = DOM.get('opponent-hand');
        const secretStonesPile = DOM.get('secret-stones-pile');
        const usedStonesPile = DOM.get('used-stones-pile');
        const secretStonesCountEl = DOM.get('secret-stones-count');
        const usedStonesCountEl = DOM.get('used-stones-count');
        const gameLogEl = DOM.get('game-log');
        const spellButtonsContainer = DOM.get('spell-buttons-container');
        const endTurnBtn = DOM.get('end-turn-btn');
        const modal = DOM.get('modal');
        const modalTitle = DOM.get('modal-title');
        const modalBody = DOM.get('modal-body');
        const modalCloseBtn = DOM.get('modal-close-btn');
        
        // ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÏöîÏÜåÎì§
        const debugPanel = DOM.get('debug-panel');
        const debugInfo = DOM.get('debug-info');



        /**
         * Í≤åÏûÑ ÏÉÅÌÉú Í¥ÄÎ¶¨
         */
        let state = {};
        let previousMyHealth = 4; // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
        let previousOpponentHealth = 4; // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
        
        // ÌÑ¥ ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® Î≥ÄÏàò
        let turnTimer = null;
        let turnTimeLeft = 30; // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
        let TURN_DURATION = 30; // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
        
        // Ïó∞Ïäπ Í¥ÄÎ†® Î≥ÄÏàò
        let currentWinStreak = parseInt(localStorage.getItem('currentWinStreak')) || 0;
        let maxWinStreak = parseInt(localStorage.getItem('maxWinStreak')) || 0;
        
        // Ï£ºÎ¨∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉú
        let spellButtonsDisabled = false;
        
        // Ï£ºÎ¨∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Ìï®Ïàò
        function disableSpellButtons() {
            spellButtonsDisabled = true;
            const spellButtons = spellButtonsContainer.querySelectorAll('button');
            spellButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            // Ï£ºÎ¨∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÎê®
        }
        
        // Ï£ºÎ¨∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî Ìï®Ïàò
        function enableSpellButtons() {
            spellButtonsDisabled = false;
            const spellButtons = spellButtonsContainer.querySelectorAll('button');
            spellButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            // Ï£ºÎ¨∏ Î≤ÑÌäº ÌôúÏÑ±ÌôîÎê®
        }
        
        // ÎîîÎ≤ÑÍ∑∏: Î≥ÄÏàò Ï¥àÍ∏∞Ìôî ÌôïÏù∏
        // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî ÏôÑÎ£å

        /**
         * Í≤åÏûÑ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî Ìï®Ïàò
         * GAME_CONFIGÍ∞Ä Ï†ïÏùòÎêú ÌõÑ Ìò∏Ï∂úÎêòÏñ¥Ïïº Ìï®
         */
        function initializeGameConfig() {
            if (typeof GAME_CONFIG !== 'undefined') {
                previousMyHealth = GAME_CONFIG.maxHealth;
                previousOpponentHealth = GAME_CONFIG.maxHealth;
                turnTimeLeft = GAME_CONFIG.turnDuration.normal;
                TURN_DURATION = GAME_CONFIG.turnDuration.normal;
            }
        }

        // AI ÎÇúÏù¥ÎèÑÎ≥Ñ ÏãúÍ∞Ñ Ï†úÌïú ÏÑ§Ï†ï
        function setTurnDurationByDifficulty() {
            if (multiplayerMode) {
                TURN_DURATION = GAME_CONFIG.turnDuration.multiplayer;
            } else {
                TURN_DURATION = GAME_CONFIG.turnDuration[aiDifficulty] || GAME_CONFIG.turnDuration.normal;
            }
            console.log(`‚è∞ AI ÎÇúÏù¥ÎèÑ: ${aiDifficulty}, ÏãúÍ∞Ñ Ï†úÌïú: ${TURN_DURATION === Infinity ? 'Î¨¥Ï†úÌïú' : TURN_DURATION + 'Ï¥à'}`);
        }

        // ÌÑ¥ ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function startTurnTimer() {
            if (turnTimer) {
                clearInterval(turnTimer);
            }
            
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ ÌÉÄÏù¥Î®∏ ÏãúÏûë Ï§ëÎã®
            if (!state || !state.players || state.players.length < 2) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ ÌÉÄÏù¥Î®∏ ÏãúÏûëÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            // AI ÎÇúÏù¥ÎèÑÎ≥Ñ ÏãúÍ∞Ñ Ï†úÌïú ÏÑ§Ï†ï
            setTurnDurationByDifficulty();
            console.log(`‚è∞ ÏãúÍ∞Ñ Ï†úÌïú ÏÑ§Ï†ï ÏôÑÎ£å - TURN_DURATION: ${TURN_DURATION}Ï¥à`);
            
            // ÏãúÍ∞Ñ Ï†úÌïúÏù¥ ÏóÜÏúºÎ©¥ ÌÉÄÏù¥Î®∏Î•º ÏãúÏûëÌïòÏßÄ ÏïäÏùå
            if (TURN_DURATION === Infinity) {
                console.log('‚è∞ ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏùå - ÌÉÄÏù¥Î®∏ ÎπÑÌôúÏÑ±Ìôî');
                updateTurnGauge(); // Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞ÌôîÎßå
                return;
            }
            
            turnTimeLeft = TURN_DURATION;
            
            // Ï≤´ ÌÑ¥ ÏãúÏûë Ïãú Í≤åÏù¥ÏßÄÎ•º Ï¶âÏãú ÌëúÏãú
            updateTurnGauge();
            
            console.log(`‚è∞ ÌÉÄÏù¥Î®∏ ÏãúÏûë - ÌòÑÏû¨ÌîåÎ†àÏù¥Ïñ¥: ${state.currentPlayerId}, ÎÇ¥ÌÑ¥: ${state.isPlayerTurn}, Ï†úÌïúÏãúÍ∞Ñ: ${TURN_DURATION}Ï¥à, ÎÇ®ÏùÄÏãúÍ∞Ñ: ${turnTimeLeft}Ï¥à`);
            
            // Îçî Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥ 100msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
            turnTimer = setInterval(() => {
                turnTimeLeft -= 0.1; // 0.1Ï¥àÏî© Í∞êÏÜå
                updateTurnGauge();
                
                if (turnTimeLeft <= 0) {
                    clearInterval(turnTimer);
                    turnTimer = null;
                    console.log('‚è∞ ÌÑ¥ ÏãúÍ∞Ñ Ï¥àÍ≥º! ÏûêÎèô ÌÑ¥ Ï¢ÖÎ£å');
                    addLog(Messages.timeOut());
                    endTurn();
                }
            }, 100); // 100msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
        }
        
        function stopTurnTimer() {
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
        }
        
        function resetTurnTimer() {
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
            turnTimeLeft = TURN_DURATION;
            updateTurnGauge();
            console.log('‚è∞ ÌÉÄÏù¥Î®∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            
            // ÏÉàÎ°úÏö¥ ÌÉÄÏù¥Î®∏ ÏãúÏûë
            if (TURN_DURATION !== Infinity) {
                turnTimer = setInterval(() => {
                    turnTimeLeft -= 0.1; // 0.1Ï¥àÏî© Í∞êÏÜå
                    updateTurnGauge();
                    
                    if (turnTimeLeft <= 0) {
                        clearInterval(turnTimer);
                        turnTimer = null;
                        console.log('‚è∞ ÌÑ¥ ÏãúÍ∞Ñ Ï¥àÍ≥º! ÏûêÎèô ÌÑ¥ Ï¢ÖÎ£å');
                        addLog(Messages.timeOut());
                        endTurn();
                    }
                }, 100); // 100msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
            }
        }
        
        function resetTurnGauge() {
            const blueGauge = DOM.get('blue-gauge');
            const redGauge = DOM.get('red-gauge');
            
            if (blueGauge && redGauge) {
                blueGauge.style.width = '0%';
                redGauge.style.width = '0%';
                console.log('üîÑ Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
        }
        
        function updateTurnGauge() {
            const blueGauge = DOM.get('blue-gauge');
            const redGauge = DOM.get('red-gauge');
            
            if (!blueGauge || !redGauge) return;
            
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞ÌôîÎßå
            if (!state || !state.players || state.players.length < 2) {
                blueGauge.style.width = '0%';
                redGauge.style.width = '0%';
                return;
            }
            
            // ÏãúÍ∞Ñ Ï†úÌïúÏù¥ ÏóÜÏúºÎ©¥ Í≤åÏù¥ÏßÄÎ•º ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            if (TURN_DURATION === Infinity) {
                blueGauge.style.width = '0%';
                redGauge.style.width = '0%';
                return;
            }
            
            // Ï≤´ ÌÑ¥ ÏãúÏûë ÏãúÏóêÎèÑ Í≤åÏù¥ÏßÄÍ∞Ä ÌëúÏãúÎêòÎèÑÎ°ù ÏàòÏ†ï
            let progress;
            if (turnTimeLeft === TURN_DURATION) {
                // Ï≤´ ÌÑ¥ ÏãúÏûë Ïãú - Í≤åÏù¥ÏßÄÍ∞Ä 0%ÏóêÏÑú ÏãúÏûëÌïòÎèÑÎ°ù
                progress = 0;
            } else {
                progress = turnTimeLeft >= 0 ? (TURN_DURATION - turnTimeLeft) / TURN_DURATION : 0;
            }
            const gaugeWidth = Math.min(progress * 100, 100);
            
            // ÎîîÎ≤ÑÍ∑∏: Í≤åÏù¥ÏßÄ Í≥ÑÏÇ∞ Î°úÍ∑∏ (Ï≤´ ÌÑ¥ ÏãúÏûë ÏãúÏóêÎßå)
            if (turnTimeLeft === TURN_DURATION) {
                console.log(`üéØ Ï≤´ ÌÑ¥ Í≤åÏù¥ÏßÄ Í≥ÑÏÇ∞ - TURN_DURATION: ${TURN_DURATION}, turnTimeLeft: ${turnTimeLeft}, progress: ${progress}, gaugeWidth: ${gaugeWidth}%`);
            }
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú ÎÇ¥ ÌÑ¥Ïù∏ÏßÄ ÌôïÏù∏
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            const isMyTurn = (state.currentPlayerId === myPlayerId);
            
            // AI Î™®ÎìúÏóêÏÑúÎäî ÌîåÎ†àÏù¥Ïñ¥ 1Ïù¥ Ìï≠ÏÉÅ ÎÇ¥ ÌÑ¥
            if (multiplayerMode) {
                if (isMyTurn) {
                    // ÎÇ¥ ÌÑ¥ - ÌååÎûÄÏÉâ Í≤åÏù¥ÏßÄ (ÏôºÏ™ΩÎ∂ÄÌÑ∞)
                    blueGauge.style.width = `${gaugeWidth}%`;
                    redGauge.style.width = '0%';
                } else {
                    // ÏÉÅÎåÄ ÌÑ¥ - Îπ®Í∞ÑÏÉâ Í≤åÏù¥ÏßÄ (Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞)
                    blueGauge.style.width = '0%';
                    redGauge.style.width = `${gaugeWidth}%`;
                }
            } else {
                // AI Î™®Îìú
                if (state.currentPlayerId === 1) {
                    // ÎÇ¥ ÌÑ¥ - ÌååÎûÄÏÉâ Í≤åÏù¥ÏßÄ (ÏôºÏ™ΩÎ∂ÄÌÑ∞)
                    blueGauge.style.width = `${gaugeWidth}%`;
                    redGauge.style.width = '0%';
                } else {
                    // AI ÌÑ¥ - Îπ®Í∞ÑÏÉâ Í≤åÏù¥ÏßÄ (Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞)
                    blueGauge.style.width = '0%';
                    redGauge.style.width = `${gaugeWidth}%`;
                }
            }
        }
        
        // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞± Ìï®ÏàòÎì§
        function showDamageEffect(element, amount) {
            const damageEl = document.createElement('div');
            damageEl.className = 'card-damage';
            damageEl.textContent = `-${amount}`;
            element.appendChild(damageEl);
            
            setTimeout(() => {
                element.removeChild(damageEl);
            }, 1000);
        }
        
        // ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ± Ìï®Ïàò
        function createSpellParticles(spellNumber, element) {
            const spellIcon = getSpellIcon(spellNumber);
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // ÌååÌã∞ÌÅ¥ Í∞úÏàò (8-12Í∞ú)
            const particleCount = Math.floor(Math.random() * 5) + 8;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = spellIcon;
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                // ÎûúÎç§ Î∞©Ìñ•Í≥º Í±∞Î¶¨
                const angle = (Math.PI * 2 * i) / particleCount + (Math.random() - 0.5) * 0.5;
                const distance = 80 + Math.random() * 40;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                particle.style.setProperty('--x', x + 'px');
                particle.style.setProperty('--y', y + 'px');
                
                // ÎûúÎç§ ÏÉâÏÉÅ Î≥ÄÌôî
                const hue = Math.random() * 60 + 30; // ÎÖ∏ÎûÄÏÉâ-Ï£ºÌô©ÏÉâ Î≤îÏúÑ
                particle.style.filter = `hue-rotate(${hue}deg) brightness(1.2)`;
                
                document.body.appendChild(particle);
                
                // ÌååÌã∞ÌÅ¥ Ï†úÍ±∞
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1000);
            }
            
            console.log(`üéÜ ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ±: ${spellIcon} (${particleCount}Í∞ú)`);
        }
        
        // ÌôîÎ©¥ Ï†ÑÏ≤¥Ïóê ÎûúÎç§ ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ± Ìï®Ïàò
        function createModalParticles(spellNumber) {
            const spellIcon = getSpellIcon(spellNumber);
            
            // ÌôîÎ©¥ ÌÅ¨Í∏∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïä§ÌÅ¨Î°§Î∞î Í≥†Î†§)
            const screenWidth = window.innerWidth || document.documentElement.clientWidth;
            const screenHeight = window.innerHeight || document.documentElement.clientHeight;
            
            // ÌååÌã∞ÌÅ¥ Í∞úÏàò (15-20Í∞úÎ°ú Ï¶ùÍ∞Ä)
            const particleCount = Math.floor(Math.random() * 6) + 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = spellIcon;
                
                // ÌôîÎ©¥ Ï†ÑÏ≤¥ÏóêÏÑú ÎûúÎç§Ìïú ÏãúÏûë ÏúÑÏπò (ÏïàÏ†ÑÌïú Î≤îÏúÑ ÎÇ¥ÏóêÏÑú)
                const safeMargin = 50; // ÌôîÎ©¥ Í∞ÄÏû•ÏûêÎ¶¨ÏóêÏÑú 50px Ïó¨Ïú† Í≥µÍ∞Ñ
                const startX = safeMargin + Math.random() * (screenWidth - 2 * safeMargin);
                const startY = safeMargin + Math.random() * (screenHeight - 2 * safeMargin);
                
                particle.style.left = startX + 'px';
                particle.style.top = startY + 'px';
                particle.style.zIndex = '9999'; // ÏµúÏÉÅÏúÑ Î†àÏù¥Ïñ¥
                
                // ÎûúÎç§Ìïú Î∞©Ìñ•ÏúºÎ°ú ÌÑ∞ÏßÄÎèÑÎ°ù ÏÑ§Ï†ï
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 150; // Îã§ÏñëÌïú Í±∞Î¶¨Î°ú ÌÑ∞Ïßê
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                particle.style.setProperty('--x', x + 'px');
                particle.style.setProperty('--y', y + 'px');
                
                // ÏõêÎûò ÏïÑÏù¥ÏΩò ÏÉâÏÉÅÍ≥º Î∞ùÍ∏∞ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                // ÎûúÎç§Ìïú ÌÅ¨Í∏∞ Î≥ÄÌôî
                const scale = 0.8 + Math.random() * 0.4;
                particle.style.fontSize = (1.5 * scale) + 'rem';
                
                document.body.appendChild(particle);
                
                // ÌååÌã∞ÌÅ¥ Ï†úÍ±∞ (ÏãúÍ∞ÑÏùÑ 2Ï¥àÎ°ú Ïó∞Ïû•)
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2000);
            }
            
            console.log(`üéÜ ÌôîÎ©¥ Ï†ÑÏ≤¥ ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ±: ${spellIcon} (${particleCount}Í∞ú)`);
        }
        
        function showHealEffect(element, amount) {
            const healEl = document.createElement('div');
            healEl.className = 'card-heal';
            healEl.textContent = `+${amount}`;
            element.appendChild(healEl);
            
            setTimeout(() => {
                element.removeChild(healEl);
            }, 1000);
        }
        
        function addSuccessAnimation(element) {
            element.classList.add('success-animation');
            setTimeout(() => {
                element.classList.remove('success-animation');
            }, 500);
        }
        
        function addFailureAnimation(element) {
            element.classList.add('failure-animation');
            setTimeout(() => {
                element.classList.remove('failure-animation');
            }, 500);
        }





        // ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÌÜ†Í∏Ä (Ctrl+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                debugPanel.classList.toggle('hidden');
                console.log('üîß ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÌÜ†Í∏ÄÎê®');
            }
        });

        // ÏπòÌä∏: Î™®Îì† ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (Ctrl+Alt+P)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && e.key === 'p') {
                e.preventDefault();
                if (confirm('Ï†ïÎßê Î™®Îì† ÏÑúÎ≤ÑÏùò Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    console.log('üßπ ÏπòÌä∏: Î™®Îì† ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏöîÏ≤≠');
                    if (socket) {
                        socket.emit('resetAllServerData');
                    }
                }
            }
        });

        // ÎûúÎç§ Ïù¥Î¶Ñ ÏÉùÏÑ± Ìï®Ïàò
        function generateRandomName() {
            const alphabetChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numericChars = '0123456789';
            let randomName = '';
            
            // ÏïåÌååÎ≤≥ 3Í∞ú ÏÉùÏÑ±
            for (let charIndex = 0; charIndex < 3; charIndex++) {
                randomName += alphabetChars.charAt(Math.floor(Math.random() * alphabetChars.length));
            }
            
            // Ïà´Ïûê 3Í∞ú ÏÉùÏÑ±
            for (let charIndex = 0; charIndex < 3; charIndex++) {
                randomName += numericChars.charAt(Math.floor(Math.random() * numericChars.length));
            }
            
            return randomName;
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Î≥∏ Ïù¥Î¶Ñ ÏÑ§Ï†ï
        function initializePlayerName() {
            let playerName = localStorage.getItem('playerName');
            
            // Ïù¥Î¶ÑÏù¥ ÏóÜÏúºÎ©¥ ÎûúÎç§ Ïù¥Î¶Ñ ÏÉùÏÑ±
            if (!playerName) {
                playerName = generateRandomName();
                localStorage.setItem('playerName', playerName);
                console.log(`üé≤ ÎûúÎç§ Ïù¥Î¶Ñ ÏÉùÏÑ±: ${playerName}`);
            }
            
            return playerName;
        }

        // ÏπòÌä∏: ÏûêÏã†Ïùò Îç∞Ïù¥ÌÑ∞Îßå Ï¥àÍ∏∞Ìôî (Ctrl+P)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && !e.shiftKey && e.key === 'p') {
                e.preventDefault();
                const playerName = localStorage.getItem('playerName') || 'Player';
                if (confirm('Ï†ïÎßê Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    console.log('üßπ ÏπòÌä∏: Í∞úÏù∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏöîÏ≤≠');
                    if (socket) {
                        socket.emit('resetMyData', { playerName: playerName });
                    }
                }
            }
        });
        
        // Î©îÎ™® Ìå®ÎÑê ÌÜ†Í∏Ä (M ÌÇ§) - ÎπÑÌôúÏÑ±Ìôî (Ìï≠ÏÉÅ ÌëúÏãú)
        // document.addEventListener('keydown', (e) => {
        //     if (e.key.toLowerCase() === 'm' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
        //         e.preventDefault();
        //         if (!state.isGameOver && state.isPlayerTurn) {
        //             toggleMemoPanel();
        //         }
        //     }
        // });

        function initGame() {
            console.log('üéÆ Í≤åÏûÑ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            // Ïó∞Ïäπ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî (ÏÉà Í≤åÏûÑ ÏãúÏûë Ïãú)
            currentWinStreak = parseInt(localStorage.getItem('currentWinStreak')) || 0;
            maxWinStreak = parseInt(localStorage.getItem('maxWinStreak')) || 0;
            console.log(`üìä Ïó∞Ïäπ Ï¥àÍ∏∞Ìôî: ÌòÑÏû¨ ${currentWinStreak}Ïó∞Ïäπ, ÏµúÍ≥† ${maxWinStreak}Ïó∞Ïäπ`);
            
            // Îû≠ÌÇπ Ï¥àÍ∏∞Ìôî (Í≤åÏûÑ ÏãúÏûë Ïãú ÌîåÎ†àÏù¥Ïñ¥Î•º Îû≠ÌÇπÏóê Îì±Î°ù)
            const playerName = localStorage.getItem('playerName') || 'Player';
            const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
            const trophies = TrophySystem.loadTrophies();
            
            if (socket) {
                // Î™®Ïùò Í≤∞Ìà¨ Ï†êÏàò Îì±Î°ù
                socket.emit('updateRanking', {
                    category: 'mock',
                    playerName: playerName,
                    score: trophies.ai,
                    icon: playerIcon
                });
                
                // Ï†ïÏãù Í≤∞Ìà¨ Ï†êÏàò Îì±Î°ù
                socket.emit('updateRanking', {
                    category: 'formal',
                    playerName: playerName,
                    score: trophies.multiplayer,
                    icon: playerIcon
                });
                
                console.log(`üìä Îû≠ÌÇπ Ï¥àÍ∏∞Ìôî: ${playerName} (Î™®Ïùò: ${trophies.ai}Ï†ê, Ï†ïÏãù: ${trophies.multiplayer}Ï†ê, ÏïÑÏù¥ÏΩò: ${playerIcon})`);
            }
            
            let deck = [];
            for (let spellNumber = 1; spellNumber <= GAME_CONFIG.deckStructure.maxSpell; spellNumber++) {
                for (let cardCount = 0; cardCount < GAME_CONFIG.deckStructure.cardsPerSpell(spellNumber); cardCount++) {
                    deck.push(spellNumber);
                }
            }
            console.log('üì¶ Ï¥àÍ∏∞ Îç± ÏÉùÏÑ±:', deck);
            
            for (let currentIndex = deck.length - 1; currentIndex > 0; currentIndex--) {
                const randomIndex = Math.floor(Math.random() * (currentIndex + 1));
                [deck[currentIndex], deck[randomIndex]] = [deck[randomIndex], deck[currentIndex]];
            }
            console.log('üîÑ Îç± ÏÖîÌîå ÏôÑÎ£å');
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ Î≤àÏß∏ ÌÑ¥ÏùÑ Í≤∞Ï†ïÌïòÍ≥† ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï†ÑÏÜ°
            let firstPlayer;
            if (multiplayerMode && isHost) {
                firstPlayer = Math.random() < 0.5 ? 1 : 2;
                console.log(`üéØ Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï: ÌîåÎ†àÏù¥Ïñ¥ ${firstPlayer}`);
                
                // ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï≤´ Î≤àÏß∏ ÌÑ¥ Ï†ïÎ≥¥ Ï†ÑÏÜ°
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'firstTurn',
                        firstPlayer: firstPlayer
                    }));
                }
            } else if (multiplayerMode && !isHost) {
                // Í≤åÏä§Ìä∏Îäî Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏùÑ Í∏∞Îã§Î¶º
                console.log('‚è≥ Ìò∏Ïä§Ìä∏Ïùò Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï ÎåÄÍ∏∞ Ï§ë...');
                return; // Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏùÑ Í∏∞Îã§Î¶∞ ÌõÑ Îã§Ïãú Ìò∏Ï∂úÎê®
            } else {
                // AI Î™®ÎìúÏóêÏÑúÎäî ÎûúÎç§ Í≤∞Ï†ï
                firstPlayer = Math.random() < 0.5 ? 1 : 2;
                console.log(`üéØ AI Î™®Îìú Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï: ÌîåÎ†àÏù¥Ïñ¥ ${firstPlayer}`);
            }
            
            const aiName = aiDifficulty === 'easy' ? 'ü§ñ Ïâ¨ÏõÄ ÌóàÏàòÏïÑÎπÑ' : aiDifficulty === 'normal' ? 'ü§ñ Î≥¥ÌÜµ ÌóàÏàòÏïÑÎπÑ' : 'ü§ñ Ïñ¥Î†§ÏõÄ ÌóàÏàòÏïÑÎπÑ';
            state = {
                players: [
                                    { id: 1, name: 'Player', health: GAME_CONFIG.maxHealth, hand: deck.slice(0, 6).sort((a, b) => a - b), knownSecretStones: [] },
                { id: 2, name: multiplayerMode ? 'Opponent' : aiName, health: GAME_CONFIG.maxHealth, hand: deck.slice(6, 12).sort((a, b) => a - b), knownSecretStones: [] }
                ],
                secretStones: deck.slice(12),
                usedStones: [],
                publiclyRevealedSecretStones: [], // Ï†ÑÏ≤¥ Í≥µÍ∞úÎêú Ï£ºÎ¨∏ (6Î≤à Ï£ºÎ¨∏)
                personalRevealedStones: [], // ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ (ÎÇ¥Í∞Ä 1Î≤à Ï£ºÎ¨∏ ÏÇ¨Ïö©)
                opponentPersonalRevealedStones: [], // ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ (ÏÉÅÎåÄÍ∞Ä 1Î≤à Ï£ºÎ¨∏ ÏÇ¨Ïö©)
                currentPlayerId: firstPlayer,
                lastSuccessfulSpell: 0,
                spellFailed: false, // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
                isPlayerTurn: firstPlayer === 1,
                turnInProgress: false,
                gameLog: [`Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. ${firstPlayer === 1 ? playerName : (multiplayerMode ? opponentName : aiName)}Í∞Ä Î®ºÏ†Ä ÏãúÏûëÌï©ÎãàÎã§.`],
                isGameOver: false,
            };
            
            console.log('üéØ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉú ÏÑ§Ï†ï ÏôÑÎ£å');
            
            createSpellButtons();
            updatePlayerName();
            render();
            updateDebugInfo();
            
            // Î©îÎ™® Ìå®ÎÑê ÌëúÏãú
            showMemoPanel();
            
            // Í≤åÏûÑ ÏãúÏûë ÏÇ¨Ïö¥Îìú (AI Î™®ÎìúÏóêÏÑúÎßå Ïû¨ÏÉù)
            if (!multiplayerMode) {
            playGameStartSound();
            }
        }

        // ÎèÑÎßù Ï≤òÎ¶¨
        async function handleSurrender(surrenderingPlayerId) {
            console.log('üè≥Ô∏è ÏÉÅÎåÄÎ∞© ÎèÑÎßù Ï≤òÎ¶¨');
            
            // ÏäπÎ¶¨ Ìö®Í≥ºÏùå Ïû¨ÏÉù
            activateAudioContext();
            playGameOverSound(true);
            
            // ÏäπÎ¶¨ Ï≤òÎ¶¨ (ÏÉÅÎåÄÎ∞©Ïù¥ ÎèÑÎßùÏ≥§ÏúºÎØÄÎ°ú ÎÇ¥Í∞Ä ÏäπÎ¶¨)
            updateStats(true, true);
            
            // ÏäπÎ¶¨Ïùò Ï¶ùÌëú Ï∂îÍ∞Ä (Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨)
            TrophySystem.addVictoryTrophy('multiplayer');
            
            // Ï†ÑÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ (Ïó∞Ïäπ Ï≤òÎ¶¨ Ìè¨Ìï®)
            updateStats(true, true); // ÏäπÎ¶¨, Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥
            
            // Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (socket && socket.connected) {
                const playerName = localStorage.getItem('playerName') || 'Player';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                const trophies = TrophySystem.loadTrophies();
                
                socket.emit('updateRanking', {
                    category: 'formal',
                    playerName: playerName,
                    score: trophies.multiplayer,
                    icon: playerIcon
                });
                
                console.log(`üîÑ ÏÉÅÎåÄÎ∞© ÎèÑÎßù ÌõÑ Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏: ${playerName}`);
            }
            
            let message = 'ÏÉÅÎåÄÍ∞Ä ÎèÑÎßùÏ≥êÏÑú ÏäπÎ¶¨ÌïòÏòÄÏäµÎãàÎã§!';
            
            // 2Ïó∞Ïäπ Ïù¥ÏÉÅÏùº Îïå Ïó∞Ïäπ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            if (currentWinStreak >= 2) {
                message += `\n\n${Messages.streak(currentWinStreak)}`;
            }
            
            message += '\n\nüèÖ ÏäπÏ†ê +3';
            
            addLog('ÏÉÅÎåÄÎ∞©Ïù¥ ÎèÑÎßùÏ≥§ÏäµÎãàÎã§.');
            addLog('ÏäπÎ¶¨Í∞Ä Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.');
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
            state = {
                gameStarted: false,
                isGameOver: true,
                players: [],
                secretStones: [],
                usedStones: [],
                publiclyRevealedSecretStones: [],
                currentPlayerId: null,
                isPlayerTurn: false,
                lastSuccessfulSpell: 0,
                spellFailed: false, // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
                turnInProgress: false,
                gameLog: []
            };
            
            // ÏäπÎ¶¨Ìïú ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Î©îÏãúÏßÄ ÌëúÏãú
            await showModal('Í≤åÏûÑ Ï¢ÖÎ£å', message, true);
            
            // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            showTitleScreen();
        }

        // ÏäπÎ¶¨Ïùò Ï¶ùÌëú ÏãúÏä§ÌÖú
        const TrophySystem = {
            // Ï¶ùÌëú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadTrophies() {
                const aiTrophies = localStorage.getItem('aiTrophies') || '0';
                const multiplayerTrophies = localStorage.getItem('multiplayerTrophies') || '0';
                return {
                    ai: Math.max(0, parseInt(aiTrophies)),
                    multiplayer: Math.max(0, parseInt(multiplayerTrophies))
                };
            },
            
            // Ï¶ùÌëú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            saveTrophies(trophies) {
                localStorage.setItem('aiTrophies', trophies.ai.toString());
                localStorage.setItem('multiplayerTrophies', trophies.multiplayer.toString());
            },
            
            // Ï¶ùÌëú ÏóÖÎç∞Ïù¥Ìä∏
            updateTrophy(type, change) {
                const trophies = this.loadTrophies();
                trophies[type] = Math.max(0, trophies[type] + change);
                this.saveTrophies(trophies);
                this.displayTrophies(trophies);
                return trophies[type];
            },
            
            // Ï¶ùÌëú ÌëúÏãú
            displayTrophies(trophies) {
                const aiCount = DOM.get('ai-trophy-count');
                const multiplayerCount = DOM.get('multiplayer-trophy-count');
                
                if (aiCount) aiCount.textContent = `${trophies.ai}Ï†ê`;
                if (multiplayerCount) multiplayerCount.textContent = `${trophies.multiplayer}Ï†ê`;
            },
            
            // ÏäπÎ¶¨ Ïãú Ï¶ùÌëú Ï∂îÍ∞Ä
            addVictoryTrophy(type) {
                console.log(`üèÜ addVictoryTrophy Ìò∏Ï∂ú: ÌÉÄÏûÖ=${type}`);
                const newCount = this.updateTrophy(type, 3);
                showToast(`üéâ ÏäπÎ¶¨Ïùò Ï¶ùÌëú +3 ÌöçÎìù! (${type === 'ai' ? 'Î™®Ïùò Í≤∞Ìà¨' : 'Ï†ïÏãù Í≤∞Ìà¨'} Ï†êÏàò: ${newCount})`, 'success', 3000);
            },
            
            // Ìå®Î∞∞ Ïãú Ï¶ùÌëú Í∞êÏÜå
            addDefeatTrophy(type) {
                const newCount = this.updateTrophy(type, -1);
                showToast(`üíî Ìå®Î∞∞Î°ú Ï†êÏàò -1... (${type === 'ai' ? 'Î™®Ïùò Í≤∞Ìà¨' : 'Ï†ïÏãù Í≤∞Ìà¨'} Ï†êÏàò: ${newCount})`, 'warning', 3000);
            },
            
            // Ï¥àÍ∏∞Ìôî
            init() {
                const trophies = this.loadTrophies();
                this.displayTrophies(trophies);
            }
        };

        // Ìò∏Ïä§Ìä∏Ïùò Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ïÏúºÎ°ú Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        function resetGameWithFirstPlayer(firstPlayer) {
            console.log('üîÑ Ìò∏Ïä§Ìä∏Ïùò Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ïÏúºÎ°ú Í≤åÏûÑ Ï¥àÍ∏∞Ìôî');
            
            // Í≤åÏûÑ ÏãúÏûë Ìö®Í≥ºÏùå Ïû¨ÏÉù (Í≤åÏä§Ìä∏Í∞Ä Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏùÑ Î∞õÏïòÏùÑ Îïå)
            activateAudioContext();
            playGameStartSound();
            
            // Î°úÏª¨ Î©îÎ™® ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            localMemoNotes = {};
            localMemoPanelActive = false;
            
            // Í≤åÏûÑ ÏãúÏûë Ïãú ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ Î∞è Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
            stopTurnTimer();
            resetTurnGauge();
            
            // Ïò¨Î∞îÎ•∏ Îç± ÏÉùÏÑ± (1Î≤àÏùÄ 1Í∞ú, 2Î≤àÏùÄ 2Í∞ú, 3Î≤àÏùÄ 3Í∞ú...)
            let deck = [];
            for (let spellNumber = 1; spellNumber <= GAME_CONFIG.deckStructure.maxSpell; spellNumber++) {
                for (let cardCount = 0; cardCount < GAME_CONFIG.deckStructure.cardsPerSpell(spellNumber); cardCount++) {
                    deck.push(spellNumber);
                }
            }
            console.log('üì¶ Ï¥àÍ∏∞ Îç± ÏÉùÏÑ±:', deck);
            
            // Îç± ÏÖîÌîå
            shuffleArray(deck);
            console.log('üîÑ Îç± ÏÖîÌîå ÏôÑÎ£å');
            
            const playerName = getPlayerDisplayName();
            const opponentName = multiplayerMode ? (opponentName || 'Player2') : 'AI';
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            
            state = {
                players: [
                                    { id: 1, name: playerName, health: GAME_CONFIG.maxHealth, hand: deck.slice(0, GAME_CONFIG.maxHandSize).sort((a, b) => a - b), knownSecretStones: [] },
                { id: 2, name: opponentName, health: GAME_CONFIG.maxHealth, hand: deck.slice(GAME_CONFIG.maxHandSize, GAME_CONFIG.maxHandSize * 2).sort((a, b) => a - b), knownSecretStones: [] }
                ],
                secretStones: deck.slice(14),
                usedStones: [],
                publiclyRevealedSecretStones: [],
                currentPlayerId: firstPlayer,
                isPlayerTurn: multiplayerMode ? (firstPlayer === myPlayerId) : (firstPlayer === 1),
                lastSuccessfulSpell: 0,
                spellFailed: false, // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
                turnInProgress: false,
                isGameOver: false,
                gameStarted: true,
                gameLog: [Messages.gameStart(firstPlayer === 1 ? playerName : opponentName)]
            };
            
            console.log('üéØ Í≤åÏä§Ìä∏ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉú:', {
                playerHand: state.players[0].hand,
                opponentHand: state.players[1].hand,
                secretStones: state.secretStones,
                playerHealth: state.players[0].health,
                opponentHealth: state.players[1].health,
                firstPlayer: firstPlayer
            });
            
            createSpellButtons();
            updatePlayerName();
            render();
            updateButtons();
            
            // Î©îÎ™® Ìå®ÎÑê ÌëúÏãú
            showMemoPanel();
            
            // Í≤åÏûÑ ÏãúÏûë ÏÇ¨Ïö¥Îìú (Ïù¥ÎØ∏ startMultiplayerGameÏóêÏÑú Ïû¨ÏÉùÎê®)
            // playGameStartSound();
            
            // ÎîîÎ≤ÑÍ∑∏: UI ÏÉÅÌÉú ÌôïÏù∏
            console.log('üéÆ Í≤åÏûÑ UI Î†åÎçîÎßÅ ÏôÑÎ£å');
            console.log('üìä ÌòÑÏû¨ ÏÉÅÌÉú:', {
                isPlayerTurn: state.isPlayerTurn,
                currentPlayerId: state.currentPlayerId,
                gameStarted: state.gameStarted,
                isGameOver: state.isGameOver
            });
            
            // Ï≤´ Î≤àÏß∏ ÌÑ¥ ÌÉÄÏù¥Î®∏ ÏãúÏûë
            setTimeout(() => {
                startTurnTimer();
            }, 1000);
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏïàÏ†Ñ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ
            setTimeout(() => {
                safeRefreshGameState();
            }, 500);
        }

        function updateDebugInfo() {
            if (!debugPanel.classList.contains('hidden')) {
                const player = state.players[0];
                const ai = state.players[1];
                debugInfo.innerHTML = `
                                    <div>ÌÑ¥: ${state.currentPlayerId === 1 ? state.players[0].name : state.players[1].name}</div>
                <div>${state.players[0].name} Ï≤¥Î†•: ${player.health} | ${state.players[1].name} Ï≤¥Î†•: ${ai.health}</div>
                <div>${state.players[0].name} ÏÜêÌå®: [${player.hand.join(', ')}]</div>
                    <div>${state.players[1].name} ÏÜêÌå®: [${ai.hand.join(', ')}]</div>
                    <div>ÎπÑÎ∞ÄÏùò Îèå: ${state.secretStones.length}Í∞ú</div>
                    <div>ÏÇ¨Ïö©Ìïú Îèå: ${state.usedStones.length}Í∞ú</div>
                    <div>ÎßàÏßÄÎßâ ÏÑ±Í≥µ ÏòÅÏ∞Ω: ${state.lastSuccessfulSpell} ${state.lastSuccessfulSpell > 0 ? `(Ïó∞ÏÜç ÏòÅÏ∞Ω: ${state.lastSuccessfulSpell}Î≤à Ïù¥ÏÉÅ)` : '(Ïó∞ÏÜç ÏòÅÏ∞Ω ÏóÜÏùå)'}</div>
                    <div>Í≤åÏûÑ Ï¢ÖÎ£å: ${state.isGameOver}</div>
                `;
            }
        }

        function render() {
            // Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
            if (localMemoPanelActive) {
                const memoButtons = DOM.get('memo-buttons');
                memoButtons.classList.remove('hidden');
            }
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Î†åÎçîÎßÅ Ï§ëÎã®
            if (!state || !state.players || state.players.length < 2) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ Î†åÎçîÎßÅÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            // ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Îì§Ïù¥ Ïú†Ìö®ÌïúÏßÄ Ï∂îÍ∞Ä Í≤ÄÏÇ¨
            if (!state.players[0] || !state.players[1]) {
                console.log('‚ö†Ô∏è ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ Î†åÎçîÎßÅÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            const player = state.players[0];
            const opponent = state.players[1];
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî Ìò∏Ïä§Ìä∏Í∞Ä ÌîåÎ†àÏù¥Ïñ¥ 1, Í≤åÏä§Ìä∏Í∞Ä ÌîåÎ†àÏù¥Ïñ¥ 2
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            const myPlayer = state.players[myPlayerId - 1];
            const opponentPlayer = state.players[2 - myPlayerId]; // ÏÉÅÎåÄÎäî ÎÇòÎ®∏ÏßÄ ÌîåÎ†àÏù¥Ïñ¥
            
            // ÌïòÌä∏ Î≥ÄÌôî Í∞êÏßÄ (ÌïòÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÏóê)
            const currentMyHealth = myPlayer.health;
            const currentOpponentHealth = opponentPlayer.health;
            
            console.log(`üîç ÌïòÌä∏ Î≥ÄÌôî Ï≤¥ÌÅ¨ - ÎÇ¥: ${previousMyHealth} ‚Üí ${currentMyHealth}, ÏÉÅÎåÄ: ${previousOpponentHealth} ‚Üí ${currentOpponentHealth}`);
            
            // ÌïòÌä∏ Î≥ÄÌôî Í∞êÏßÄ (Î°úÍπÖÎßå)
            if (currentMyHealth < previousMyHealth) {
                console.log(`üíî ÎÇ¥ ÌïòÌä∏ ÏÜêÏã§: ${previousMyHealth} ‚Üí ${currentMyHealth}`);
            }
            if (currentMyHealth > previousMyHealth) {
                console.log(`üíö ÎÇ¥ ÌïòÌä∏ ÌöåÎ≥µ: ${previousMyHealth} ‚Üí ${currentMyHealth}`);
            }
            if (currentOpponentHealth < previousOpponentHealth) {
                console.log(`üíî ÏÉÅÎåÄ ÌïòÌä∏ ÏÜêÏã§: ${previousOpponentHealth} ‚Üí ${currentOpponentHealth}`);
            }
            if (currentOpponentHealth > previousOpponentHealth) {
                console.log(`üíö ÏÉÅÎåÄ ÌïòÌä∏ ÌöåÎ≥µ: ${previousOpponentHealth} ‚Üí ${currentOpponentHealth}`);
            }
            
            // ÌòÑÏû¨ ÌïòÌä∏ ÏÉÅÌÉú Ï†ÄÏû•
            previousMyHealth = currentMyHealth;
            previousOpponentHealth = currentOpponentHealth;
            
            // Ï≤¥Î†• ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (ÌååÌã∞ÌÅ¥ ÏÉùÏÑ± ÌõÑ)
            myHealthEl.innerHTML = '<span class="health-heart">‚ù§Ô∏è</span>'.repeat(Math.max(0, myPlayer.health));
            opponentHealthEl.innerHTML = '<span class="health-heart">‚ù§Ô∏è</span>'.repeat(Math.max(0, opponentPlayer.health));
            
            // Ï≤¥Î†• ÌïòÌä∏Ïóê Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            const hearts = myHealthEl.querySelectorAll('span');
            hearts.forEach(heart => heart.classList.add('health-heart'));
            
            // ÎîîÎ≤ÑÍ∑∏: ÌïòÌä∏ Î≥ÄÌôî Î°úÍ∑∏
            console.log(`üíî ÌïòÌä∏ Î≥ÄÌôî Í∞êÏßÄ - ÎÇ¥ ÌïòÌä∏: ${previousMyHealth} ‚Üí ${currentMyHealth}, ÏÉÅÎåÄ ÌïòÌä∏: ${previousOpponentHealth} ‚Üí ${currentOpponentHealth}`);
            
            // ÎÇ¥ ÏÜêÌå® ÌëúÏãú (ÏπòÌä∏ÌÇ§ Î™®ÎìúÏóêÏÑúÎäî ÏïûÎ©¥, ÏùºÎ∞ò Î™®ÎìúÏóêÏÑúÎäî Îí∑Î©¥)
            if (cheatMode) {
                myHandEl.innerHTML = myPlayer.hand.map(stone => `
                    <div class="card card-front flex flex-col items-center justify-center">
                        <div class="text-2xl mb-1">${getSpellIcon(stone)}</div>
                        <div class="text-sm font-bold">${stone}</div>
                    </div>
                `).join('');
            } else {
            myHandEl.innerHTML = myPlayer.hand.map(() => `<div class="card card-back"></div>`).join('');
            }
            
            // ÏÉÅÎåÄ ÏÜêÌå® (ÏïûÎ©¥) - Ìï≠ÏÉÅ ÏÉÅÎã®Ïóê ÌëúÏãú, ÏÉÅÎåÄÏùò Ìå®Î•º Î≥º Ïàò ÏûàÏñ¥Ïïº Ìï®
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî ÏÉÅÎåÄÎ∞©Ïùò Ïã§Ï†ú Ìå®Î•º ÌëúÏãú
            opponentHandEl.innerHTML = opponentPlayer.hand.map(stone => `
                <div class="card card-front flex flex-col items-center justify-center">
                    <div class="text-2xl mb-1">${getSpellIcon(stone)}</div>
                    <div class="text-sm font-bold">${stone}</div>
                </div>
            `).join('');
            
            secretStonesCountEl.textContent = `${state.secretStones.length}Í∞ú`;
            usedStonesCountEl.textContent = `${state.usedStones.length}Í∞ú`;
            
            // Í≤åÏûÑ Î°úÍ∑∏Ïóê Ïä§ÌÉÄÏùºÎßÅ Ï∂îÍ∞Ä
            gameLogEl.innerHTML = state.gameLog.map(log => {
                const isSuccess = log.includes('‚úÖ');
                const isFailure = log.includes('‚ùå');
                const isTurn = log.includes('ÌÑ¥');
                const isGameEnd = log.includes('Í≤åÏûÑ Ï¢ÖÎ£å');
                
                let className = '';
                if (isSuccess) className = 'text-green-400';
                else if (isFailure) className = 'text-red-400';
                else if (isTurn) className = 'text-blue-400 font-bold';
                else if (isGameEnd) className = 'text-purple-400 font-bold';
                
                return `<p class="${className}">${log}</p>`;
            }).join('');
            
            // ÌòÑÏû¨ ÌÑ¥Ïóê Îî∞Îùº ÏòÅÏó≠ ÌïòÏù¥ÎùºÏù¥Ìä∏ Î∞è ÏÉâÏÉÅ Íµ¨Î∂Ñ
            // ÌóàÏàòÏïÑÎπÑ Î™®ÎìúÏóêÏÑúÎäî myPlayerIdÎ•º ÏÇ¨Ïö©, Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî Ìò∏Ïä§Ìä∏/Í≤åÏä§Ìä∏ Íµ¨Î∂Ñ
            const isMyTurn = (state.currentPlayerId === myPlayerId);
            
            // Í∏ÄÎ°úÏö∞ Ìö®Í≥º: ÌòÑÏû¨ ÌÑ¥Ïù∏ ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤åÎßå ÌëúÏãú
            myArea.classList.toggle('player-area-glow', isMyTurn && !state.isGameOver);
            opponentArea.classList.toggle('player-area-glow', !isMyTurn && !state.isGameOver);
            opponentArea.classList.toggle('opponent-turn', !isMyTurn && !state.isGameOver);
            
            // ÌÑ¥ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞: ÌòÑÏû¨ ÌÑ¥Ïù∏ ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤åÎßå ÌëúÏãú
            const myTurnIndicator = DOM.get('my-turn-indicator');
            const opponentTurnIndicator = DOM.get('opponent-turn-indicator');
            
            if (myTurnIndicator && opponentTurnIndicator) {
                // ÎÇ¥ ÌÑ¥ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞: ÎÇ¥ ÌÑ¥Ïùº ÎïåÎßå ÌëúÏãú
                myTurnIndicator.classList.toggle('hidden', !isMyTurn || state.isGameOver);
                
                // ÏÉÅÎåÄ ÌÑ¥ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞: ÏÉÅÎåÄ ÌÑ¥Ïùº ÎïåÎßå ÌëúÏãú (Îπ®Í∞ÑÏÉâ)
                opponentTurnIndicator.classList.toggle('hidden', isMyTurn || state.isGameOver);
                opponentTurnIndicator.classList.toggle('opponent-turn', !isMyTurn && !state.isGameOver);
            }
            
            // Î≤ÑÌäºÎì§Ïù¥ Ìï≠ÏÉÅ Î≥¥Ïù¥ÎèÑÎ°ù Í∞ïÏ†ú ÏÑ§Ï†ï
            const spellButtons = spellButtonsContainer.querySelectorAll('button');
            spellButtons.forEach(btn => {
                btn.style.display = 'block';
                btn.style.visibility = 'visible';
            });
            
            updateButtons();
            updateDebugInfo();
            
            // Î©îÎ™® Ìå®ÎÑêÏùÑ Ìï≠ÏÉÅ ÌëúÏãú
            if (state.gameStarted && !state.isGameOver) {
                showMemoPanel();
            }
            
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïù¥ÏÉÅÌïú Í≤ΩÏö∞ ÏûêÎèô Î≥µÍµ¨
            if (multiplayerMode && (!state.players || state.players.length < 2)) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉú Ïù¥ÏÉÅ Í∞êÏßÄ, ÏûêÎèô Î≥µÍµ¨ ÏãúÎèÑ');
                setTimeout(() => {
                    safeRefreshGameState();
                }, 1000);
            }
            
            // ÌÑ¥ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ Î∞è ÎèôÍ∏∞Ìôî
            if (multiplayerMode && state.players && state.players.length >= 2) {
                const myPlayerId = isHost ? 1 : 2;
                const shouldBeMyTurn = (state.currentPlayerId === myPlayerId);
                if (state.isPlayerTurn !== shouldBeMyTurn) {
                    console.log(`‚ö†Ô∏è ÌÑ¥ ÏÉÅÌÉú Î∂àÏùºÏπò Í∞êÏßÄ - ÎÇ¥ ÌÑ¥: ${state.isPlayerTurn}, Ïã§Ï†ú ÌÑ¥: ${shouldBeMyTurn}`);
                    state.isPlayerTurn = shouldBeMyTurn;
                    console.log(`üîÑ ÌÑ¥ ÏÉÅÌÉú ÏûêÎèô ÎèôÍ∏∞Ìôî: ${state.isPlayerTurn} ‚Üí ${shouldBeMyTurn}`);
                }
            }
        }

        function createSpellButtons() {
            console.log('üîò ÏòÅÏ∞Ω Î≤ÑÌäº ÏÉùÏÑ±');
            spellButtonsContainer.innerHTML = '';
            
            const spellDescriptions = [
                { number: 1, name: 'Ïö¥Î™Ö Î≥ÄÌôò', icon: 'üîÆ', desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 3Í∞úÎ•º<br>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú' },
                { number: 2, name: 'ÎßàÎ†• Ï∞©Ï∑®', icon: 'üí´', desc: 'ÌîºÌï¥ 1, ÌöåÎ≥µ 1' },
                { number: 3, name: 'Ï†ïÏã† ÍµêÎûÄ', icon: 'üåÄ', desc: 'Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏<br>ÌïòÎÇòÎ•º ÏÉÅÎåÄ Ìå®Ïóê Ìà¨ÏûÖ' },
                { number: 4, name: 'ÌôîÏóº ÌôîÏÇ¥', icon: 'üî•', desc: 'ÌîºÌï¥ 1' },
                { number: 5, name: 'ÏÉùÎ™Ö Î¨ºÏïΩ', icon: 'üß™', desc: 'ÌöåÎ≥µ 1' },
                { number: 6, name: 'Î™ÖÏÉÅ', icon: 'üí§', desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 1Í∞úÎ•º<br>Ï†ÑÏ≤¥ Í≥µÍ∞ú' }
            ];
            
            spellDescriptions.forEach(spell => {
                const button = document.createElement('button');
                
                // Î™®Î∞îÏùºÏóêÏÑúÎäî ÏïÑÏù¥ÏΩòÎßå, Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎäî Ï†ÑÏ≤¥ Ï†ïÎ≥¥
                const isMobile = window.innerWidth <= 768;
                button.innerHTML = isMobile ? 
                    `<div class="text-2xl">${spell.icon}</div>` :
                    `<div class="text-lg">${spell.icon}</div>
                     <div class="text-xs font-bold">${spell.number}: ${spell.name}</div>
                     <div class="text-xs opacity-75">${spell.desc}</div>`;
                
                button.classList.add('py-3', 'rounded-lg', 'font-bold', 'btn-primary', 'spell-button', 'flex', 'flex-col', 'items-center', 'justify-center', 'h-24');
                button.dataset.spell = spell.number;
                button.addEventListener('click', () => handleSpellCast(spell.number));
                
                // Î≤ÑÌäºÏù¥ Ìï≠ÏÉÅ Î≥¥Ïù¥ÎèÑÎ°ù Í∞ïÏ†ú ÏÑ§Ï†ï
                button.style.display = 'block';
                button.style.visibility = 'visible';
                
                spellButtonsContainer.appendChild(button);
                console.log(`üîò ÏòÅÏ∞Ω ${spell.number} Î≤ÑÌäº ÏÉùÏÑ± ÏôÑÎ£å`);
            });
            
            createMemoButtons();
        }
        
        function createMemoButtons() {
            console.log('üìù Î©îÎ™® Î≤ÑÌäº ÏÉùÏÑ±');
            const memoButtonsContainer = DOM.get('memo-buttons');
            memoButtonsContainer.innerHTML = '';
            
            const spellDescriptions = [
                { number: 1, name: 'Ïö¥Î™Ö Î≥ÄÌôò' },
                { number: 2, name: 'ÎßàÎ†• Ï∞©Ï∑®' },
                { number: 3, name: 'Ï†ïÏã† ÍµêÎûÄ' },
                { number: 4, name: 'ÌôîÏóº ÌôîÏÇ¥' },
                { number: 5, name: 'ÏÉùÎ™Ö Î¨ºÏïΩ' },
                { number: 6, name: 'Î™ÖÏÉÅ' }
            ];
            
            spellDescriptions.forEach(spell => {
                const button = document.createElement('button');
                button.innerHTML = `
                    <div class="text-xs">‚ùå</div>
                `;
                button.classList.add('py-1', 'px-2', 'rounded-lg', 'font-bold', 'memo-button', 'flex', 'flex-col', 'items-center', 'justify-center', 'h-8');
                button.dataset.spell = spell.number;
                button.addEventListener('click', () => toggleMemo(spell.number));
                memoButtonsContainer.appendChild(button);
            });
            
            // Î©îÎ™® Î≤ÑÌäº ÏÉùÏÑ± ÌõÑ Í∏∞Ï°¥ Î©îÎ™® ÏÉÅÌÉú Î≥µÏõê
            updateMemoButtons();
        }
        
        function toggleMemo(spellNumber) {
            // ÌÜ†Í∏Ä: ÌòÑÏû¨ ÏÉÅÌÉúÏùò Î∞òÎåÄÎ°ú Î≥ÄÍ≤Ω
            const currentState = localMemoNotes[spellNumber] || false;
            localMemoNotes[spellNumber] = !currentState;
            
            console.log(`üìù Î©îÎ™® ÌÜ†Í∏Ä: ÏòÅÏ∞Ω ${spellNumber} - ${localMemoNotes[spellNumber] ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
            
            updateMemoButtons();
            playCardSound();
        }
        
        function updateMemoButtons() {
            const memoButtons = document.querySelectorAll('.memo-button');
            memoButtons.forEach(button => {
                const spellNumber = parseInt(button.dataset.spell);
                const isActive = localMemoNotes[spellNumber];
                
                if (isActive) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function toggleMemoPanel() {
            const memoButtons = DOM.get('memo-buttons');
            const isVisible = !memoButtons.classList.contains('hidden');
            
            if (isVisible) {
                memoButtons.classList.add('hidden');
                localMemoPanelActive = false;
                console.log('üìù Î©îÎ™® Ìå®ÎÑê ÎπÑÌôúÏÑ±Ìôî');
            } else {
                memoButtons.classList.remove('hidden');
                localMemoPanelActive = true;
                console.log('üìù Î©îÎ™® Ìå®ÎÑê ÌôúÏÑ±Ìôî');
            }
            
            playCardSound();
        }
        
        // Î©îÎ™® Ìå®ÎÑêÏùÑ Ìï≠ÏÉÅ ÌëúÏãúÌïòÎäî Ìï®Ïàò
        function showMemoPanel() {
            const memoButtons = DOM.get('memo-buttons');
            memoButtons.classList.remove('hidden');
            localMemoPanelActive = true;
            console.log('üìù Î©îÎ™® Ìå®ÎÑê Ìï≠ÏÉÅ ÌëúÏãú');
        }

        // Í≤åÏûÑ ÏÉÅÌÉú ÏïàÏ†Ñ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
        function safeRefreshGameState() {
            try {
                // Í≤åÏûÑ ÏÉÅÌÉú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!GameConditions.isGameValid()) {
                    console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå - Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú Î≥µÍµ¨');
                    resetGame();
                    return;
                }
                
                // Ï≤¥Î†• ÏùåÏàò Î∞©ÏßÄ
                state.players.forEach(player => {
                    if (player.health < 0) {
                        console.log(`‚ö†Ô∏è ÌîåÎ†àÏù¥Ïñ¥ ${player.name} Ï≤¥Î†• ÏùåÏàò Î∞©ÏßÄ: ${player.health} ‚Üí 0`);
                        player.health = 0;
                    }
                });
                
                // ÌòÑÏû¨ Í≤åÏûÑ ÏÉÅÌÉú Î∞±ÏóÖ
                const currentState = { ...state };
                const currentPlayerName = localStorage.getItem('playerName') || 'Player';
                
                // ÏÉÅÎåÄÎ∞© Ïù¥Î¶ÑÏùÑ Îçî ÏïàÏ†ÑÌïòÍ≤å Í∞ÄÏ†∏Ïò§Í∏∞
                let currentOpponentName = 'Player2';
                if (opponentName) {
                    currentOpponentName = opponentName;
                } else if (state.players && state.players.length >= 2) {
                    // Í≤åÏûÑ ÏÉÅÌÉúÏóêÏÑú ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
                    const myPlayerId = isHost ? 1 : 2;
                    const opponentPlayer = state.players.find(p => p.id !== myPlayerId);
                    if (opponentPlayer && opponentPlayer.name) {
                        currentOpponentName = opponentPlayer.name;
                    }
                }
                
                // Í∏∞Î≥∏ UI ÏöîÏÜåÎì§ Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
                createSpellButtons();
                
                // ÎÇ¥ Ïù¥Î¶ÑÎßå ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉÅÎåÄÎ∞© Ïù¥Î¶ÑÏùÄ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
                const myTitle = DOM.get('my-title');
                if (myTitle) {
                    myTitle.textContent = `ÎÇò (${currentPlayerName})`;
                }
                
                // ÏÉÅÎåÄÎ∞© Ïù¥Î¶ÑÎèÑ ÏïàÏ†ÑÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
                updateOpponentName();
                
                // ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
                const opponentArea = DOM.get('opponent-area');
                const opponentTitle = opponentArea.querySelector('h2');
                if (opponentTitle) {
                    // ÌòÑÏû¨ ÌëúÏãúÎêú Ïù¥Î¶ÑÏù¥ ÏûàÏúºÎ©¥ Ïú†ÏßÄ, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÑ§Ï†ï
                    const currentDisplayName = opponentTitle.textContent;
                    if (currentDisplayName && currentDisplayName !== 'ÏÉÅÎåÄ') {
                        // Ïù¥ÎØ∏ ÌëúÏãúÎêú Ïù¥Î¶ÑÏù¥ ÏûàÏúºÎ©¥ Ïú†ÏßÄ
                    } else {
                        opponentTitle.textContent = `ÏÉÅÎåÄ (${currentOpponentName})`;
                    }
                }
                
                // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏ÌïòÍ≥† Î≥µÍµ¨
                if (!GameConditions.isGameValid() || !state.players[0] || !state.players[1]) {
                    // Í∏∞Î≥∏ Í≤åÏûÑ ÏÉÅÌÉúÎ°ú Î≥µÍµ¨
                    if (multiplayerMode) {
                        const myPlayerId = isHost ? 1 : 2;
                        state = {
                            players: [
                                                { id: 1, name: currentPlayerName, health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] },
                { id: 2, name: currentOpponentName, health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] }
                            ],
                            secretStones: [],
                            usedStones: [],
                            publiclyRevealedSecretStones: [],
                            currentPlayerId: 1,
                            isPlayerTurn: (myPlayerId === 1),
                            lastSuccessfulSpell: 0,
                            turnInProgress: false,
                            isGameOver: false,
                            gameStarted: true,
                            gameLog: ['Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.']
                        };
                    }
                } else {
                    // Í≤åÏûÑ ÏÉÅÌÉúÎäî Ïú†Ìö®ÌïòÏßÄÎßå ÌÑ¥ ÏÉÅÌÉúÎ•º Ïû¨ÌôïÏù∏
                    if (multiplayerMode) {
                        const myPlayerId = isHost ? 1 : 2;
                        const shouldBeMyTurn = (state.currentPlayerId === myPlayerId);
                        if (state.isPlayerTurn !== shouldBeMyTurn) {
                            state.isPlayerTurn = shouldBeMyTurn;
                        }
                    }
                }
                
                // UI Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
                render();
                updateButtons();
                updateDebugInfo();
                
                // Î©îÎ™® Ìå®ÎÑê ÌëúÏãú
                showMemoPanel();
                
            } catch (error) {
                console.error('‚ùå Í≤åÏûÑ ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
                addLog('‚ùå Í≤åÏûÑ ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        function updateButtons() {
            const buttons = spellButtonsContainer.querySelectorAll('button');
            const isMyTurn = GameConditions.isMyTurn();
            
            // ÌÑ¥ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî (Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú)
            if (multiplayerMode && state.isPlayerTurn !== isMyTurn) {
                    console.log(`üîÑ ÌÑ¥ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî: isPlayerTurn ${state.isPlayerTurn} ‚Üí ${isMyTurn}`);
                    state.isPlayerTurn = isMyTurn;
            }
            
            // ÌÑ¥ ÏßÑÌñâ ÏÉÅÌÉú Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî (ÎÇ¥ ÌÑ¥Ïù¥Í≥† ÌÑ¥ ÏßÑÌñâÏ§ëÏù¥Î©¥ Ï¥àÍ∏∞Ìôî)
            if (isMyTurn && state.turnInProgress) {
                console.log('‚ö†Ô∏è ÌÑ¥ ÏßÑÌñâ ÏÉÅÌÉú Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî');
                state.turnInProgress = false;
            }
            
            // ÎÇ¥ ÌÑ¥Ïù¥Í≥† ÌÑ¥ ÏßÑÌñâ Ï§ëÏù¥ ÏïÑÎãê Îïå Ï£ºÎ¨∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            // Îã®, ÏòÅÏ∞Ω Ïã§Ìå® ÌõÑÏóêÎäî Í∞ïÏ†úÎ°ú ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉú Ïú†ÏßÄ
            if (isMyTurn && !state.turnInProgress && !state.isGameOver && !state.spellFailed) {
                if (spellButtonsDisabled) {
                    console.log('üîÑ ÎÇ¥ ÌÑ¥ ÏãúÏûë - Ï£ºÎ¨∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî');
                    spellButtonsDisabled = false;
                }
            }
            
            // ÏòÅÏ∞Ω Ïã§Ìå® ÌõÑÏóêÎäî Î¨¥Ï°∞Í±¥ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Ïú†ÏßÄ
            if (state.spellFailed) {
                spellButtonsDisabled = true;
                console.log('üîí ÏòÅÏ∞Ω Ïã§Ìå® ÏÉÅÌÉú - Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Ïú†ÏßÄ');
            }
            
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            console.log(`üéÆ Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ - ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ID: ${myPlayerId}, ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ID: ${state.currentPlayerId}, ÎÇ¥ ÌÑ¥: ${isMyTurn}, ÌÑ¥ ÏßÑÌñâÏ§ë: ${state.turnInProgress}, Í≤åÏûÑÏ¢ÖÎ£å: ${state.isGameOver}`);
            
            buttons.forEach(btn => {
                const spellNumber = parseInt(btn.dataset.spell);
                const isDisabled = !GameConditions.canPlaySpell() || (state.lastSuccessfulSpell > 0 && spellNumber < state.lastSuccessfulSpell) || spellButtonsDisabled;
                
                // Î≤ÑÌäºÏùÑ ÏôÑÏ†ÑÌûà Ïà®Í∏∞ÏßÄ ÎßêÍ≥† ÎπÑÌôúÏÑ±ÌôîÎßå ÌïòÍ∏∞
                btn.disabled = isDisabled;
                
                // ÎπÑÌôúÏÑ±ÌôîÎêú Î≤ÑÌäºÎèÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú Î≥¥Ïù¥ÎèÑÎ°ù Ïä§ÌÉÄÏùº Ï°∞Ï†ï
                if (isDisabled) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    // Ïó∞ÏÜç ÏòÅÏ∞Ω Í∑úÏπô ÏúÑÎ∞ò Ïãú Ï∂îÍ∞Ä ÏãúÍ∞ÅÏ†Å ÌëúÏãú
                    if (state.lastSuccessfulSpell > 0 && spellNumber < state.lastSuccessfulSpell) {
                        btn.style.border = '2px solid #dc3545';
                        btn.style.color = '#dc3545';
                        // Ïó∞ÏÜç ÏòÅÏ∞Ω Í∑úÏπô ÏúÑÎ∞ò Ïãú Ï∂îÍ∞Ä ÌÖçÏä§Ìä∏ ÌëúÏãú (Îçî Í∞ÑÎã®ÌïòÍ≤å)
                        const descElement = btn.querySelector('.text-xs.opacity-75');
                        if (descElement) {
                            descElement.innerHTML = `${state.lastSuccessfulSpell}Î≤à Ïù¥ÏÉÅ`;
                        }
                    } else {
                        btn.style.border = '';
                        btn.style.color = '';
                        // ÏõêÎûò ÏÑ§Î™Ö Î≥µÏõê
                        const descElement = btn.querySelector('.text-xs.opacity-75');
                        if (descElement) {
                        const spellDescriptions = [
                                { number: 1, desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 3Í∞úÎ•º<br>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú' },
                                { number: 2, desc: 'ÌîºÌï¥ 1, ÌöåÎ≥µ 1' },
                                { number: 3, desc: 'Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏<br>ÌïòÎÇòÎ•º ÏÉÅÎåÄ Ìå®Ïóê Ìà¨ÏûÖ' },
                                { number: 4, desc: 'ÌîºÌï¥ 1' },
                                { number: 5, desc: 'ÌöåÎ≥µ 1' },
                                { number: 6, desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 1Í∞úÎ•º<br>Ï†ÑÏ≤¥ Í≥µÍ∞ú' }
                            ];
                        const spell = spellDescriptions.find(s => s.number === spellNumber);
                            if (spell) {
                                descElement.innerHTML = spell.desc;
                            }
                        }
                    }
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.border = '';
                    btn.style.color = '';
                    // ÏõêÎûò ÏÑ§Î™Ö Î≥µÏõê
                    const descElement = btn.querySelector('.text-xs.opacity-75');
                    if (descElement) {
                        const spellDescriptions = [
                            { number: 1, desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 3Í∞úÎ•º<br>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú' },
                            { number: 2, desc: 'ÌîºÌï¥ 1, ÌöåÎ≥µ 1' },
                            { number: 3, desc: 'Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏<br>ÌïòÎÇòÎ•º ÏÉÅÎåÄ Ìå®Ïóê Ìà¨ÏûÖ' },
                            { number: 4, desc: 'ÌîºÌï¥ 1' },
                            { number: 5, desc: 'ÌöåÎ≥µ 1' },
                            { number: 6, desc: 'ÎπÑÎ∞Ä Ï£ºÎ¨∏ 1Í∞úÎ•º<br>Ï†ÑÏ≤¥ Í≥µÍ∞ú' }
                        ];
                        const spell = spellDescriptions.find(s => s.number === spellNumber);
                        if (spell) {
                            descElement.innerHTML = spell.desc;
                        }
                    }
                }
                
                // ÎîîÎ≤ÑÍ∑∏Ïö©: Î≤ÑÌäº ÏÉÅÌÉú Î°úÍ∑∏
                console.log(`üîò ÏòÅÏ∞Ω ${spellNumber} Î≤ÑÌäº - ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ID: ${myPlayerId}, ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ID: ${state.currentPlayerId}, ÎÇ¥ ÌÑ¥: ${isMyTurn}, ÌÑ¥ ÏßÑÌñâÏ§ë: ${state.turnInProgress}, ÎßàÏßÄÎßâ ÏÑ±Í≥µ: ${state.lastSuccessfulSpell}, Í≤åÏûÑÏ¢ÖÎ£å: ${state.isGameOver}, Î≤ÑÌäºÎπÑÌôúÏÑ±Ìôî: ${spellButtonsDisabled}, ÎπÑÌôúÏÑ±Ìôî: ${isDisabled}`);
            });
            
            endTurnBtn.disabled = !isMyTurn || state.turnInProgress || state.isGameOver || state.spellFailed;
            
            // ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäºÎèÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú Î≥¥Ïù¥ÎèÑÎ°ù Ï°∞Ï†ï
            if (endTurnBtn.disabled) {
                endTurnBtn.style.opacity = '0.5';
                endTurnBtn.style.cursor = 'not-allowed';
            } else {
                endTurnBtn.style.opacity = '1';
                endTurnBtn.style.cursor = 'pointer';
            }
            
            console.log(`üîÑ ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäº - ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ID: ${myPlayerId}, ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ID: ${state.currentPlayerId}, ÎÇ¥ ÌÑ¥: ${isMyTurn}, ÌÑ¥ ÏßÑÌñâÏ§ë: ${state.turnInProgress}, Í≤åÏûÑÏ¢ÖÎ£å: ${state.isGameOver}, ÏòÅÏ∞ΩÏã§Ìå®: ${state.spellFailed}, ÎπÑÌôúÏÑ±Ìôî: ${endTurnBtn.disabled}`);
        }

        async function handleSpellCast(spellNumber) {
            console.log(`üéØ ÏòÅÏ∞Ω ÏãúÎèÑ: ${spellNumber}Î≤à`);
            
            // Ïù¥ÎØ∏ ÏòÅÏ∞Ω ÏßÑÌñâ Ï§ëÏù¥Í±∞ÎÇò Î≤ÑÌäºÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï§ëÎã®
            if (state.turnInProgress || spellButtonsDisabled) {
                console.log('‚ùå ÏòÅÏ∞Ω ÏßÑÌñâ Ï§ë ÎòêÎäî Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî - Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ');
                return;
            }
            
            // Ïó∞ÏÜç ÏòÅÏ∞Ω Í∑úÏπô Í≤ÄÏ¶ù (Í∞ïÌôîÎêú Í≤ÄÏ¶ù)
            if (state.lastSuccessfulSpell > 0 && spellNumber < state.lastSuccessfulSpell) {
                console.log(`‚ùå Ïó∞ÏÜç ÏòÅÏ∞Ω Í∑úÏπô ÏúÑÎ∞ò: ${spellNumber} < ${state.lastSuccessfulSpell}`);
                return;
            }
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò ÌÑ¥Ïùº ÎïåÎßå ÌôúÏÑ±Ìôî
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî currentPlayerIdÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÌÑ¥ ÌåêÎã®
            let isMyTurn;
            if (multiplayerMode) {
                isMyTurn = (state.currentPlayerId === myPlayerId);
                // state.isPlayerTurnÍ≥º currentPlayerIdÍ∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏúºÎ©¥ ÎèôÍ∏∞Ìôî
                if (state.isPlayerTurn !== isMyTurn) {
                    state.isPlayerTurn = isMyTurn;
                }
            } else {
                isMyTurn = state.isPlayerTurn;
            }
            
            if (!isMyTurn || state.turnInProgress || state.isGameOver) {
                console.log('‚ùå ÏòÅÏ∞Ω ÏãúÎèÑ Ïã§Ìå® - Ï°∞Í±¥ Î∂àÎßåÏ°±');
                return;
            }
            
            // Ï£ºÎ¨∏ Î≤ÑÌäº Ï¶âÏãú ÎπÑÌôúÏÑ±Ìôî
            disableSpellButtons();
            state.turnInProgress = true;
            updateButtons();
            
            // ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäºÎèÑ ÎπÑÌôúÏÑ±Ìôî
            endTurnBtn.disabled = true;
            endTurnBtn.style.opacity = '0.5';
            endTurnBtn.style.cursor = 'not-allowed';
            
            // ÌòÑÏû¨ ÌÑ¥Ïù∏ ÌîåÎ†àÏù¥Ïñ¥ Ï∞æÍ∏∞
            const currentPlayer = state.players.find(p => p.id === state.currentPlayerId);
            
            // ÌòÑÏû¨ ÌÑ¥Ïù∏ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ìå®ÏóêÏÑú Ïπ¥Îìú Ï∞æÍ∏∞
            const handIndex = currentPlayer.hand.indexOf(spellNumber);
            
            console.log(`üîç ÏÜêÌå®ÏóêÏÑú ${spellNumber} Ï∞æÍ∏∞:`, {
                playerId: currentPlayer.id,
                hand: currentPlayer.hand,
                foundIndex: handIndex,
                hasCard: handIndex > -1
            });
            
            if (handIndex > -1) {
                const castedStone = currentPlayer.hand.splice(handIndex, 1)[0];
                state.usedStones.push(castedStone);
                console.log(`‚úÖ ÏòÅÏ∞Ω ÏÑ±Í≥µ! ÏÇ¨Ïö©Îêú Ï£ºÎ¨∏: ${castedStone}`);
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï†ÑÏÜ°
                if (multiplayerMode && dataChannel && dataChannel.readyState === 'open') {
                    const myPlayerId = isHost ? 1 : 2;
                    dataChannel.send(JSON.stringify({
                        type: 'cardPlayed',
                        card: spellNumber,
                        playerId: myPlayerId,
                        gameState: state
                    }));
                }
                
                // ÏÑ±Í≥µ Ìö®Í≥º
                playSuccessSound();
                addSuccessAnimation(myArea);
                
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                addLog(Messages.spellSuccess(state.players[myPlayerId - 1].name, spellNumber));
                
                // Î®ºÏ†Ä lastSuccessfulSpell ÏóÖÎç∞Ïù¥Ìä∏
                state.lastSuccessfulSpell = spellNumber;
                console.log(`üìä Ïó∞ÏÜç ÏòÅÏ∞Ω ÏóÖÎç∞Ïù¥Ìä∏: ${spellNumber}Î≤à (Ïù¥Ï†ú ${spellNumber}Î≤à Ïù¥ÏÉÅÎßå ÏÇ¨Ïö© Í∞ÄÎä•)`);
                
                render();
                
                await executeSpellEffect(myPlayerId, spellNumber);
                
                // ÏÑ±Í≥µÌïú Í≤ΩÏö∞ Ïó∞ÏÜç ÏòÅÏ∞Ω Í∞ÄÎä•ÌïòÎèÑÎ°ù ÌÑ¥ Ïú†ÏßÄ
                state.turnInProgress = false;
                
                // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateButtons();
                
                // Ïó∞ÏÜç ÏòÅÏ∞Ω Ïãú ÌÉÄÏù¥Î®∏ Í≥ÑÏÜç Ïú†ÏßÄ (Ïû¨ÏãúÏûëÌïòÏßÄ ÏïäÏùå)
                console.log('üí° Ïó∞ÏÜç ÏòÅÏ∞Ω ÏÑ±Í≥µ - ÌÉÄÏù¥Î®∏ Í≥ÑÏÜç Ïú†ÏßÄ');
                
                // Ïó∞ÏÜç ÏòÅÏ∞Ω ÏïàÎÇ¥ Î©îÏãúÏßÄ
                                    addLog(`üí° ${spellNumber}Î≤à Ïù¥ÏÉÅ Ïó∞ÏÜç ÏòÅÏ∞Ω Í∞ÄÎä•`);
                return;
            } else {
                // ÌòÑÏû¨ ÌÑ¥Ïù∏ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï≤¥Î†• Í∞êÏÜå
                const currentPlayer = state.players.find(p => p.id === state.currentPlayerId);
                currentPlayer.health--;
                console.log(`‚ùå ÏòÅÏ∞Ω Ïã§Ìå®! ÌîåÎ†àÏù¥Ïñ¥ ${currentPlayer.id} Ï≤¥Î†• Í∞êÏÜå: ${currentPlayer.health}`);
                
                // Ïã§Ìå® Ìö®Í≥º
                playFailureSound();
                addFailureAnimation(myArea);
                showDamageEffect(myArea, 1);
                
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                
                // ÏòÅÏ∞Ω Ïã§Ìå® Ïãú Ï¶âÏãú Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                spellButtonsDisabled = true;
                state.spellFailed = true; // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                disableSpellButtons();
                
                // ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäºÎèÑ Ï¶âÏãú ÎπÑÌôúÏÑ±Ìôî
                endTurnBtn.disabled = true;
                endTurnBtn.style.opacity = '0.5';
                endTurnBtn.style.cursor = 'not-allowed';
                
                // ÏòÅÏ∞Ω Ïã§Ìå® ÌåùÏóÖ ÌëúÏãú
                await showModal('ÏòÅÏ∞Ω Ïã§Ìå®', `${spellNumber}Î≤à Ï£ºÎ¨∏ ÏòÅÏ∞Ω Ïã§Ìå®<br>Ï≤¥Î†• -1 (ÌòÑÏû¨: ${currentPlayer.health})`);
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ïã§Ìå® Ï†ÑÏÜ°
                if (multiplayerMode && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'spellFailed',
                        spell: spellNumber,
                        playerId: myPlayerId,
                        gameState: state
                    }));
                }
                
                addLog(Messages.spellFailure(state.players[myPlayerId - 1].name, spellNumber));
                
                // Ï≤¥Î†• Í∞êÏÜå ÌõÑ Î∞îÎ°ú Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
                if (checkGameOver()) return;
                
                // Í≤åÏûÑ Î°úÍ∑∏Îßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† Î≤ÑÌäº ÏÉÅÌÉúÎäî Ïú†ÏßÄ
                const gameLogEl = DOM.get('game-log');
                if (gameLogEl) {
                    gameLogEl.innerHTML = state.gameLog.map(log => {
                        const isSuccess = log.includes('‚úÖ');
                        const isFailure = log.includes('‚ùå');
                        const isTurn = log.includes('ÌÑ¥');
                        const isGameEnd = log.includes('Í≤åÏûÑ Ï¢ÖÎ£å');
                        
                        let className = '';
                        if (isSuccess) className = 'text-green-400';
                        else if (isFailure) className = 'text-red-400';
                        else if (isTurn) className = 'text-blue-400 font-bold';
                        else if (isGameEnd) className = 'text-purple-400 font-bold';
                        
                        return `<p class="${className}">${log}</p>`;
                    }).join('');
                }
                
                await sleep(1000);
                endTurn();
                return;
            }
        }

        // ÌÑ¥ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function switchToNextPlayer() {
            const currentPlayerName = state.currentPlayerId === 1 ? state.players[0].name : (multiplayerMode ? state.players[1].name : 'AI');
            addLog(Messages.turnEnd(currentPlayerName));
            state.lastSuccessfulSpell = 0;
            // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            state.spellFailed = false;
            state.currentPlayerId = state.currentPlayerId === 1 ? 2 : 1;
            
            if (multiplayerMode) {
                const myPlayerId = isHost ? 1 : 2;
                state.isPlayerTurn = (state.currentPlayerId === myPlayerId);
            } else {
                state.isPlayerTurn = !state.isPlayerTurn;
            }
            }
            
        function sendTurnEndToOpponent() {
            if (GameConditions.isMultiplayerConnected()) {
                console.log('üì§ ÌÑ¥ Ï¢ÖÎ£å Î©îÏãúÏßÄ Ï†ÑÏÜ°');
                dataChannel.send(JSON.stringify({
                    type: 'turnEnd',
                    gameState: state,
                    currentPlayerId: state.currentPlayerId,
                    isPlayerTurn: state.isPlayerTurn
                }));
            }
        }

        function startNextTurn() {
            // ÌÑ¥ ÏßÑÌñâ Ï§ë ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            state.turnInProgress = false;
            
            if (!state.isPlayerTurn && !multiplayerMode) {
                startTurnTimer();
                aiTurn();
            } else if (!state.isPlayerTurn && multiplayerMode) {
                const opponentName = state.players[1].name;
                addLog(Messages.turnStart(opponentName));
                startTurnTimer();
            } else if (state.isPlayerTurn) {
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                const myName = state.players[myPlayerId - 1].name;
                addLog(Messages.turnStart(myName));
                startTurnTimer();
                
                // ÏÉàÎ°úÏö¥ ÌÑ¥ ÏãúÏûë Ïãú ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
                state.spellFailed = false;
                
                // ÌîåÎ†àÏù¥Ïñ¥ ÌÑ¥ ÏãúÏûë Ïãú Î™®Îì† Î≤ÑÌäº ÌôúÏÑ±Ìôî
                spellButtonsDisabled = false;
                enableSpellButtons();
                
                if (multiplayerMode) {
                    console.log('üéØ ÎÇ¥ ÌÑ¥ ÏãúÏûë - ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ');
                    setTimeout(() => {
                        safeRefreshGameState();
                    }, 500);
                }
            }
        }

        function endTurn() {
            console.log('üîÑ ÌÑ¥ Ï¢ÖÎ£å');
            if (state.isGameOver) return;
            
            if (!GameConditions.isGameValid()) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ ÌÑ¥ Ï¢ÖÎ£åÎ•º Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            // ÌÑ¥ Ï¢ÖÎ£å ÏßÑÌñâ Ï§ë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ïÏúºÎ°ú Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
            if (state.turnInProgress) {
                console.log('‚ö†Ô∏è ÌÑ¥ Ï¢ÖÎ£åÍ∞Ä Ïù¥ÎØ∏ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§');
                return;
            }
            
            state.turnInProgress = true;
            
            stopTurnTimer();
            switchToNextPlayer();
            sendTurnEndToOpponent();
            
            render();
            updateButtons();
            
            if (checkGameOver()) return;
            startNextTurn();
        }

        // Ï£ºÎ¨∏ Ìö®Í≥º Ìï®ÏàòÎì§
        async function executeMeditation(player, opponent) {
            console.log('üí§ Î™ÖÏÉÅ Ìö®Í≥º Ïã§Ìñâ');
                    if (state.secretStones.length > 0) {
                        const revealedStone = state.secretStones.splice(0, 1)[0];
                
                // Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎêòÎäî ÎπÑÎ∞Ä Ï£ºÎ¨∏ÏúºÎ°ú Ï∂îÍ∞Ä
                if (!state.publiclyRevealedSecretStones) {
                    state.publiclyRevealedSecretStones = [];
                }
                        state.publiclyRevealedSecretStones.push(revealedStone);
                
                console.log(`üí§ Ï†ÑÏ≤¥ Í≥µÍ∞úÎêú Ï£ºÎ¨∏: ${revealedStone}`);
                addLog(Messages.meditate(revealedStone) + ' (Ï†ÑÏ≤¥ Í≥µÍ∞ú)');
                
                        const icon = SpellIcons[revealedStone] || '‚ùì';
                        await showModal('üí§ Î™ÖÏÉÅ', `ÎπÑÎ∞Ä Ï£ºÎ¨∏ [${icon}${revealedStone}]${getJosa(revealedStone.toString(), 'Ïù¥/Í∞Ä')} Ï†ÑÏ≤¥ Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        const message = 'Î™ÖÏÉÅ Ï¢ÖÎ£å: Îçî Ïù¥ÏÉÅ Í≥µÍ∞úÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.';
                console.log('üí§ Îçî Ïù¥ÏÉÅ Í≥µÍ∞úÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÏóÜÏùå');
                        addLog(message);
                        await showModal('üí§ Î™ÖÏÉÅ', message);
                    }
        }

        async function executeHealPotion(player, opponent) {
                    console.log('üß™ ÏÉùÎ™Ö Î¨ºÏïΩ Ìö®Í≥º Ïã§Ìñâ');
            if (player.health < GAME_CONFIG.maxHealth) player.health++;
                    console.log(`üíö ÏÉùÎ™Ö Î¨ºÏïΩ ÌöåÎ≥µ: ${player.name} Ï≤¥Î†• ${player.health}`);
                    playHealSound();
                    showHealEffect(player.id === 1 ? myArea : opponentArea, 1);
            addLog(Messages.heal(player.name, 1));
            
            // ÏÉùÎ™Ö Î¨ºÏïΩ Í≤∞Í≥º ÌåùÏóÖ ÌëúÏãú
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            if (player.id === myPlayerId) {
                await showModal('üß™ ÏÉùÎ™Ö Î¨ºÏïΩ', `Ï≤¥Î†•Ïù¥ 1 ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§.<br>ÌòÑÏû¨ Ï≤¥Î†•: ${player.health}`);
            } else {
                await showModal('üß™ ÏÉùÎ™Ö Î¨ºÏïΩ', `${player.name}Ïùò Ï≤¥Î†•Ïù¥ 1 ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§.<br>ÌòÑÏû¨ Ï≤¥Î†•: ${player.health}`);
            }
        }

        async function executeFireArrow(player, opponent) {
                    opponent.health--;
                    console.log(`üî• ÌôîÏóº ÌôîÏÇ¥: ÌîºÌï¥ 1`);
                    playDamageSound();
                    showDamageEffect(opponent.id === 1 ? myArea : opponentArea, 1);
            addLog(Messages.damage(opponent.name, 1));
            
            // ÌôîÏóº ÌôîÏÇ¥ Í≤∞Í≥º ÌåùÏóÖ ÌëúÏãú
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            if (opponent.id === myPlayerId) {
                await showModal('üî• ÌôîÏóº ÌôîÏÇ¥', `Ï≤¥Î†•Ïù¥ 1 Í∞êÏÜåÌñàÏäµÎãàÎã§.<br>ÌòÑÏû¨ Ï≤¥Î†•: ${opponent.health}`);
            } else {
                await showModal('üî• ÌôîÏóº ÌôîÏÇ¥', `${opponent.name}Ïùò Ï≤¥Î†•Ïù¥ 1 Í∞êÏÜåÌñàÏäµÎãàÎã§.<br>ÌòÑÏû¨ Ï≤¥Î†•: ${opponent.health}`);
            }
        }

        async function executeMindControl(player, opponent, playerId) {
                    console.log('üåÄ Ï†ïÏã† ÍµêÎûÄ Ìö®Í≥º Ïã§Ìñâ');
                    if (state.secretStones.length > 0) {
                        const spyStone = state.secretStones.splice(0, 1)[0];
                        opponent.hand.push(spyStone);
                        opponent.hand.sort((a, b) => a - b);
                        console.log(`üåÄ Ï†ïÏã† ÍµêÎûÄ Ìà¨ÏûÖ: ${spyStone}ÏùÑ(Î•º) ${opponent.name}Ïùò Ìå®Ïóê Ìà¨ÏûÖ`);
                        playCardSound();
                        
                        const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                addLog(Messages.spy(player.name));
                
                        if (playerId === myPlayerId) {
                            await showModal('üåÄ Ï†ïÏã† ÍµêÎûÄ', `ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÌïòÎÇòÎ•º ÏÉÅÎåÄÏùò Ìå®Ïóê Ï∂îÍ∞ÄÌñàÏäµÎãàÎã§.`);
                        } else {
                            await showModal('üåÄ Ï†ïÏã† ÍµêÎûÄ', `ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÌïòÎÇòÍ∞Ä Ìå®Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`);
                        }
                    } else {
                        console.log('‚ùå Ìà¨ÏûÖÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÏóÜÏùå');
                        addLog(`Ï†ïÏã† ÍµêÎûÄ Ï¢ÖÎ£å: Ìà¨ÏûÖÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.`);
                        await showModal('üåÄ Ï†ïÏã† ÍµêÎûÄ', 'Ìà¨ÏûÖÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.');
                    }
        }

        async function executeManaDrain(player, opponent) {
                    opponent.health--;
            if (player.health < GAME_CONFIG.maxHealth) player.health++;
                    console.log(`üí´ ÎßàÎ†• Ï∞©Ï∑®: ${opponent.name} Ï≤¥Î†• ${opponent.health}, ${player.name} Ï≤¥Î†• ${player.health}`);
                    playDamageSound();
                    playHealSound();
                    showDamageEffect(opponent.id === 1 ? myArea : opponentArea, 1);
                    showHealEffect(player.id === 1 ? myArea : opponentArea, 1);
            addLog(Messages.damage(opponent.name, 1) + ' + ' + Messages.heal(player.name, 1));
            
            // ÎßàÎ†• Ï∞©Ï∑® Í≤∞Í≥º ÌåùÏóÖ ÌëúÏãú
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            if (player.id === myPlayerId) {
                await showModal('üí´ ÎßàÎ†• Ï∞©Ï∑®', `ÏÉÅÎåÄÏùò Ï≤¥Î†•ÏùÑ Ìù°ÏàòÌïòÏó¨ ÌöåÎ≥µÌñàÏäµÎãàÎã§.<br>ÏÉÅÎåÄ Ï≤¥Î†•: ${opponent.health}<br>ÎÇ¥ Ï≤¥Î†•: ${player.health}`);
            } else if (opponent.id === myPlayerId) {
                await showModal('üí´ ÎßàÎ†• Ï∞©Ï∑®', `Ï≤¥Î†•Ïù¥ Ìù°ÏàòÎêòÏñ¥ Í∞êÏÜåÌñàÏäµÎãàÎã§.<br>ÌòÑÏû¨ Ï≤¥Î†•: ${opponent.health}`);
            } else {
                await showModal('üí´ ÎßàÎ†• Ï∞©Ï∑®', `${opponent.name}Ïùò Ï≤¥Î†•Ïù¥ 1 Í∞êÏÜåÌïòÍ≥†, ${player.name}Ïùò Ï≤¥Î†•Ïù¥ 1 ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§.`);
            }
        }

        async function executeDestinyChange(player, opponent) {
                    console.log('üîÆ Ïö¥Î™Ö Î≥ÄÌôò Ìö®Í≥º Ïã§Ìñâ');
                    const toRevealCount = Math.min(3, state.secretStones.length);
                    if (toRevealCount > 0) {
                        const revealedStones = state.secretStones.splice(0, toRevealCount);
                
                // ÌîåÎ†àÏù¥Ïñ¥Î≥Ñ Í∞úÏù∏ Í≥µÍ∞ú Ï£ºÎ¨∏ÏúºÎ°ú Ï∂îÍ∞Ä
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                if (player.id === myPlayerId) {
                    // ÎÇ¥Í∞Ä ÏÇ¨Ïö©Ìïú Í≤ΩÏö∞ - ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú
                    if (!state.personalRevealedStones) {
                        state.personalRevealedStones = [];
                    }
                    state.personalRevealedStones.push(...revealedStones);
                    console.log(`üîÆ ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏: [${revealedStones.join(', ')}]`);
                    addLog(Messages.reveal(revealedStones) + ' (ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú)');
                        
                        // Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§Ïùò ÏïÑÏù¥ÏΩòÍ≥º Ìï®Íªò ÌåùÏóÖ ÌëúÏãú
                        const revealedIcons = revealedStones.map(stone => `${SpellIcons[stone] || '‚ùì'}${stone}`).join(', ');
                    await showModal('üîÆ Ïö¥Î™Ö Î≥ÄÌôò', `ÎπÑÎ∞Ä Ï£ºÎ¨∏ [${revealedIcons}]${getJosa(revealedStones.length.toString(), 'Ïù¥/Í∞Ä')} ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§.`);
                } else {
                    // ÏÉÅÎåÄÍ∞Ä ÏÇ¨Ïö©Ìïú Í≤ΩÏö∞ - ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞ú (ÎÇòÎäî Ï†ïÎ≥¥Î•º Î≥º Ïàò ÏóÜÏùå)
                    if (!state.opponentPersonalRevealedStones) {
                        state.opponentPersonalRevealedStones = [];
                    }
                    state.opponentPersonalRevealedStones.push(...revealedStones);
                    console.log(`üîÆ ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏: [${revealedStones.join(', ')}]`);
                    addLog(Messages.reveal(revealedStones) + ' (ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞ú)');
                    
                    await showModal('üîÆ Ïö¥Î™Ö Î≥ÄÌôò', `ÏÉÅÎåÄÍ∞Ä ÎπÑÎ∞Ä Ï£ºÎ¨∏ ${revealedStones.length}Í∞úÎ•º ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÌñàÏäµÎãàÎã§.`);
                }
                
                // ÌÉÄÏù¥Î®∏ Ï¥àÍ∏∞Ìôî Í∏∞Îä• Ï†úÍ±∞Îê®
                    } else {
                        await showModal('üîÆ Ïö¥Î™Ö Î≥ÄÌôò', 'Í≥µÍ∞úÌï† ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.');
                    }
        }

        // Ï£ºÎ¨∏ Ìö®Í≥º Ïã§Ìñâ Ìï®Ïàò
        async function executeSpellEffect(playerId, spellNumber) {
            console.log(`‚ú® ÏòÅÏ∞Ω Ìö®Í≥º Ïã§Ìñâ: ÌîåÎ†àÏù¥Ïñ¥ ${playerId}, ÏòÅÏ∞Ω ${spellNumber}`);
            
            if (!GameConditions.isGameValid()) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ ÏòÅÏ∞Ω Ìö®Í≥º Ïã§ÌñâÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            const player = state.players.find(p => p.id === playerId);
            const opponent = state.players.find(p => p.id !== playerId);
            
            if (!player || !opponent) {
                console.log('‚ö†Ô∏è ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ ÏòÅÏ∞Ω Ìö®Í≥º Ïã§ÌñâÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            const spellEffects = {
                6: () => executeMeditation(player, opponent),
                5: () => executeHealPotion(player, opponent),
                4: () => executeFireArrow(player, opponent),
                3: () => executeMindControl(player, opponent, playerId),
                2: () => executeManaDrain(player, opponent),
                1: () => executeDestinyChange(player, opponent)
            };
            
            const effect = spellEffects[spellNumber];
            if (effect) {
                await effect();
            }
            
            render();
            await sleep(1000);
            checkGameOver();
            
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            if (state.currentPlayerId === myPlayerId && state.isPlayerTurn) {
                setTimeout(() => {
                    enableSpellButtons();
                }, 500);
            }
        }

        // AI ÌÑ¥ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function getAIName() {
            return multiplayerMode ? state.players[1].name : 
                   (aiDifficulty === 'easy' ? 'ü§ñ Ïâ¨ÏõÄ ÌóàÏàòÏïÑÎπÑ' : 
                    aiDifficulty === 'normal' ? 'ü§ñ Î≥¥ÌÜµ ÌóàÏàòÏïÑÎπÑ' : 'ü§ñ Ïñ¥Î†§ÏõÄ ÌóàÏàòÏïÑÎπÑ');
        }

        function getCastableSpells(ai) {
            if (!ai || !ai.hand) {
                console.warn('‚ö†Ô∏è getCastableSpells: ai Í∞ùÏ≤¥Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå');
                return [];
            }
            return ai.hand.filter(s => s >= state.lastSuccessfulSpell);
        }

        /**
         * AI ÌÑ¥ Ïã§Ìñâ (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
         * @param {Object} ai - AI ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥
         * @param {Object} player - Ïù∏Í∞Ñ ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥
         * @returns {Promise<boolean>} ÌÑ¥ Ïã§Ìñâ Í≤∞Í≥º
         */
        async function executeAITurn(ai, player) {
            const opponentName = getAIName();
            console.log(`ü§ñ ${opponentName} ÌÑ¥ ÏãúÏûë`);
            
            // AI Ï£ºÎ¨∏ ÏÑ†ÌÉù (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
            const castableSpells = getCastableSpells(ai);
            if (castableSpells.length === 0) {
                console.log(`‚ùå ${opponentName} ÏãúÏ†Ñ Í∞ÄÎä•Ìïú Ï£ºÎ¨∏Ïù¥ ÏóÜÏùå`);
                return false;
            }
            
            // ÏÉàÎ°úÏö¥ ÏßÄÎä•Ï†Å AI Ï£ºÎ¨∏ ÏÑ†ÌÉù ÏãúÏä§ÌÖú ÏÇ¨Ïö©
            const chosenSpell = chooseAISpell(castableSpells, ai, player);
            console.log(`üéØ ${opponentName} ÏÑ†ÌÉùÌïú Ï£ºÎ¨∏: ${chosenSpell}Î≤à`);
            
            // AI ÏòÅÏ∞Ω Ïã§Ìñâ
            return await executeAISpell(ai, player, chosenSpell, opponentName);
        }

        async function executeAISpell(ai, player, chosenSpell, opponentName) {
            // ÏÉàÎ°úÏö¥ AI ÏòÅÏ∞Ω ÏãúÏä§ÌÖú
            const successRate = getAISuccessRate();
            const randomValue = Math.random();
            const isSuccess = randomValue < successRate;
            
            console.log(`ü§ñ AI ÏòÅÏ∞Ω ÏãúÏä§ÌÖú: ÏÑ†ÌÉùÏ£ºÎ¨∏=${chosenSpell}, ÏÜêÌå®=${ai.hand}, ÏÑ±Í≥µÎ•†=${(successRate * 100).toFixed(1)}%, ÎûúÎç§Í∞í=${randomValue.toFixed(3)}, ÏÑ±Í≥µÏó¨Î∂Ä=${isSuccess}`);
            
            if (isSuccess) {
                // ÏÑ±Í≥µ Ïãú: ÏÜêÌå®ÏóêÏÑú Ìï¥Îãπ Ï£ºÎ¨∏ÏùÑ Ïã§Ï†úÎ°ú ÏòÅÏ∞Ω
                const handIndex = ai.hand.indexOf(chosenSpell);
                if (handIndex > -1) {
                    return await handleAISpellSuccess(ai, chosenSpell, opponentName);
                } else {
                    // ÏÜêÌå®Ïóê Ìï¥Îãπ Ï£ºÎ¨∏Ïù¥ ÏóÜÎäî Í≤ΩÏö∞ (Ïù¥Î°†Ï†ÅÏúºÎ°úÎäî Î∞úÏÉùÌïòÏßÄ ÏïäÏïÑÏïº Ìï®)
                    console.log(`‚ö†Ô∏è AI ÏÑ±Í≥µÌñàÏßÄÎßå ÏÜêÌå®Ïóê ${chosenSpell}Î≤àÏù¥ ÏóÜÏùå - Ïã§Ìå® Ï≤òÎ¶¨`);
                    return await handleAISpellFailure(ai, chosenSpell, opponentName);
                }
            } else {
                // Ïã§Ìå® Ïãú: ÏÜêÌå®Ïóê ÏóÜÎäî Ï£ºÎ¨∏ÏùÑ ÏòÅÏ∞ΩÌïòÎ†§Í≥† ÏãúÎèÑ
                const availableSpells = [1, 2, 3, 4, 5, 6];
                const missingSpells = availableSpells.filter(spell => !ai.hand.includes(spell));
                
                if (missingSpells.length > 0) {
                    // ÏÜêÌå®Ïóê ÏóÜÎäî Ï£ºÎ¨∏ Ï§ë ÌïòÎÇòÎ•º ÏÑ†ÌÉù
                    const failedSpell = missingSpells[Math.floor(Math.random() * missingSpells.length)];
                    console.log(`‚ùå AI Ïã§Ìå®: ${chosenSpell}Î≤à ÎåÄÏã† ${failedSpell}Î≤àÏùÑ ÏòÅÏ∞ΩÌïòÎ†§Í≥† ÏãúÎèÑ (ÏÜêÌå®Ïóê ÏóÜÏùå)`);
                    return await handleAISpellFailure(ai, failedSpell, opponentName);
                } else {
                    // Î™®Îì† Ï£ºÎ¨∏Ïù¥ ÏÜêÌå®Ïóê ÏûàÎäî Í≤ΩÏö∞ (Ïù¥Î°†Ï†ÅÏúºÎ°úÎäî 100% ÏÑ±Í≥µÌï¥Ïïº Ìï®)
                    console.log(`‚ö†Ô∏è AI ÏÜêÌå®Ïóê Î™®Îì† Ï£ºÎ¨∏Ïù¥ ÏûàÏùå - ÏÑ±Í≥µ Ï≤òÎ¶¨`);
                    return await handleAISpellSuccess(ai, chosenSpell, opponentName);
                }
            }
        }

        async function handleAISpellSuccess(ai, chosenSpell, opponentName) {
            const castedStone = ai.hand.splice(ai.hand.indexOf(chosenSpell), 1)[0];
                    state.usedStones.push(castedStone);
                    console.log(`‚úÖ ${opponentName} ÏòÅÏ∞Ω ÏÑ±Í≥µ: ${chosenSpell}Î≤à (ÏÇ¨Ïö©Îêú Ï£ºÎ¨∏: ${castedStone})`);
                    
                    playSuccessSound();
                    addSuccessAnimation(opponentArea);
                    
                    // AI ÏòÅÏ∞Ω ÏÑ±Í≥µ ÌååÌã∞ÌÅ¥ Ìö®Í≥º
                    createModalParticles(chosenSpell);
                    
            addLog(Messages.spellSuccess(opponentName, chosenSpell));
                    render();
            
                    await executeSpellEffect(2, chosenSpell);
                    state.lastSuccessfulSpell = chosenSpell;
                    
            if (GameConditions.isMultiplayerConnected()) {
                        dataChannel.send(JSON.stringify({
                            type: 'cardPlayed',
                            card: chosenSpell,
                            playerId: 2,
                            gameState: state
                        }));
                    }
                    
            return true;
        }

        async function handleAISpellFailure(ai, chosenSpell, opponentName) {
                    const currentPlayer = state.players.find(p => p.id === state.currentPlayerId);
                    currentPlayer.health--;
                    console.log(`‚ùå ${opponentName} ÏòÅÏ∞Ω Ïã§Ìå®: ${chosenSpell}Î≤à (ÌîåÎ†àÏù¥Ïñ¥ ${currentPlayer.id} Ï≤¥Î†•: ${currentPlayer.health})`);
                    
                    playFailureSound();
                    addFailureAnimation(opponentArea);
                    showDamageEffect(opponentArea, 1);
                    
                    // AI ÏòÅÏ∞Ω Ïã§Ìå® Ïãú Ï¶âÏãú Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                    spellButtonsDisabled = true;
                    state.spellFailed = true; // ÏòÅÏ∞Ω Ïã§Ìå® ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                    disableSpellButtons();
                    
                    // ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäºÎèÑ Ï¶âÏãú ÎπÑÌôúÏÑ±Ìôî
                    endTurnBtn.disabled = true;
                    endTurnBtn.style.opacity = '0.5';
                    endTurnBtn.style.cursor = 'not-allowed';
                    
                    // AI ÏòÅÏ∞Ω Ïã§Ìå® ÌåùÏóÖ ÌëúÏãú
                    await showModal('ÏòÅÏ∞Ω Ïã§Ìå®', `${opponentName} ${chosenSpell}Î≤à Ï£ºÎ¨∏ ÏòÅÏ∞Ω Ïã§Ìå®<br>Ï≤¥Î†• -1 (ÌòÑÏû¨: ${currentPlayer.health})`);
                    
                    addLog(Messages.spellFailure(opponentName, chosenSpell));
                    
                    // Í≤åÏûÑ Î°úÍ∑∏Îßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† Î≤ÑÌäº ÏÉÅÌÉúÎäî Ïú†ÏßÄ
                    const gameLogEl = DOM.get('game-log');
                    if (gameLogEl) {
                        gameLogEl.innerHTML = state.gameLog.map(log => {
                            const isSuccess = log.includes('‚úÖ');
                            const isFailure = log.includes('‚ùå');
                            const isTurn = log.includes('ÌÑ¥');
                            const isGameEnd = log.includes('Í≤åÏûÑ Ï¢ÖÎ£å');
                            
                            let className = '';
                            if (isSuccess) className = 'text-green-400';
                            else if (isFailure) className = 'text-red-400';
                            else if (isTurn) className = 'text-blue-400 font-bold';
                            else if (isGameEnd) className = 'text-purple-400 font-bold';
                            
                            return `<p class="${className}">${log}</p>`;
                        }).join('');
                    }
                    
            if (GameConditions.isMultiplayerConnected()) {
                        dataChannel.send(JSON.stringify({
                            type: 'spellPlayed',
                            spell: chosenSpell,
                            playerId: 2,
                            gameState: state
                        }));
                    }
                    
            return false;
        }

        /**
         * AI Ïó∞ÏÜç ÏòÅÏ∞Ω Í≤∞Ï†ï (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
         * @param {Object} ai - AI ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥
         * @param {string} opponentName - AI Ïù¥Î¶Ñ
         * @returns {boolean} Ïó∞ÏÜç ÏòÅÏ∞Ω Ïó¨Î∂Ä
         */
        function shouldAIContinue(ai, opponentName) {
            const gameState = AIAnalysis.analyzeGameState();
            if (!gameState) {
                // Î∂ÑÏÑù Î∂àÍ∞ÄÎä•Ìïú Í≤ΩÏö∞ Í∏∞Î≥∏ Î°úÏßÅ ÏÇ¨Ïö©
            const continueTurn = ai.hand.length > 0 && Math.random() < getAIContinueRate();
                console.log(`ü§ñ ${opponentName} Ïó∞ÏÜç ÏòÅÏ∞Ω Í≤∞Ï†ï (Í∏∞Î≥∏): ${continueTurn ? 'Í≥ÑÏÜç' : 'Ï§ëÎã®'}`);
            if (!continueTurn) {
                addLog(`${opponentName}${getJosa(opponentName, 'Ïù¥/Í∞Ä')} Ïó∞ÏÜç ÏòÅÏ∞ΩÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.`);
            }
                return continueTurn;
            }
            
            // ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò Ïó∞ÏÜç ÏòÅÏ∞Ω Í≤∞Ï†ï
            const baseContinueRate = getAIContinueRate();
            const analysisRate = AIAnalysis.evaluateSpellCastability(
                Math.max(...ai.hand.filter(s => s > state.lastSuccessfulSpell)), 
                gameState
            );
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Í∞ÄÏ§ëÏπò Ï†ÅÏö©
            const weights = {
                easy: 0.3,    // Ïâ¨ÏõÄ: Í∏∞Î≥∏ ÌôïÎ•† 70%, Î∂ÑÏÑù 30%
                normal: 0.6,  // Î≥¥ÌÜµ: Í∏∞Î≥∏ ÌôïÎ•† 40%, Î∂ÑÏÑù 60%
                hard: 0.8     // Ïñ¥Î†§ÏõÄ: Í∏∞Î≥∏ ÌôïÎ•† 20%, Î∂ÑÏÑù 80%
            };
            
            const weight = weights[aiDifficulty] || 0.6;
            const finalRate = baseContinueRate * (1 - weight) + analysisRate * weight;
            
            const continueTurn = ai.hand.length > 0 && Math.random() < finalRate;
            
            console.log(`ü§ñ ${opponentName} Ïó∞ÏÜç ÏòÅÏ∞Ω Í≤∞Ï†ï (ÏßÄÎä•Ï†Å): ${continueTurn ? 'Í≥ÑÏÜç' : 'Ï§ëÎã®'} (Í∏∞Î≥∏: ${(baseContinueRate * 100).toFixed(1)}%, Î∂ÑÏÑù: ${(analysisRate * 100).toFixed(1)}%, ÏµúÏ¢Ö: ${(finalRate * 100).toFixed(1)}%)`);
            
            if (!continueTurn) {
                addLog(`${opponentName}${getJosa(opponentName, 'Ïù¥/Í∞Ä')} Ïó∞ÏÜç ÏòÅÏ∞ΩÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.`);
            }
            
            return continueTurn;
        }

        async function aiTurn() {
            if (!GameConditions.isGameValid()) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ AI ÌÑ¥ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
                return;
            }
            
            const ai = state.players[1];
            const player = state.players[0];
            const opponentName = getAIName();
            
            // AI Î∂ÑÏÑù Ï†ïÎ≥¥ Ï∂úÎ†•
            const gameState = AIAnalysis.analyzeGameState();
            if (gameState) {
                console.log(`üß† ${opponentName} Î∂ÑÏÑù Ï†ïÎ≥¥:`, {
                    ÎÇúÏù¥ÎèÑ: aiDifficulty,
                    AIÏÜêÌå®: ai.hand,
                    ÌîåÎ†àÏù¥Ïñ¥ÏÜêÌå®: gameState.humanHand,
                    Í≥µÍ∞úÎêúÎπÑÎ∞ÄÏ£ºÎ¨∏: gameState.secretStones,
                    ÏÇ¨Ïö©ÎêúÏ£ºÎ¨∏: gameState.usedStones,
                    AIÏ≤¥Î†•: gameState.aiHealth,
                    ÌîåÎ†àÏù¥Ïñ¥Ï≤¥Î†•: gameState.humanHealth,
                    ÎßàÏßÄÎßâÏÑ±Í≥µÏ£ºÎ¨∏: gameState.lastSuccessfulSpell
                });
            }
            
            console.log(`ü§ñ ${opponentName} ÌÑ¥ ÏãúÏûë (ÎÇúÏù¥ÎèÑ: ${aiDifficulty}, ÏÜêÌå®: ${ai.hand})`);
            addLog(Messages.turnStart(opponentName));
            state.turnInProgress = true;
            updateButtons();

            let continueTurn = true;
            while(continueTurn && !state.isGameOver) {
                await sleep(1500);
                
                const castableSpells = getCastableSpells(ai);
                
                console.log(`ü§ñ AI Í∞ÄÎä•Ìïú ÏòÅÏ∞Ω: [${castableSpells.join(', ')}] (ÎßàÏßÄÎßâ ÏÑ±Í≥µ: ${state.lastSuccessfulSpell})`);

                if (castableSpells.length === 0) {
                    console.log(`ü§ñ ${opponentName} Ïã§Ìñâ Í∞ÄÎä•Ìïú ÏòÅÏ∞Ω ÏóÜÏùå`);
                    addLog(`${opponentName}${getJosa(opponentName, 'Ïù¥/Í∞Ä')} ÏãúÏ†ÑÌï† Ïàò ÏûàÎäî ÏòÅÏ∞ΩÏù¥ ÏóÜÏäµÎãàÎã§.`);
                    break;
                }

                const chosenSpell = chooseAISpell(castableSpells, ai, player);
                console.log(`ü§ñ AI ÏÑ†ÌÉùÌïú ÏòÅÏ∞Ω: ${chosenSpell} (ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†•: ${player.health}, AI Ï≤¥Î†•: ${ai.health})`);
                
                const success = await executeAISpell(ai, player, chosenSpell, opponentName);
                
                if (checkGameOver()) break;
                
                if (success) {
                    continueTurn = shouldAIContinue(ai, opponentName);
                } else {
                    continueTurn = false;
                }
            }
            
            state.turnInProgress = false;
            endTurn();
        }
        
        // AI ÏòÅÏ∞Ω ÏÑ†ÌÉù Ìï®Ïàò (ÎÇúÏù¥ÎèÑÎ≥Ñ)
        function chooseAISpell(castableSpells, ai, player) {
            const aiStrategies = {
                easy: chooseEasyAISpell,
                normal: chooseNormalAISpell,
                hard: chooseHardAISpell
            };
            
            const strategy = aiStrategies[aiDifficulty] || chooseNormalAISpell;
            return strategy(castableSpells, ai, player);
        }
        
        // Ïâ¨Ïö¥ AI ÏòÅÏ∞Ω ÏÑ†ÌÉù
        function chooseEasyAISpell(castableSpells, ai, player) {
            // ÎûúÎç§ÌïòÍ≤å ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Í∞ÑÎã®Ìïú Í∑úÏπôÎßå ÏÇ¨Ïö©
            if (Math.random() < 0.3) {
                return castableSpells[Math.floor(Math.random() * castableSpells.length)];
            }
            
            // Í∏∞Î≥∏Ï†ÅÏù∏ Í∑úÏπôÎßå Ï†ÅÏö©
            if (castableSpells.includes(4) && player.health <= 1) return 4;
            if (castableSpells.includes(5) && ai.health <= 2) return 5;
            
            return Math.max(...castableSpells);
        }
        
        // Î≥¥ÌÜµ AI ÏòÅÏ∞Ω ÏÑ†ÌÉù (Í∏∞Ï°¥ Î°úÏßÅ)
        function chooseNormalAISpell(castableSpells, ai, player) {
            if (castableSpells.includes(4) && player.health <= (state.lastSuccessfulSpell > 0 ? 2 : 1)) return 4;
            if (castableSpells.includes(2) && player.health <= 1) return 2;
            if (castableSpells.includes(5) && player.health <= 1) return 5;
            if (ai.health <= 2 && castableSpells.includes(1)) return 1;
            if (ai.health <= 2 && castableSpells.includes(2)) return 2;
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            return Math.max(...castableSpells);
        }
        
        /**
         * AI Ï£ºÎ¨∏ ÏÑ†ÌÉù ÏãúÏä§ÌÖú (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
         * @param {Array} castableSpells - ÏãúÏ†Ñ Í∞ÄÎä•Ìïú Ï£ºÎ¨∏Îì§
         * @param {Object} ai - AI ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥
         * @param {Object} player - Ïù∏Í∞Ñ ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥
         * @returns {number} ÏÑ†ÌÉùÎêú Ï£ºÎ¨∏ Î≤àÌò∏
         */
        function chooseAISpell(castableSpells, ai, player) {
            const gameState = AIAnalysis.analyzeGameState();
            if (!gameState) {
                // Î∂ÑÏÑù Î∂àÍ∞ÄÎä•Ìïú Í≤ΩÏö∞ Í∏∞Î≥∏ Î°úÏßÅ ÏÇ¨Ïö©
                return chooseBasicAISpell(castableSpells, ai, player);
            }
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Ï†ÑÎûµ Ï†ÅÏö©
            switch (aiDifficulty) {
                case 'easy':
                    return chooseEasyAISpell(castableSpells, ai, player, gameState);
                case 'normal':
                    return chooseNormalAISpell(castableSpells, ai, player, gameState);
                case 'hard':
                    return chooseHardAISpell(castableSpells, ai, player, gameState);
                default:
                    return chooseNormalAISpell(castableSpells, ai, player, gameState);
            }
        }
        
        /**
         * Ïâ¨Ïö¥ AI Ï£ºÎ¨∏ ÏÑ†ÌÉù (Í∏∞Î≥∏ Î°úÏßÅ + ÏïΩÍ∞ÑÏùò Î∂ÑÏÑù)
         */
        function chooseEasyAISpell(castableSpells, ai, player, gameState) {
            // Í∏∞Î≥∏ Ï†ÑÎûµ (Ï≤¥Î†• Í∏∞Î∞ò)
            if (player.health <= 2 && castableSpells.includes(4)) return 4;
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            // ÏïΩÍ∞ÑÏùò Î∂ÑÏÑù Ï†ÅÏö© (30% ÌôïÎ•†Î°ú)
            if (Math.random() < 0.3) {
                const bestSpell = findBestSpellByAnalysis(castableSpells, gameState);
                if (bestSpell) return bestSpell;
            }
            
            // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÎûúÎç§ ÏÑ†ÌÉù
            return castableSpells[Math.floor(Math.random() * castableSpells.length)];
        }
        
        /**
         * Î≥¥ÌÜµ AI Ï£ºÎ¨∏ ÏÑ†ÌÉù (Î∂ÑÏÑù + Ï†ÑÎûµ)
         */
        function chooseNormalAISpell(castableSpells, ai, player, gameState) {
            // Ï≤¥Î†• Í∏∞Î∞ò Ï†ÑÎûµ
            if (player.health <= 2 && castableSpells.includes(4)) return 4;
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            // Ï†ïÎ≥¥ ÏàòÏßë (ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÎßéÏùÑ Îïå)
            if (castableSpells.includes(6) && gameState.secretStones.length > 2) return 6;
            
            // Î∂ÑÏÑù Í∏∞Î∞ò ÏÑ†ÌÉù (70% ÌôïÎ•†)
            if (Math.random() < 0.7) {
                const bestSpell = findBestSpellByAnalysis(castableSpells, gameState);
                if (bestSpell) return bestSpell;
            }
            
            // Ï†ÑÎûµÏ†Å ÏÑ†ÌÉù
            return chooseStrategicSpell(castableSpells, ai, player);
        }
        
        /**
         * Ïñ¥Î†§Ïö¥ AI Ï£ºÎ¨∏ ÏÑ†ÌÉù (Ï†ïÌôïÌïú Î∂ÑÏÑù + Í≥†Í∏â Ï†ÑÎûµ)
         */
        function chooseHardAISpell(castableSpells, ai, player, gameState) {
            // Ï≤¥Î†• Í∏∞Î∞ò Ï†ÑÎûµ
            if (player.health <= 2 && castableSpells.includes(4)) return 4;
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            // Ï†ïÎ≥¥ ÏàòÏßë (Ìï≠ÏÉÅ Ïö∞ÏÑ†)
            if (castableSpells.includes(6) && gameState.secretStones.length > 0) return 6;
            
            // Ï†ïÌôïÌïú Î∂ÑÏÑù Í∏∞Î∞ò ÏÑ†ÌÉù (90% ÌôïÎ•†)
            if (Math.random() < 0.9) {
                const bestSpell = findBestSpellByAnalysis(castableSpells, gameState);
                if (bestSpell) return bestSpell;
            }
            
            // Í≥†Í∏â Ï†ÑÎûµ
            return chooseAdvancedStrategicSpell(castableSpells, ai, player, gameState);
        }
        
        /**
         * Î∂ÑÏÑù Í∏∞Î∞ò ÏµúÏ†Å Ï£ºÎ¨∏ Ï∞æÍ∏∞
         */
        function findBestSpellByAnalysis(castableSpells, gameState) {
            let bestSpell = null;
            let bestScore = -1;
            
            for (const spell of castableSpells) {
                const probability = AIAnalysis.evaluateSpellCastability(spell, gameState);
                const strategicScore = calculateStrategicScore(spell, gameState);
                const totalScore = probability * 0.7 + strategicScore * 0.3;
                
                if (totalScore > bestScore) {
                    bestScore = totalScore;
                    bestSpell = spell;
                }
            }
            
            return bestSpell;
        }
        
        /**
         * Ï£ºÎ¨∏Ïùò Ï†ÑÎûµÏ†Å Ï†êÏàò Í≥ÑÏÇ∞
         */
        function calculateStrategicScore(spell, gameState) {
            const { aiHealth, humanHealth } = gameState;
            
            switch (spell) {
                case 1: // Ïö¥Î™Ö Î≥ÄÌôò - Ï†ïÎ≥¥ ÏàòÏßë
                    return gameState.secretStones.length > 2 ? 0.8 : 0.3;
                case 2: // ÎßàÎ†• Ï∞©Ï∑® - Í∑†Ìòï
                    return (humanHealth > aiHealth) ? 0.9 : 0.5;
                case 3: // Ï†ïÏã† ÍµêÎûÄ - ÍµêÎûÄ
                    return gameState.secretStones.length > 0 ? 0.7 : 0.2;
                case 4: // ÌôîÏóº ÌôîÏÇ¥ - Í≥µÍ≤©
                    return humanHealth <= 2 ? 0.9 : 0.6;
                case 5: // ÏÉùÎ™Ö Î¨ºÏïΩ - ÌöåÎ≥µ
                    return aiHealth <= 2 ? 0.9 : 0.4;
                case 6: // Î™ÖÏÉÅ - Ï†ïÎ≥¥
                    return gameState.secretStones.length > 0 ? 0.8 : 0.3;
                default:
                    return 0.5;
            }
        }
        
        /**
         * Í∏∞Î≥∏ Ï†ÑÎûµÏ†Å Ï£ºÎ¨∏ ÏÑ†ÌÉù
         */
        function chooseStrategicSpell(castableSpells, ai, player) {
            // Í≥µÍ≤© Ïö∞ÏÑ†
            if (castableSpells.includes(4) && player.health <= 2) return 4;
            if (castableSpells.includes(2) && player.health <= 2) return 2;
            
            // ÌöåÎ≥µ Ïö∞ÏÑ†
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            // Ï†ïÎ≥¥ ÏàòÏßë
            if (castableSpells.includes(6) && state.secretStones.length > 0) return 6;
            
            // ÍµêÎûÄ
            if (castableSpells.includes(3) && state.secretStones.length > 0) return 3;
            
            return Math.max(...castableSpells);
        }
        
        /**
         * Í≥†Í∏â Ï†ÑÎûµÏ†Å Ï£ºÎ¨∏ ÏÑ†ÌÉù
         */
        function chooseAdvancedStrategicSpell(castableSpells, ai, player, gameState) {
            // Ï≤¥Î†• Ï∞®Ïù¥ Î∂ÑÏÑù
            const healthDiff = ai.health - player.health;
            
            // AIÍ∞Ä Ïú†Î¶¨Ìïú ÏÉÅÌô©
            if (healthDiff > 1) {
                // Í≥µÍ≤©ÏúºÎ°ú ÏäπÎ¶¨ ÌôïÏ†ï
                if (castableSpells.includes(4) && player.health <= 2) return 4;
                if (castableSpells.includes(2) && player.health <= 2) return 2;
            }
            
            // AIÍ∞Ä Î∂àÎ¶¨Ìïú ÏÉÅÌô©
            if (healthDiff < -1) {
                // ÌöåÎ≥µ Ïö∞ÏÑ†
                if (castableSpells.includes(5) && ai.health <= 2) return 5;
                // Ï†ïÎ≥¥ ÏàòÏßëÏúºÎ°ú Ïó≠Ï†Ñ Í∏∞Ìöå Î™®ÏÉâ
                if (castableSpells.includes(6) && gameState.secretStones.length > 0) return 6;
            }
            
            // Í∑†Ìòï ÏÉÅÌô©
            if (castableSpells.includes(2)) return 2; // ÎßàÎ†• Ï∞©Ï∑®Î°ú Í∑†Ìòï Ïú†ÏßÄ
            if (castableSpells.includes(6) && gameState.secretStones.length > 0) return 6; // Ï†ïÎ≥¥ ÏàòÏßë
            
            return Math.max(...castableSpells);
        }
        
        /**
         * Í∏∞Î≥∏ AI Ï£ºÎ¨∏ ÏÑ†ÌÉù (Í∏∞Ï°¥ Î°úÏßÅ)
         */
        function chooseBasicAISpell(castableSpells, ai, player) {
            // Í≥µÍ≤© Ïö∞ÏÑ† (ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†•Ïù¥ ÎÇÆÏùÑ Îïå)
            if (castableSpells.includes(4) && player.health <= 2) return 4;
            if (castableSpells.includes(2) && player.health <= 2) return 2;
            
            // ÌöåÎ≥µ Ïö∞ÏÑ† (AI Ï≤¥Î†•Ïù¥ ÎÇÆÏùÑ Îïå)
            if (ai.health <= 2 && castableSpells.includes(1)) return 1;
            if (ai.health <= 2 && castableSpells.includes(5)) return 5;
            
            // Ï†ÑÏÑ∏ Ïó≠Ï†Ñ (ÏÉÅÌô©Ïù¥ Ï¢ãÏßÄ ÏïäÏùÑ Îïå)
            if (ai.health <= 2 && castableSpells.includes(1)) return 1;
            
            // Ï†ïÏ∞∞ ÏûëÏ†Ñ (Ï†ïÎ≥¥ ÏàòÏßë)
            if (castableSpells.includes(6) && state.secretStones.length > 0) return 6;
            
            // Ïä§ÌååÏù¥ Ìà¨ÏûÖ (ÏÉÅÎåÄ Ìå® ÍµêÎûÄ)
            if (castableSpells.includes(3) && state.secretStones.length > 0) return 3;
            
            return Math.max(...castableSpells);
        }
        
        /**
         * AI Î∂ÑÏÑù ÏãúÏä§ÌÖú
         * ÏÉÅÎåÄÏùò Ìå®ÏôÄ Í≥µÍ∞úÎêú ÎπÑÎ∞Ä Ïπ¥ÎìúÎ•º Î∂ÑÏÑùÌïòÏó¨ ÏûêÏã†Ïùò Ìå®Î•º Ïú†Ï∂î
         */
        const AIAnalysis = {
            /**
             * Í≤åÏûÑ ÏÉÅÌÉú Î∂ÑÏÑù
             * @returns {Object} Î∂ÑÏÑù Í≤∞Í≥º
             */
            analyzeGameState() {
                if (!state || !state.players) return null;
                
                const aiPlayer = state.players.find(p => p.id === 2); // AIÎäî Ìï≠ÏÉÅ ÌîåÎ†àÏù¥Ïñ¥ 2
                const humanPlayer = state.players.find(p => p.id === 1);
                
                if (!aiPlayer || !humanPlayer) return null;
                
                return {
                    aiPlayer: aiPlayer, // AI ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥ Ï†ÑÏ≤¥
                    humanPlayer: humanPlayer, // Ïù∏Í∞Ñ ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥ Ï†ÑÏ≤¥
                    aiHand: aiPlayer.hand,
                    humanHand: humanPlayer.hand,
                    secretStones: state.secretStones || [],
                    usedStones: state.usedStones || [],
                    aiHealth: aiPlayer.health,
                    humanHealth: humanPlayer.health,
                    lastSuccessfulSpell: state.lastSuccessfulSpell || 0
                };
            },
            
            /**
             * ÏÉÅÎåÄÏùò Ìå®ÏóêÏÑú ÌäπÏ†ï Ï£ºÎ¨∏ Í∞úÏàò Í≥ÑÏÇ∞
             * @param {Array} opponentHand - ÏÉÅÎåÄÏùò Ìå®
             * @param {number} spellNumber - Ï£ºÎ¨∏ Î≤àÌò∏
             * @returns {number} Í∞úÏàò
             */
            countSpellInHand(opponentHand, spellNumber) {
                return opponentHand.filter(card => card === spellNumber).length;
            },
            
            /**
             * Í≥µÍ∞úÎêú ÎπÑÎ∞Ä Ï£ºÎ¨∏ÏóêÏÑú ÌäπÏ†ï Ï£ºÎ¨∏ Í∞úÏàò Í≥ÑÏÇ∞
             * @param {Array} secretStones - Í≥µÍ∞úÎêú ÎπÑÎ∞Ä Ï£ºÎ¨∏
             * @param {number} spellNumber - Ï£ºÎ¨∏ Î≤àÌò∏
             * @returns {number} Í∞úÏàò
             */
            countSpellInSecret(secretStones, spellNumber) {
                return secretStones.filter(stone => stone === spellNumber).length;
            },
            
            /**
             * ÏûêÏã†Ïùò Ìå®ÏóêÏÑú ÌäπÏ†ï Ï£ºÎ¨∏Ïù¥ ÏûàÏùÑ ÌôïÎ•† Í≥ÑÏÇ∞
             * @param {number} spellNumber - Ï£ºÎ¨∏ Î≤àÌò∏
             * @param {Object} gameState - Í≤åÏûÑ ÏÉÅÌÉú
             * @returns {number} ÌôïÎ•† (0~1)
             */
            calculateSpellProbability(spellNumber, gameState) {
                const { humanHand, secretStones, usedStones } = gameState;
                
                // Ï†ÑÏ≤¥ Îç±ÏóêÏÑú Ìï¥Îãπ Ï£ºÎ¨∏Ïùò Í∞úÏàò
                const totalSpellCount = spellNumber; // 1Î≤àÏùÄ 1Í∞ú, 2Î≤àÏùÄ 2Í∞ú...
                
                // Ïù¥ÎØ∏ ÏÇ¨Ïö©Îêú Í∞úÏàò
                const usedCount = usedStones.filter(stone => stone === spellNumber).length;
                
                // ÏÉÅÎåÄ Ìå®Ïóê ÏûàÎäî Í∞úÏàò
                const opponentCount = this.countSpellInHand(humanHand, spellNumber);
                
                // Í≥µÍ∞úÎêú ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïóê ÏûàÎäî Í∞úÏàò
                const secretCount = this.countSpellInSecret(secretStones, spellNumber);
                
                // ÎÇ®ÏùÄ Í∞úÏàò Í≥ÑÏÇ∞
                const remainingCount = totalSpellCount - usedCount - opponentCount - secretCount;
                
                // AI Ìå®Ïóê ÏûàÏùÑ ÌôïÎ•†
                const aiHandSize = gameState.aiHand.length;
                const totalRemainingCards = 21 - usedStones.length - humanHand.length - secretStones.length;
                
                if (totalRemainingCards <= 0 || remainingCount <= 0) return 0;
                
                // ÌôïÎ•† Í≥ÑÏÇ∞ (ÎÇ®ÏùÄ Ïπ¥Îìú Ï§ëÏóêÏÑú Ìï¥Îãπ Ï£ºÎ¨∏Ïù¥ ÏûàÏùÑ ÌôïÎ•†)
                return Math.min(remainingCount / totalRemainingCards, 1);
            },
            
            /**
             * ÎÇúÏù¥ÎèÑÎ≥Ñ Î∂ÑÏÑù Ï†ïÌôïÎèÑ Ï°∞Ï†ï
             * @param {number} baseProbability - Í∏∞Î≥∏ ÌôïÎ•†
             * @returns {number} Ï°∞Ï†ïÎêú ÌôïÎ•†
             */
            adjustProbabilityByDifficulty(baseProbability) {
                const difficultyFactors = {
                    easy: 0.3,    // Ïâ¨ÏõÄ: Í±∞Ïùò ÎûúÎç§
                    normal: 0.7,  // Î≥¥ÌÜµ: Ïñ¥Îäê Ï†ïÎèÑ Î∂ÑÏÑù
                    hard: 0.9     // Ïñ¥Î†§ÏõÄ: Ï†ïÌôïÌïú Î∂ÑÏÑù
                };
                
                const factor = difficultyFactors[aiDifficulty] || 0.7;
                return baseProbability * factor + (1 - factor) * Math.random();
            },
            
            /**
             * Ï£ºÎ¨∏ ÏãúÏ†Ñ Í∞ÄÎä•ÏÑ± ÌèâÍ∞Ä
             * @param {number} spellNumber - Ï£ºÎ¨∏ Î≤àÌò∏
             * @param {Object} gameState - Í≤åÏûÑ ÏÉÅÌÉú
             * @returns {number} ÏãúÏ†Ñ Í∞ÄÎä•ÏÑ± Ï†êÏàò (0~1)
             */
            evaluateSpellCastability(spellNumber, gameState) {
                const probability = this.calculateSpellProbability(spellNumber, gameState);
                const adjustedProbability = this.adjustProbabilityByDifficulty(probability);
                
                // ÎÇúÏù¥ÎèÑÎ≥Ñ ÏµúÏÜå ÌôïÎ•† ÏÑ§Ï†ï
                const minProbabilities = {
                    easy: 0.1,
                    normal: 0.3,
                    hard: 0.5
                };
                
                const minProb = minProbabilities[aiDifficulty] || 0.3;
                
                return Math.max(adjustedProbability, minProb);
            }
        };

        /**
         * AI ÏÑ±Í≥µÎ•† Í≥ÑÏÇ∞ (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
         * @returns {number} ÏÑ±Í≥µÎ•† (0~1)
         */
        function getAISuccessRate() {
            const gameState = AIAnalysis.analyzeGameState();
            if (!gameState) {
            return GAME_CONFIG.aiSuccessRate[aiDifficulty] || GAME_CONFIG.aiSuccessRate.normal;
        }
        
            // AIÍ∞Ä ÏãúÏ†ÑÌï† Ï£ºÎ¨∏ ÏÑ†ÌÉù
            const aiPlayer = state.players.find(p => p.id === 2); // AIÎäî Ìï≠ÏÉÅ ÌîåÎ†àÏù¥Ïñ¥ 2
            if (!aiPlayer) {
                return GAME_CONFIG.aiSuccessRate[aiDifficulty] || GAME_CONFIG.aiSuccessRate.normal;
            }
            
            const castableSpells = getCastableSpells(aiPlayer);
            if (castableSpells.length === 0) return 0;
            
            // Í∞ÄÏû• ÎÜíÏùÄ ÌôïÎ•†Ïùò Ï£ºÎ¨∏ ÏÑ†ÌÉù
            let bestSpell = castableSpells[0];
            let bestProbability = 0;
            
            for (const spell of castableSpells) {
                const probability = AIAnalysis.evaluateSpellCastability(spell, gameState);
                if (probability > bestProbability) {
                    bestProbability = probability;
                    bestSpell = spell;
                }
            }
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Í∏∞Î≥∏ ÏÑ±Í≥µÎ•†Í≥º Î∂ÑÏÑù Í∏∞Î∞ò ÏÑ±Í≥µÎ•†ÏùÑ Ï°∞Ìï©
            const baseRate = GAME_CONFIG.aiSuccessRate[aiDifficulty] || GAME_CONFIG.aiSuccessRate.normal;
            const analysisRate = bestProbability;
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Í∞ÄÏ§ëÏπò
            const weights = {
                easy: 0.3,    // Ïâ¨ÏõÄ: Í∏∞Î≥∏ ÏÑ±Í≥µÎ•† 70%, Î∂ÑÏÑù 30%
                normal: 0.6,  // Î≥¥ÌÜµ: Í∏∞Î≥∏ ÏÑ±Í≥µÎ•† 40%, Î∂ÑÏÑù 60%
                hard: 0.8     // Ïñ¥Î†§ÏõÄ: Í∏∞Î≥∏ ÏÑ±Í≥µÎ•† 20%, Î∂ÑÏÑù 80%
            };
            
            const weight = weights[aiDifficulty] || 0.6;
            return baseRate * (1 - weight) + analysisRate * weight;
        }
        
        /**
         * AI Ïó∞ÏÜç ÏòÅÏ∞Ω ÌôïÎ•† Í≥ÑÏÇ∞ (ÏßÄÎä•Ï†Å Î∂ÑÏÑù Í∏∞Î∞ò)
         * @returns {number} Ïó∞ÏÜç ÏòÅÏ∞Ω ÌôïÎ•† (0~1)
         */
        function getAIContinueRate() {
            const gameState = AIAnalysis.analyzeGameState();
            if (!gameState) {
            return GAME_CONFIG.aiContinueRate[aiDifficulty] || GAME_CONFIG.aiContinueRate.normal;
            }
            
            // ÌòÑÏû¨ ÏÑ±Í≥µÌïú Ï£ºÎ¨∏Î≥¥Îã§ ÎÜíÏùÄ Ï£ºÎ¨∏Îì§Ïùò ÌôïÎ•† Î∂ÑÏÑù
            const higherSpells = [];
            for (let i = gameState.lastSuccessfulSpell + 1; i <= 6; i++) {
                const probability = AIAnalysis.evaluateSpellCastability(i, gameState);
                higherSpells.push({ spell: i, probability });
            }
            
            if (higherSpells.length === 0) return 0;
            
            // Í∞ÄÏû• ÎÜíÏùÄ ÌôïÎ•†Ïùò Ï£ºÎ¨∏ Ï∞æÍ∏∞
            const bestSpell = higherSpells.reduce((best, current) => 
                current.probability > best.probability ? current : best
            );
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Í∏∞Î≥∏ Ïó∞ÏÜç ÌôïÎ•†Í≥º Î∂ÑÏÑù Í∏∞Î∞ò ÌôïÎ•†ÏùÑ Ï°∞Ìï©
            const baseRate = GAME_CONFIG.aiContinueRate[aiDifficulty] || GAME_CONFIG.aiContinueRate.normal;
            const analysisRate = bestSpell.probability;
            
            const weights = {
                easy: 0.2,    // Ïâ¨ÏõÄ: Í∏∞Î≥∏ ÌôïÎ•† 80%, Î∂ÑÏÑù 20%
                normal: 0.5,  // Î≥¥ÌÜµ: Í∏∞Î≥∏ ÌôïÎ•† 50%, Î∂ÑÏÑù 50%
                hard: 0.7     // Ïñ¥Î†§ÏõÄ: Í∏∞Î≥∏ ÌôïÎ•† 30%, Î∂ÑÏÑù 70%
            };
            
            const weight = weights[aiDifficulty] || 0.5;
            return baseRate * (1 - weight) + analysisRate * weight;
        }

        function checkGameOver() {
            if (!GameConditions.isGameValid() || !state.players[0] || !state.players[1]) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§');
                return false;
            }
            
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            const myPlayer = state.players.find(p => p.id === myPlayerId);
            const opponentPlayer = state.players.find(p => p.id !== myPlayerId);
            
            let winner = null;
            
            console.log('üèÅ Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨:', {
                myPlayerId: myPlayerId,
                myHealth: myPlayer.health,
                opponentHealth: opponentPlayer.health,
                myHandLength: myPlayer.hand.length,
                opponentHandLength: opponentPlayer.hand.length,
                myHand: myPlayer.hand,
                opponentHand: opponentPlayer.hand,
                isGameOver: state.isGameOver
            });
            
            // Ï≤¥Î†•Ïù¥ 0 Ïù¥ÌïòÏù∏ Í≤ΩÏö∞Í∞Ä Ïö∞ÏÑ† (Ìå®Î∞∞ Ï°∞Í±¥)
            if (myPlayer.health <= 0) {
                console.log('üèÅ Í≤åÏûÑ Ï¢ÖÎ£å Ï°∞Í±¥: ÎÇ¥ Ï≤¥Î†•Ïù¥ 0 Ïù¥Ìïò');
                winner = opponentPlayer;
            } else if (opponentPlayer.health <= 0) {
                console.log('üèÅ Í≤åÏûÑ Ï¢ÖÎ£å Ï°∞Í±¥: ÏÉÅÎåÄ Ï≤¥Î†•Ïù¥ 0 Ïù¥Ìïò');
                winner = myPlayer;
            } else if (myPlayer.hand.length === 0) {
                // Ìå®Í∞Ä ÎπÑÏóàÏßÄÎßå Ï≤¥Î†•Ïù¥ ÎÇ®ÏïÑÏûàÏúºÎ©¥ ÏäπÎ¶¨
                console.log('üèÅ Í≤åÏûÑ Ï¢ÖÎ£å Ï°∞Í±¥: ÎÇ¥ Ìå®Í∞Ä ÎπÑÏñ¥ÏûàÏùå');
                winner = myPlayer;
            } else if (opponentPlayer.hand.length === 0) {
                // ÏÉÅÎåÄ Ìå®Í∞Ä ÎπÑÏóàÏßÄÎßå Ï≤¥Î†•Ïù¥ ÎÇ®ÏïÑÏûàÏúºÎ©¥ ÏäπÎ¶¨
                console.log('üèÅ Í≤åÏûÑ Ï¢ÖÎ£å Ï°∞Í±¥: ÏÉÅÎåÄ Ìå®Í∞Ä ÎπÑÏñ¥ÏûàÏùå');
                winner = opponentPlayer;
            }
            
            if (winner && !state.isGameOver) {
                state.isGameOver = true;
                
                // Í≤åÏûÑ Ï¢ÖÎ£å Ïãú ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ Î∞è Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                stopTurnTimer();
                resetTurnGauge();
                
                // ÏäπÎ¶¨/Ìå®Î∞∞ Î©îÏãúÏßÄ ÏÉùÏÑ±
                const isPlayerWin = winner.id === myPlayerId;
                let message;
                
                if (isPlayerWin) {
                    // ÎÇ¥Í∞Ä ÏäπÎ¶¨Ìïú Í≤ΩÏö∞
                    if (opponentPlayer.health <= 0) {
                        message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! ÏÉÅÎåÄÏùò Ï≤¥Î†•Ïù¥ 0Ïù¥ ÎêòÏóàÏäµÎãàÎã§!';
                    } else if (myPlayer.hand.length === 0) {
                        message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! Î™®Îì† ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§!';
                    } else {
                        message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! ÏÉÅÎåÄÍ∞Ä ÎèÑÎßùÏ≥§ÏäµÎãàÎã§!';
                    }
                } else {
                    // ÎÇ¥Í∞Ä Ìå®Î∞∞Ìïú Í≤ΩÏö∞
                    if (myPlayer.health <= 0) {
                        message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÏûêÏã†Ïùò Ï≤¥Î†•Ïù¥ 0Ïù¥ ÎêòÏóàÏäµÎãàÎã§.';
                    } else if (opponentPlayer.hand.length === 0) {
                        message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÏÉÅÎåÄÍ∞Ä Î™®Îì† ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.';
                    } else {
                        message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÎèÑÎßùÏπòÍ≥† ÎßêÏïòÏäµÎãàÎã§.';
                    }
                }
                console.log(`üèÜ Í≤åÏûÑ Ï¢ÖÎ£å: ${winner.name} ÏäπÎ¶¨!`);
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Í≤åÏûÑ Ï¢ÖÎ£å Ï†ÑÏÜ°
                if (multiplayerMode && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'gameOver',
                        winner: winner.id,
                        gameState: state
                    }));
                }
                
                // Ï†ÑÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ (Ïó∞Ïäπ Ï≤òÎ¶¨ Ìè¨Ìï®)
                updateStats(isPlayerWin, multiplayerMode);
                
                // Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                if (socket && socket.connected) {
                    const playerName = localStorage.getItem('playerName') || 'Player';
                    const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                    const trophies = TrophySystem.loadTrophies();
                    
                    // ÌòÑÏû¨ Ï†êÏàòÎ°ú Îû≠ÌÇπ ÏóÖÎç∞Ïù¥Ìä∏
                    socket.emit('updateRanking', {
                        category: multiplayerMode ? 'formal' : 'mock',
                        playerName: playerName,
                        score: multiplayerMode ? trophies.multiplayer : trophies.ai,
                        icon: playerIcon
                    });
                    
                    console.log(`üîÑ Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏: ${playerName} (${multiplayerMode ? 'Ï†ïÏãù' : 'Î™®Ïùò'} Í≤∞Ìà¨)`);
                }
                
                // Ïó∞Ïäπ Î©îÏãúÏßÄ Ï∂îÍ∞Ä (updateStatsÏóêÏÑú Ï≤òÎ¶¨Îêú Ïó∞Ïäπ ÏÇ¨Ïö©)
                if (isPlayerWin && currentWinStreak >= 2) {
                    message += `\n\n${Messages.streak(currentWinStreak)}`;
                }
                
                // Í≥ÑÏ†ï ÏãúÏä§ÌÖúÍ≥º Ïó∞ÎèôÎêú Í≤åÏûÑ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
                const gameType = multiplayerMode ? 'formal' : 'mock';
                const opponentName = multiplayerMode ? (opponentPlayer.name || 'ÏÉÅÎåÄÎ∞©') : 'AI ÌóàÏàòÏïÑÎπÑ';
                
                // ÏÑúÎ≤ÑÎ°ú Í≤åÏûÑ Í≤∞Í≥º Ï†ÑÏÜ° (Í≥ÑÏ†ï Ïú†Ï†ÄÎßå)
                updateGameResult(gameType, isPlayerWin, opponentName);
                
                // Í∏∞Ï°¥ Ï¶ùÌëú ÏãúÏä§ÌÖú (Í≤åÏä§Ìä∏ Î™®ÎìúÏö©)
                if (isPlayerWin) {
                    if (multiplayerMode) {
                        TrophySystem.addVictoryTrophy('multiplayer');
                    } else {
                        TrophySystem.addVictoryTrophy('ai');
                    }
                } else {
                    if (multiplayerMode) {
                        TrophySystem.addDefeatTrophy('multiplayer');
                    } else {
                        TrophySystem.addDefeatTrophy('ai');
                    }
                }
                
                // ÏäπÏ†ê Î≥ÄÌôî Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏäπÎ¶¨/Ìå®Î∞∞ Î™®Îëê ÌëúÏãú)
                const trophyType = multiplayerMode ? 'multiplayer' : 'ai';
                const trophyChange = isPlayerWin ? '+3' : '-1';
                const trophyMessage = `\n\nüèÖ ÏäπÏ†ê ${trophyChange}`;
                message += trophyMessage;
                
                // ÏÉàÎ°úÍ≥†Ïπ® ÏïàÎÇ¥ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
                message += `\n\nüîÑ 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú ÏÉàÎ°úÍ≥†Ïπ®Îê©ÎãàÎã§.`;
                
                // ÏäπÎ¶¨/Ìå®Î∞∞ ÏÇ¨Ïö¥Îìú
                activateAudioContext();
                playGameOverSound(winner.id === myPlayerId);
                
                showModal('Í≤åÏûÑ Ï¢ÖÎ£å', message, true);
                addLog(`- Í≤åÏûÑ Ï¢ÖÎ£å: ${winner.name} ÏäπÎ¶¨! -`);
                render();
                
                // Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ 3Ï¥à Îí§ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => {
                    console.log('üîÑ Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ');
                    window.location.reload();
                }, 3000);
                
                return true;
            }
            return false;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ÎîîÎ≤ÑÍ∑∏ Ìï®ÏàòÎì§
        function showDebugInfo() {
            const player = state.players[0];
            const ai = state.players[1];
            debugInfo.innerHTML = `
                <div>ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†•: ${player.health}</div>
                <div>AI Ï≤¥Î†•: ${ai.health}</div>
                <div>ÌîåÎ†àÏù¥Ïñ¥ ÏÜêÌå®: [${player.hand.join(', ')}]</div>
                <div>AI ÏÜêÌå®: [${ai.hand.join(', ')}]</div>
                <div>ÎπÑÎ∞Ä Ï†ÑÏà†: ${state.secretStones.length}Í∞ú</div>
                <div>ÏÇ¨Ïö©Ìïú Ï†ÑÏà†: ${state.usedStones.length}Í∞ú</div>
                <div>ÎßàÏßÄÎßâ ÏÑ±Í≥µ Ï†ÑÎûµ: ${state.lastSuccessfulSpell}</div>
                <div>Í≤åÏûÑ Ï¢ÖÎ£å: ${state.isGameOver}</div>
            `;
        }

        function showPlayerHand() {
            const player = state.players[0];
            showCardListModal('ÌîåÎ†àÏù¥Ïñ¥ ÏÜêÌå®', player.hand, true);
        }

        function showAIHand() {
            const ai = state.players[1];
            showCardListModal('AI ÏÜêÌå®', ai.hand, true);
        }

        function showCardListModal(title, cards, showNumbers = false) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                    ${cards.length > 0 ? `
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        ${cards.sort((a, b) => a - b).map((card, index) => `
                            <div class="card card-front flex flex-col items-center justify-center text-sm">
                                <div class="text-lg">${getSpellIcon(card)}</div>
                                <div class="text-xs">${card}</div>
                                ${showNumbers ? `<div class="text-xs opacity-75">#${index + 1}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ` : `
                        <div class="text-center mb-4 text-gray-400">
                            <div class="text-4xl mb-2">üì≠</div>
                            <p>ÏïÑÏßÅ ÏÇ¨Ïö©Îêú Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    `}
                    <button class="w-full py-2 rounded-lg font-bold btn-primary">ÌôïÏù∏</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            return new Promise(resolve => {
                modal.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve();
                });
            });
        }

        function showCombinedSecretStonesModal() {
            // Í∞Å ÏÑπÏÖòÏùò Ïπ¥Îìú Í∞úÏàò Í≥ÑÏÇ∞
            const personalCount = state.personalRevealedStones ? state.personalRevealedStones.length : 0;
            const opponentPersonalCount = state.opponentPersonalRevealedStones ? state.opponentPersonalRevealedStones.length : 0;
            const publicCount = state.publiclyRevealedSecretStones ? state.publiclyRevealedSecretStones.length : 0;
            const secretCount = state.secretStones ? state.secretStones.length : 0;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4 text-center">ÎπÑÎ∞Ä Ï£ºÎ¨∏ Î™©Î°ù</h3>
                    
                    <!-- ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${personalCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-blue-600 mb-2 flex items-center">
                                <span class="mr-1">üëÅÔ∏è</span><span>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú</span><span class="ml-auto text-xs text-blue-500">(${personalCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-blue-50 p-3 rounded">
                                ${state.personalRevealedStones.sort((a, b) => a - b).map(stone => `
                                <div class="card card-front flex flex-col items-center justify-center text-sm">
                                    <div class="text-lg">${getSpellIcon(stone)}</div>
                                    <div class="text-xs">${stone}</div>
                                </div>
                            `).join('')}
                        </div>
                        </div>
                    ` : ''}
                    
                    <!-- ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${opponentPersonalCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-orange-600 mb-2 flex items-center">
                                <span class="mr-1">üëÅÔ∏è</span><span>ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞ú</span><span class="ml-auto text-xs text-orange-500">(${opponentPersonalCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-orange-50 p-3 rounded">
                                ${state.opponentPersonalRevealedStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card ${cheatMode ? 'card-front' : 'card-back'} flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${cheatMode ? getSpellIcon(stone) : '‚ùì'}</div>
                                        <div class="text-xs">${cheatMode ? stone : '???'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${publicCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-green-600 mb-2 flex items-center">
                                <span class="mr-1">üåê</span><span>Î™®ÎëêÏóêÍ≤å Í≥µÍ∞ú</span><span class="ml-auto text-xs text-green-500">(${publicCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-green-50 p-3 rounded">
                                ${state.publiclyRevealedSecretStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card card-front flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${getSpellIcon(stone)}</div>
                                        <div class="text-xs">${stone}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- ÏïÑÏßÅ Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏Îì§ -->
                    ${secretCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-gray-600 mb-2 flex items-center">
                                <span class="mr-1">üîí</span><span>ÏïÑÏßÅ Í≥µÍ∞úÎêòÏßÄ ÏïäÏùå</span><span class="ml-auto text-xs text-gray-500">(${secretCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-gray-50 p-3 rounded">
                                ${state.secretStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card ${cheatMode ? 'card-front' : 'card-back'} flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${cheatMode ? getSpellIcon(stone) : '‚ùì'}</div>
                                        <div class="text-xs">${cheatMode ? stone : '???'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Î™®Îì† ÏÑπÏÖòÏù¥ ÎπÑÏñ¥ÏûàÎäî Í≤ΩÏö∞ -->
                    ${personalCount === 0 && opponentPersonalCount === 0 && publicCount === 0 && secretCount === 0 ? `
                        <p class="text-center mb-4 text-gray-400">ÏïÑÏßÅ ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    ` : ''}
                    
                    <button class="w-full py-2 rounded-lg font-bold btn-primary mt-4">ÌôïÏù∏</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            return new Promise(resolve => {
                modal.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve();
                });
            });
        }

        function showCardChoiceModal(title, message, cards, isHand = false) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
                modal.innerHTML = `
                    <div class="modal-content p-6 rounded-lg max-w-lg w-full mx-4">
                        <h3 class="text-xl font-bold mb-2 text-center">${title}</h3>
                        <p class="text-center mb-4">${message}</p>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            ${cards.map((card, index) => `
                                <div class="card ${isHand ? 'card-front' : 'card-back'} flex flex-col items-center justify-center text-sm cursor-pointer hover:scale-105 transition-transform" data-card="${card}">
                                    <div class="text-lg">${isHand ? getSpellIcon(card) : '?'}</div>
                                    <div class="text-xs">${isHand ? card : 'Ïà®ÍπÄ'}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="w-full py-2 rounded-lg font-bold btn-primary">Ï∑®ÏÜå</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                playCardSound();
                
                const cardElements = modal.querySelectorAll('[data-card]');
                cardElements.forEach(cardEl => {
                    cardEl.addEventListener('click', () => {
                        const selectedCard = parseInt(cardEl.dataset.card);
                        document.body.removeChild(modal);
                        resolve(selectedCard);
                    });
                });
                
                modal.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(null);
                });
            });
        }

        function showChoiceModal(title, message, option1, option2) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
                modal.innerHTML = `
                    <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-2 text-center">${title}</h3>
                        <p class="text-center mb-4">${message}</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button class="py-3 rounded-lg font-bold btn-primary" data-choice="${option1}">${option1}</button>
                            <button class="py-3 rounded-lg font-bold btn-primary" data-choice="${option2}">${option2}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                playCardSound();
                
                const buttons = modal.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const choice = btn.dataset.choice;
                        document.body.removeChild(modal);
                        resolve(choice);
                    });
                });
            });
        }

        function showModal(title, message, isGameOver = false) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
                modal.innerHTML = `
                    <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                        <p class="text-center mb-4">${message}</p>
                        <button class="w-full py-3 rounded-lg font-bold btn-primary">${isGameOver ? 'ÌÉÄÏù¥ÌãÄÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞' : 'ÌôïÏù∏'}</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                playCardSound();
                
                // ÏòÅÏ∞Ω ÏÑ±Í≥µ Í¥ÄÎ†® Î™®Îã¨Ïù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† ÌååÌã∞ÌÅ¥ Ìö®Í≥º Ï∂îÍ∞Ä
                const isSpellSuccessModal = title.includes('ÏòÅÏ∞Ω ÏÑ±Í≥µ') || 
                                          title.includes('üí§ Î™ÖÏÉÅ') || 
                                          title.includes('üß™ ÏÉùÎ™Ö Î¨ºÏïΩ') || 
                                          title.includes('üî• ÌôîÏóº ÌôîÏÇ¥') || 
                                          title.includes('üåÄ Ï†ïÏã† ÍµêÎûÄ') || 
                                          title.includes('üí´ ÎßàÎ†• Ï∞©Ï∑®') || 
                                          title.includes('üîÆ Ïö¥Î™Ö Î≥ÄÌôò');
                
                if (isSpellSuccessModal) {
                    // ÌòÑÏû¨ ÏÑ±Í≥µÌïú Ï£ºÎ¨∏ Î≤àÌò∏Î•º Ï∞æÍ∏∞ ÏúÑÌï¥ stateÏóêÏÑú ÌôïÏù∏
                    const lastSpell = state.lastSuccessfulSpell;
                    if (lastSpell > 0) {
                        // ÌåùÏóÖÏù¥ Îú®Îäî Ï¶âÏãú ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ±
                        createModalParticles(lastSpell);
                    }
                }
                
                modal.querySelector('button').addEventListener('click', () => {
                    if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                    }
                    if (isGameOver) {
                        setTimeout(() => {
                            showTitleScreen();
                        }, 100);
                    }
                    resolve();
                });
            });
        }

        function resetGame() {
            console.log('üîÑ Í≤åÏûÑ Î¶¨ÏÖã');
            
            // Î°úÏª¨ Î©îÎ™® ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            localMemoNotes = {};
            localMemoPanelActive = false;
            
            // Í≤åÏûÑ ÏãúÏûë Ïãú ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ Î∞è Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
            stopTurnTimer();
            resetTurnGauge();
            
            // Ïò¨Î∞îÎ•∏ Îç± ÏÉùÏÑ± (1Î≤àÏùÄ 1Í∞ú, 2Î≤àÏùÄ 2Í∞ú, 3Î≤àÏùÄ 3Í∞ú...)
            let deck = [];
            for (let spellNumber = 1; spellNumber <= GAME_CONFIG.deckStructure.maxSpell; spellNumber++) {
                for (let cardCount = 0; cardCount < GAME_CONFIG.deckStructure.cardsPerSpell(spellNumber); cardCount++) {
                    deck.push(spellNumber);
                }
            }
            console.log('üì¶ Ï¥àÍ∏∞ Îç± ÏÉùÏÑ±:', deck);
            
            // Îç± ÏÖîÌîå
            shuffleArray(deck);
            console.log('üîÑ Îç± ÏÖîÌîå ÏôÑÎ£å');
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ Î≤àÏß∏ ÌÑ¥ÏùÑ Í≤∞Ï†ïÌïòÍ≥† ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï†ÑÏÜ°
            let firstPlayer;
            if (multiplayerMode && isHost) {
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî Ìò∏Ïä§Ìä∏Í∞Ä Ìï≠ÏÉÅ 1Î≤à ÌîåÎ†àÏù¥Ïñ¥, Ï≤´ ÌÑ¥Îßå ÎûúÎç§ Í≤∞Ï†ï
                firstPlayer = Math.random() < 0.5 ? 1 : 2;
                console.log(`üéØ Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï: ÌîåÎ†àÏù¥Ïñ¥ ${firstPlayer} (Ìò∏Ïä§Ìä∏Îäî Ìï≠ÏÉÅ 1Î≤à)`);
                
                // ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï≤´ Î≤àÏß∏ ÌÑ¥ Ï†ïÎ≥¥ Ï†ÑÏÜ°
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'firstTurn',
                        firstPlayer: firstPlayer
                    }));
                }
            } else if (multiplayerMode && !isHost) {
                // Í≤åÏä§Ìä∏Îäî Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏùÑ Í∏∞Îã§Î¶º
                console.log('‚è≥ Ìò∏Ïä§Ìä∏Ïùò Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï ÎåÄÍ∏∞ Ï§ë...');
                // Í≤åÏä§Ìä∏ÎèÑ Í∏∞Î≥∏ Í≤åÏûÑ ÏÉÅÌÉúÎäî Ï¥àÍ∏∞ÌôîÌïòÎêò, Ï≤´ Î≤àÏß∏ ÌÑ¥ÏùÄ Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏùÑ Í∏∞Îã§Î¶º
                firstPlayer = 1; // ÏûÑÏãúÍ∞í, Ìò∏Ïä§Ìä∏Í∞Ä Í≤∞Ï†ïÌïú Í∞íÏúºÎ°ú ÎçÆÏñ¥ÏîåÏõåÏßê
            } else {
                // AI Î™®ÎìúÏóêÏÑúÎäî ÎûúÎç§ Í≤∞Ï†ï
                firstPlayer = Math.random() < 0.5 ? 1 : 2;
                console.log(`üéØ AI Î™®Îìú Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï: ÌîåÎ†àÏù¥Ïñ¥ ${firstPlayer}`);
            }
            
            const playerName = localStorage.getItem('playerName') || 'Player';
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            
            state = {
                players: [
                    { id: 1, name: playerName, health: GAME_CONFIG.maxHealth, hand: deck.slice(0, GAME_CONFIG.maxHandSize).sort((a, b) => a - b), knownSecretStones: [] },
                    { id: 2, name: multiplayerMode ? (opponentName || 'Player2') : 'AI', health: GAME_CONFIG.maxHealth, hand: deck.slice(GAME_CONFIG.maxHandSize, GAME_CONFIG.maxHandSize * 2).sort((a, b) => a - b), knownSecretStones: [] }
                ],
                secretStones: deck.slice(14),
                usedStones: [],
                publiclyRevealedSecretStones: [],
                currentPlayerId: firstPlayer,
                isPlayerTurn: multiplayerMode ? (firstPlayer === myPlayerId) : (firstPlayer === 1),
                lastSuccessfulSpell: 0,
                turnInProgress: false,
                isGameOver: false,
                gameStarted: true,
                gameLog: [Messages.gameStart(firstPlayer === 1 ? playerName : (multiplayerMode ? (opponentName || 'Player2') : 'AI'))]
            };
            
            console.log(`üéØ Í≤åÏûÑ ÏÉÅÌÉú ÏÑ§Ï†ï ÏôÑÎ£å - Ìò∏Ïä§Ìä∏: ${isHost}, Ï≤´ ÌÑ¥ ÌîåÎ†àÏù¥Ïñ¥: ${firstPlayer}, ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ ID: ${myPlayerId}, ÎÇ¥ ÌÑ¥: ${state.isPlayerTurn}`);
            
            console.log('üéØ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉú:', {
                playerHand: state.players[0].hand,
                aiHand: state.players[1].hand,
                secretStones: state.secretStones,
                totalCards: deck.length
            });
            
            createSpellButtons();
            updatePlayerName();
            render();
            updateButtons();
            
            // Ï≤´ Î≤àÏß∏ ÌÑ¥ ÌÉÄÏù¥Î®∏ ÏãúÏûë (AI ÎòêÎäî ÌîåÎ†àÏù¥Ïñ¥ Î™®Îëê)
            setTimeout(() => {
                startTurnTimer();
                
                // AIÍ∞Ä Î®ºÏ†Ä ÏãúÏûëÌïòÎäî Í≤ΩÏö∞ AI ÌÑ¥ Ïã§Ìñâ
                if (!state.isPlayerTurn && !multiplayerMode) {
                    aiTurn();
                }
            }, 1000);
        }

        // ÏÇ¨Ïö¥Îìú Ìö®Í≥º Ìï®ÏàòÎì§ (ÏÉÅÎã®ÏóêÏÑú ÌÜµÌï©Îêú Î≤ÑÏ†Ñ ÏÇ¨Ïö©)
        // Ï§ëÎ≥µ Ï†úÍ±∞Îê® - ÏÉÅÎã®Ïùò playSoundEffect() Ìï®Ïàò ÏÇ¨Ïö©

        // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º Ìï®ÏàòÎì§
        function addSuccessAnimation(element) {
            element.classList.add('success-animation');
            setTimeout(() => element.classList.remove('success-animation'), 500);
        }

        function addFailureAnimation(element) {
            element.classList.add('failure-animation');
            setTimeout(() => element.classList.remove('failure-animation'), 500);
        }

        function showDamageEffect(element, amount) {
            const damageEl = document.createElement('div');
            damageEl.className = 'card-damage';
            damageEl.textContent = `-${amount}`;
            element.appendChild(damageEl);
            setTimeout(() => element.removeChild(damageEl), 1000);
        }

        function showHealEffect(element, amount) {
            const healEl = document.createElement('div');
            healEl.className = 'card-heal';
            healEl.textContent = `+${amount}`;
            element.appendChild(healEl);
            setTimeout(() => element.removeChild(healEl), 1000);
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function shuffleArray(array) {
            for (let currentIndex = array.length - 1; currentIndex > 0; currentIndex--) {
                const randomIndex = Math.floor(Math.random() * (currentIndex + 1));
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ÎßàÎ≤ï Î≤àÌò∏Ïóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò Î∞òÌôò Ìï®Ïàò
        function getSpellIcon(spellNumber) {
            const spellIcons = {
                1: 'üîÆ', // Ïö¥Î™Ö Î≥ÄÌôò
                2: 'üí´', // ÎßàÎ†• Ï∞©Ï∑®
                3: 'üåÄ', // Ï†ïÏã† ÍµêÎûÄ
                4: 'üî•', // ÌôîÏóº ÌôîÏÇ¥
                5: 'üß™', // ÏÉùÎ™Ö Î¨ºÏïΩ
                6: 'üí§'  // Î™ÖÏÉÅ
            };
            return spellIcons[spellNumber] || '‚ùì';
        }

        // Î™®Îã¨ Ìï®ÏàòÎì§
        function showCardListModal(title, cards, showNumbers = false) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                    ${cards.length > 0 ? `
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        ${cards.sort((a, b) => a - b).map((card, index) => `
                            <div class="card card-front flex flex-col items-center justify-center text-sm">
                                <div class="text-lg">${getSpellIcon(card)}</div>
                                <div class="text-xs">${card}</div>
                                ${showNumbers ? `<div class="text-xs opacity-75">#${index + 1}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ` : `
                        <div class="text-center mb-4 text-gray-400">
                            <div class="text-4xl mb-2">üì≠</div>
                            <p>ÏïÑÏßÅ ÏÇ¨Ïö©Îêú Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    `}
                    <button class="w-full py-2 rounded-lg font-bold btn-primary">ÌôïÏù∏</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            return new Promise(resolve => {
                modal.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve();
                });
            });
        }

        function showCombinedSecretStonesModal() {
            // Í∞Å ÏÑπÏÖòÏùò Ïπ¥Îìú Í∞úÏàò Í≥ÑÏÇ∞
            const personalCount = state.personalRevealedStones ? state.personalRevealedStones.length : 0;
            const opponentPersonalCount = state.opponentPersonalRevealedStones ? state.opponentPersonalRevealedStones.length : 0;
            const publicCount = state.publiclyRevealedSecretStones ? state.publiclyRevealedSecretStones.length : 0;
            const secretCount = state.secretStones ? state.secretStones.length : 0;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4 text-center">ÎπÑÎ∞Ä Ï£ºÎ¨∏ Î™©Î°ù</h3>
                    
                    <!-- ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${personalCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-blue-600 mb-2 flex items-center">
                                <span class="mr-1">üëÅÔ∏è</span><span>ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú</span><span class="ml-auto text-xs text-blue-500">(${personalCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-blue-50 p-3 rounded">
                                ${state.personalRevealedStones.sort((a, b) => a - b).map(stone => `
                                <div class="card card-front flex flex-col items-center justify-center text-sm">
                                    <div class="text-lg">${getSpellIcon(stone)}</div>
                                    <div class="text-xs">${stone}</div>
                                </div>
                            `).join('')}
                        </div>
                        </div>
                    ` : ''}
                    
                    <!-- ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${opponentPersonalCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-orange-600 mb-2 flex items-center">
                                <span class="mr-1">üëÅÔ∏è</span><span>ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞ú</span><span class="ml-auto text-xs text-orange-500">(${opponentPersonalCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-orange-50 p-3 rounded">
                                ${state.opponentPersonalRevealedStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card ${cheatMode ? 'card-front' : 'card-back'} flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${cheatMode ? getSpellIcon(stone) : '‚ùì'}</div>
                                        <div class="text-xs">${cheatMode ? stone : '???'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎêú Ï£ºÎ¨∏Îì§ -->
                    ${publicCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-green-600 mb-2 flex items-center">
                                <span class="mr-1">üåê</span><span>Î™®ÎëêÏóêÍ≤å Í≥µÍ∞ú</span><span class="ml-auto text-xs text-green-500">(${publicCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-green-50 p-3 rounded">
                                ${state.publiclyRevealedSecretStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card card-front flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${getSpellIcon(stone)}</div>
                                        <div class="text-xs">${stone}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- ÏïÑÏßÅ Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏Îì§ -->
                    ${secretCount > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-bold text-gray-600 mb-2 flex items-center">
                                <span class="mr-1">üîí</span><span>ÏïÑÏßÅ Í≥µÍ∞úÎêòÏßÄ ÏïäÏùå</span><span class="ml-auto text-xs text-gray-500">(${secretCount}Í∞ú)</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 bg-gray-50 p-3 rounded">
                                ${state.secretStones.sort((a, b) => a - b).map(stone => `
                                    <div class="card ${cheatMode ? 'card-front' : 'card-back'} flex flex-col items-center justify-center text-sm">
                                        <div class="text-lg">${cheatMode ? getSpellIcon(stone) : '‚ùì'}</div>
                                        <div class="text-xs">${cheatMode ? stone : '???'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Î™®Îì† ÏÑπÏÖòÏù¥ ÎπÑÏñ¥ÏûàÎäî Í≤ΩÏö∞ -->
                    ${personalCount === 0 && opponentPersonalCount === 0 && publicCount === 0 && secretCount === 0 ? `
                        <p class="text-center mb-4 text-gray-400">ÏïÑÏßÅ ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    ` : ''}
                    
                    <button class="w-full py-2 rounded-lg font-bold btn-primary mt-4">ÌôïÏù∏</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            return new Promise(resolve => {
                modal.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve();
                });
            });
        }

        function showDebugInfo() {
            const player = state.players[0];
            const ai = state.players[1];
            debugInfo.innerHTML = `
                <div>ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†•: ${player.health}</div>
                <div>AI Ï≤¥Î†•: ${ai.health}</div>
                <div>ÌîåÎ†àÏù¥Ïñ¥ ÏÜêÌå®: [${player.hand.join(', ')}]</div>
                <div>AI ÏÜêÌå®: [${ai.hand.join(', ')}]</div>
                <div>ÎπÑÎ∞Ä Ï†ÑÏà†: ${state.secretStones.length}Í∞ú</div>
                <div>ÏÇ¨Ïö©Ìïú Ï†ÑÏà†: ${state.usedStones.length}Í∞ú</div>
                <div>ÎßàÏßÄÎßâ ÏÑ±Í≥µ Ï†ÑÎûµ: ${state.lastSuccessfulSpell}</div>
                <div>Í≤åÏûÑ Ï¢ÖÎ£å: ${state.isGameOver}</div>
            `;
        }

        function showPlayerHand() {
            const player = state.players[0];
            showCardListModal('ÌîåÎ†àÏù¥Ïñ¥ ÏÜêÌå®', player.hand, true);
        }

        function showAIHand() {
            const ai = state.players[1];
            showCardListModal('AI ÏÜêÌå®', ai.hand, true);
        }

        // Í≤åÏûÑ ÏÑ§Ï†ï ÏÉÅÏàò (Í∏∞Ï°¥ Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
        const GAME_CONFIG = {
            maxHealth: 4,
            maxHandSize: 7,
            maxLogEntries: 20,
            turnDuration: {
                easy: 25,
                normal: 30,
                hard: 35,
                multiplayer: 30
            },
            aiSuccessRate: {
                easy: 0.3,
                normal: 0.5,
                hard: 0.7
            },
            aiContinueRate: {
                easy: 0.4,
                normal: 0.6,
                hard: 0.8
            },
            deckStructure: {
                maxSpell: 6,
                cardsPerSpell: (spell) => spell // 1Î≤àÏùÄ 1Í∞ú, 2Î≤àÏùÄ 2Í∞ú...
            }
        };

        // GAME_CONFIG Ï†ïÏùò ÌõÑ Ï¥àÍ∏∞Ìôî Ìï®Ïàò Ìò∏Ï∂ú
        initializeGameConfig();

        /**
         * Í≤åÏûÑ Ï°∞Í±¥ Í≤ÄÏ¶ù Ìó¨Ìçº Ìï®ÏàòÎì§
         * Î≥µÏû°Ìïú Ï°∞Í±¥Î¨∏ÏùÑ Îã®ÏàúÌôîÌïòÍ≥† Í∞ÄÎèÖÏÑ±ÏùÑ Ìñ•ÏÉÅ
         */
        const GameConditions = {
            /**
             * Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
             * @returns {boolean} Ïó∞Í≤∞ ÏÉÅÌÉú
             */
            isMultiplayerConnected: () => multiplayerMode && dataChannel && dataChannel.readyState === 'open',
            
            /**
             * Í≤åÏûÑ ÏÉÅÌÉú Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
             * @returns {boolean} Í≤åÏûÑ ÏÉÅÌÉú Ïú†Ìö®ÏÑ±
             */
            isGameValid: () => state && state.players && state.players.length >= 2,
            
            /**
             * ÎÇ¥ ÌÑ¥Ïù∏ÏßÄ ÌôïÏù∏
             * @returns {boolean} ÎÇ¥ ÌÑ¥ Ïó¨Î∂Ä
             */
            isMyTurn: () => {
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                return multiplayerMode ? (state.currentPlayerId === myPlayerId) : state.isPlayerTurn;
            },
            
            /**
             * Ï£ºÎ¨∏ ÏãúÏ†Ñ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏
             * @returns {boolean} Ï£ºÎ¨∏ ÏãúÏ†Ñ Í∞ÄÎä• Ïó¨Î∂Ä
             */
            canPlaySpell: () => {
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                const isMyTurn = multiplayerMode ? (state.currentPlayerId === myPlayerId) : state.isPlayerTurn;
                return isMyTurn && !state.turnInProgress && !state.isGameOver;
            },
            
            /**
             * Í≤åÏûÑ ÏßÑÌñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
             * @returns {boolean} Í≤åÏûÑ ÏßÑÌñâ ÏÉÅÌÉú
             */
            isGameInProgress: () => multiplayerMode && state.gameStarted && !state.isGameOver
        };

        // Ï£ºÎ¨∏ ÏïÑÏù¥ÏΩò Ï†ïÏùò
        const SpellIcons = {
            1: 'üîÆ', // Ïö¥Î™Ö Î≥ÄÌôò
            2: 'üí´', // ÎßàÎ†• Ï∞©Ï∑®
            3: 'üåÄ', // Ï†ïÏã† ÍµêÎûÄ
            4: 'üî•', // ÌôîÏóº ÌôîÏÇ¥
            5: 'üß™', // ÏÉùÎ™Ö Î¨ºÏïΩ
            6: 'üí§'  // Î™ÖÏÉÅ
        };

        // Î©îÏãúÏßÄ ÌÖúÌîåÎ¶ø
        const Messages = {
            spellSuccess: (name, spell) => `‚úÖ ${name} ${SpellIcons[spell] || '‚ùì'}${spell}Î≤à ÏòÅÏ∞Ω ÏÑ±Í≥µ`,
            spellFailure: (name, spell) => `‚ùå ${name} ${SpellIcons[spell] || '‚ùì'}${spell}Î≤à ÏòÅÏ∞Ω Ïã§Ìå®`,
            turnStart: (name) => `üîÑ ${name} ÌÑ¥ ÏãúÏûë`,
            turnEnd: (name) => `‚èπÔ∏è ${name} ÌÑ¥ Ï¢ÖÎ£å`,
            timeOut: () => `‚è∞ ÏãúÍ∞Ñ Ï¥àÍ≥º`,
            gameStart: (name) => `üéÆ ${name} Í≤åÏûÑ ÏãúÏûë`,
            gameOver: (winner) => `üèÜ ${winner} ÏäπÎ¶¨`,
            damage: (name, amount) => `üíî ${name} Ï≤¥Î†• -${amount}`,
            heal: (name, amount) => `üíö ${name} Ï≤¥Î†• +${amount}`,
            reveal: (stones) => `üîÆ ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú: ${stones.map(stone => `${SpellIcons[stone] || '‚ùì'}${stone}`).join(', ')}`,
            spy: (name) => `üåÄ ${name} Ï†ïÏã† ÍµêÎûÄ`,
            meditate: (stone) => `üí§ Î™ÖÏÉÅ: ${SpellIcons[stone] || '‚ùì'}${stone} Í≥µÍ∞ú`,
            surrender: (name) => `üè≥Ô∏è ${name} ÎèÑÎßù`,
            streak: (count) => `üî• ${count}Ïó∞Ïäπ`
        };

        /**
         * Í≤åÏûÑ Î°úÍ∑∏ Ï∂îÍ∞Ä Ìï®Ïàò
         * ÏïàÏ†ÑÌïú Î°úÍ∑∏ Ï∂îÍ∞ÄÏôÄ ÏÉÅÌÉú Í≤ÄÏ¶ùÏùÑ Ìè¨Ìï®
         * @param {string} message - Î°úÍ∑∏ Î©îÏãúÏßÄ
         */
        function addLog(message) {
            try {
            console.log(`üìù Í≤åÏûÑ Î°úÍ∑∏: ${message}`);
            
            // stateÎÇò gameLogÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
            if (!state) {
                state = {};
            }
            if (!state.gameLog) {
                state.gameLog = [];
            }
                
                // Î©îÏãúÏßÄ Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
                if (typeof message !== 'string' || message.trim() === '') {
                    console.warn('‚ö†Ô∏è Îπà Î©îÏãúÏßÄ ÎòêÎäî ÏûòÎ™ªÎêú ÌÉÄÏûÖÏùò Î°úÍ∑∏ ÏãúÎèÑ');
                    return;
                }
            
            state.gameLog.unshift(message);
                
                // Î°úÍ∑∏ Í∞úÏàò Ï†úÌïú
                if (state.gameLog.length > GAME_CONFIG.maxLogEntries) {
                    state.gameLog.pop();
                }
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateGameLog();
                
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏ Ï∂îÍ∞Ä Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
            }
        }

        /**
         * Í≤åÏûÑ Î°úÍ∑∏ UI ÏóÖÎç∞Ïù¥Ìä∏
         */
        function updateGameLog() {
            const gameLogEl = DOM.get('game-log');
            if (!gameLogEl || !state.gameLog) return;
            
            gameLogEl.innerHTML = state.gameLog.map(log => {
                const isSuccess = log.includes('‚úÖ');
                const isFailure = log.includes('‚ùå');
                const isTurn = log.includes('ÌÑ¥');
                const isGameEnd = log.includes('Í≤åÏûÑ Ï¢ÖÎ£å');
                
                let className = '';
                if (isSuccess) className = 'text-green-400';
                else if (isFailure) className = 'text-red-400';
                else if (isTurn) className = 'text-blue-400 font-bold';
                else if (isGameEnd) className = 'text-purple-400 font-bold';
                
                return `<p class="${className}">${log}</p>`;
            }).join('');
        }

        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Í¥ÄÎ†® Î≥ÄÏàòÎì§
        let longPressType = null;
        
        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ÏãúÏûë
        function startLongPress(type) {
            longPressType = type;
            showLongPressTooltip(type);
        }
        
        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ï¢ÖÎ£å
        function endLongPress() {
            longPressType = null;
        }
        
        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ìà¥ÌåÅ ÌëúÏãú
        function showLongPressTooltip(type) {
            if (type === 'secret') {
                showSecretStonesTooltip();
            } else if (type === 'used') {
                showUsedStonesTooltip();
            }
        }
        
        // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Ìà¥ÌåÅ ÌëúÏãú (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        function showSecretStonesTooltip() {
            const tooltip = DOM.get('secret-stones-tooltip');
            const personalSection = DOM.get('personal-revealed-section');
            const personalList = DOM.get('personal-revealed-list');
            const opponentPersonalSection = DOM.get('opponent-personal-revealed-section');
            const opponentPersonalList = DOM.get('opponent-personal-revealed-list');
            const publiclySection = DOM.get('publicly-revealed-section');
            const publiclyList = DOM.get('publicly-revealed-list');
            const secretSection = DOM.get('secret-stones-section');
            const secretList = DOM.get('secret-stones-list');
            
            // ÎèôÏ†Å Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
            updateTooltipCounts();
            
            // ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ ÌëúÏãú (ÎÇ¥Í∞Ä 1Î≤à Ï£ºÎ¨∏ÏúºÎ°ú Î∞úÍ≤¨Ìïú Í≤ΩÏö∞)
            if (state.personalRevealedStones && state.personalRevealedStones.length > 0) {
                const sortedPersonal = [...state.personalRevealedStones].sort((a, b) => a - b);
                const personalHtml = sortedPersonal.map(stone => 
                    `<div class="flex items-center justify-between">
                        <span class="text-sm">${SpellIcons[stone] || '‚ùì'}${stone}</span>
                        <span class="text-gray-500 text-sm">${getSpellName(stone)}</span>
                    </div>`
                ).join('');
                personalList.innerHTML = personalHtml;
                personalSection.classList.remove('hidden');
            } else {
                personalSection.classList.add('hidden');
            }
            
            // ÏÉÅÎåÄÏóêÍ≤åÎßå Í≥µÍ∞úÎêú Ï£ºÎ¨∏ ÌëúÏãú (ÏπòÌä∏ÌÇ§ Î™®ÎìúÏóêÏÑúÎäî Ï†ïÎ≥¥ ÌëúÏãú, ÏùºÎ∞ò Î™®ÎìúÏóêÏÑúÎäî Ïà®ÍπÄ)
            if (state.opponentPersonalRevealedStones && state.opponentPersonalRevealedStones.length > 0) {
                const sortedOpponentPersonal = [...state.opponentPersonalRevealedStones].sort((a, b) => a - b);
                const opponentPersonalHtml = sortedOpponentPersonal.map(stone => {
                    if (cheatMode) {
                        return `<div class="flex items-center justify-between">
                            <span class="text-sm">${SpellIcons[stone] || '‚ùì'}${stone}</span>
                            <span class="text-gray-500 text-sm">${getSpellName(stone)}</span>
                        </div>`;
                    } else {
                        return `<div class="flex items-center justify-between">
                            <span class="text-sm">‚ùì?</span>
                            <span class="text-gray-500 text-sm">???</span>
                        </div>`;
                    }
                }).join('');
                opponentPersonalList.innerHTML = opponentPersonalHtml;
                opponentPersonalSection.classList.remove('hidden');
            } else {
                opponentPersonalSection.classList.add('hidden');
            }
            
            // Ï†ÑÏ≤¥ Í≥µÍ∞úÎêú Ï£ºÎ¨∏ ÌëúÏãú (6Î≤à Ï£ºÎ¨∏ÏúºÎ°ú Î∞úÍ≤¨Îêú Í≤ΩÏö∞)
            if (state.publiclyRevealedSecretStones && state.publiclyRevealedSecretStones.length > 0) {
                const sortedPublicly = [...state.publiclyRevealedSecretStones].sort((a, b) => a - b);
                const publiclyHtml = sortedPublicly.map(stone => 
                    `<div class="flex items-center justify-between">
                        <span class="text-sm">${SpellIcons[stone] || '‚ùì'}${stone}</span>
                        <span class="text-gray-500 text-sm">${getSpellName(stone)}</span>
                    </div>`
                ).join('');
                publiclyList.innerHTML = publiclyHtml;
                publiclySection.classList.remove('hidden');
            } else {
                publiclySection.classList.add('hidden');
            }
            
            // ÏïÑÏßÅ Í≥µÍ∞úÎêòÏßÄ ÏïäÏùÄ ÎπÑÎ∞Ä Ï£ºÎ¨∏ ÌëúÏãú (ÏπòÌä∏ÌÇ§ Î™®ÎìúÏóêÏÑúÎäî Ï†ïÎ≥¥ ÌëúÏãú, ÏùºÎ∞ò Î™®ÎìúÏóêÏÑúÎäî Ïà®ÍπÄ)
            if (state.secretStones && state.secretStones.length > 0) {
                const sortedSecret = [...state.secretStones].sort((a, b) => a - b);
                const secretHtml = sortedSecret.map(stone => {
                    if (cheatMode) {
                        return `<div class="flex items-center justify-between">
                            <span class="text-sm">${SpellIcons[stone] || '‚ùì'}${stone}</span>
                            <span class="text-gray-500 text-sm">${getSpellName(stone)}</span>
                        </div>`;
                    } else {
                        return `<div class="flex items-center justify-between">
                            <span class="text-sm">‚ùì?</span>
                            <span class="text-gray-500 text-sm">???</span>
                        </div>`;
                    }
                }).join('');
                secretList.innerHTML = secretHtml;
            } else {
                secretList.innerHTML = '<div class="text-center text-gray-500">ÎπÑÎ∞Ä Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
            }
            
            tooltip.classList.remove('hidden');
        }
        
        /**
         * Ìà¥ÌåÅ ÏÑπÏÖò Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
         */
        function updateTooltipCounts() {
            const personalCount = state.personalRevealedStones ? state.personalRevealedStones.length : 0;
            const opponentPersonalCount = state.opponentPersonalRevealedStones ? state.opponentPersonalRevealedStones.length : 0;
            const publiclyCount = state.publiclyRevealedSecretStones ? state.publiclyRevealedSecretStones.length : 0;
            const secretCount = state.secretStones ? state.secretStones.length : 0;
            
            // Í∞úÏàò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const personalTitle = document.querySelector('#personal-revealed-section .text-blue-500');
            const opponentPersonalTitle = document.querySelector('#opponent-personal-revealed-section .text-orange-500');
            const publiclyTitle = document.querySelector('#publicly-revealed-section .text-green-500');
            const secretTitle = document.querySelector('#secret-stones-section .text-gray-500');
            
            if (personalTitle) personalTitle.textContent = `(${personalCount}Í∞ú)`;
            if (opponentPersonalTitle) opponentPersonalTitle.textContent = `(${opponentPersonalCount}Í∞ú)`;
            if (publiclyTitle) publiclyTitle.textContent = `(${publiclyCount}Í∞ú)`;
            if (secretTitle) secretTitle.textContent = `(${secretCount}Í∞ú)`;
        }
        
        // ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏ Ìà¥ÌåÅ ÌëúÏãú
        function showUsedStonesTooltip() {
            const tooltip = DOM.get('used-stones-tooltip');
            const list = DOM.get('used-stones-list');
            
            if (state.usedStones.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500">ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                // ÎÇÆÏùÄ ÏàòÎ∂ÄÌÑ∞ Ï†ïÎ†¨
                const sortedStones = [...state.usedStones].sort((a, b) => a - b);
                const stonesHtml = sortedStones.map(stone => 
                    `<div class="flex items-center justify-between">
                        <span class="text-sm">${SpellIcons[stone] || '‚ùì'}${stone}</span>
                        <span class="text-gray-500 text-sm">${getSpellName(stone)}</span>
                    </div>`
                ).join('');
                list.innerHTML = stonesHtml;
            }
            
            tooltip.classList.remove('hidden');
        }
        
        // Ï£ºÎ¨∏ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSpellName(spellNumber) {
            const spellNames = {
                1: 'Ïö¥Î™Ö Î≥ÄÌôò',
                2: 'ÎßàÎ†• Ï∞©Ï∑®',
                3: 'Ï†ïÏã† ÍµêÎûÄ',
                4: 'ÌôîÏóº ÌôîÏÇ¥',
                5: 'ÏÉùÎ™Ö Î¨ºÏïΩ',
                6: 'Î™ÖÏÉÅ'
            };
            return spellNames[spellNumber] || `Ï£ºÎ¨∏ ${spellNumber}`;
        }
        
        // Ìà¥ÌåÅ Ïà®Í∏∞Í∏∞ (ÌÅ¥Î¶≠ Ïãú)
        function hideTooltips() {
            const secretTooltip = DOM.get('secret-stones-tooltip');
            const usedTooltip = DOM.get('used-stones-tooltip');
            secretTooltip.classList.add('hidden');
            usedTooltip.classList.add('hidden');
        }
        
        // Ìà¥ÌåÅ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('click', function(event) {
            const secretTooltip = DOM.get('secret-stones-tooltip');
            const usedTooltip = DOM.get('used-stones-tooltip');
            
            // Ìà¥ÌåÅ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Ïà®Í∏∞Í∏∞
            if (!secretTooltip.contains(event.target) && !usedTooltip.contains(event.target)) {
                hideTooltips();
            }
        });
        
        // ÏπòÌä∏ÌÇ§ ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.addEventListener('keydown', function(event) {
            if (event.key === '-') {
                toggleCheatMode();
            }
        });
        
        // ÎèÑÏõÄÎßê Ìà¥ÌåÅ Ìï®ÏàòÎì§
        function showHelpTooltip() {
            const tooltip = DOM.get('help-tooltip');
            tooltip.classList.remove('hidden');
        }
        
        function hideHelpTooltip() {
            const tooltip = DOM.get('help-tooltip');
            tooltip.classList.add('hidden');
        }
        
        /**
         * ÏπòÌä∏ÌÇ§ Î™®Îìú ÌÜ†Í∏Ä
         */
        function toggleCheatMode() {
            cheatMode = !cheatMode;
            console.log(`üîß ÏπòÌä∏ÌÇ§ Î™®Îìú: ${cheatMode ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            render();
            
            // ÏπòÌä∏ÌÇ§ ÏÉÅÌÉú ÌëúÏãú
            const status = cheatMode ? 'üîß ÏπòÌä∏ÌÇ§ ÌôúÏÑ±ÌôîÎê®' : 'üîß ÏπòÌä∏ÌÇ§ ÎπÑÌôúÏÑ±ÌôîÎê®';
            addLog(status);
            
            // 3Ï¥à ÌõÑ ÏπòÌä∏ÌÇ§ ÏÉÅÌÉú Î©îÏãúÏßÄ Ï†úÍ±∞
            setTimeout(() => {
                if (state.gameLog && state.gameLog.length > 0) {
                    state.gameLog = state.gameLog.filter(log => !log.includes('ÏπòÌä∏ÌÇ§'));
                    updateGameLog();
                }
            }, 3000);
        }
        
        // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í¥ÄÎ†® Î≥ÄÏàòÎì§
        let multiplayerMode = false;
        let peerConnection = null;
        let dataChannel = null;
        let matchingInterval = null;
        let aiDifficulty = 'normal'; // 'easy', 'normal', 'hard'
        let isHost = false;
        let playerName = '';
        let opponentName = '';
        let opponentIcon = 'üë§'; // ÏÉÅÎåÄÎ∞© ÏïÑÏù¥ÏΩò Í∏∞Î≥∏Í∞í
        let myPlayerId = null;
        let localMemoNotes = {}; // Í∞úÎ≥Ñ ÌîåÎ†àÏù¥Ïñ¥Ïùò Î©îÎ™® ÎÖ∏Ìä∏ (Î°úÏª¨ ÏÉÅÌÉú)
        let localMemoPanelActive = false; // Í∞úÎ≥Ñ ÌîåÎ†àÏù¥Ïñ¥Ïùò Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú (Î°úÏª¨ ÏÉÅÌÉú)
        
        // ÏπòÌä∏ÌÇ§ Í¥ÄÎ†® Î≥ÄÏàò
        let cheatMode = false; // ÏπòÌä∏ÌÇ§ ÌôúÏÑ±Ìôî ÏÉÅÌÉú
        
        // Socket.IO Ïó∞Í≤∞
        let socket = null;
        let serverConnected = false;
        
        // Ï†ÑÏ†Å Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function loadStats() {
            const stats = localStorage.getItem('tacticalCardBattleStats');
            if (stats) {
                const parsedStats = JSON.parse(stats);
                
                // Í∏∞Ï°¥ ÌòïÏãùÍ≥º ÏÉàÎ°úÏö¥ ÌòïÏãù Ìò∏ÌôòÏÑ± Ï≤òÎ¶¨
                if (parsedStats.wins !== undefined || parsedStats.losses !== undefined) {
                    console.log('Í∏∞Ï°¥ ÌòïÏãù Îç∞Ïù¥ÌÑ∞Î•º ÏÉàÎ°úÏö¥ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôòÌï©ÎãàÎã§.');
                    const newStats = {
                        mock: { 
                            wins: parsedStats.wins || 0, 
                            losses: parsedStats.losses || 0 
                        },
                        formal: { wins: 0, losses: 0 }
                    };
                    // ÏÉàÎ°úÏö¥ ÌòïÏãùÏúºÎ°ú Ï†ÄÏû•
                    saveStats(newStats);
                    return newStats;
                }
                
                return parsedStats;
            }
            return { 
                mock: { wins: 0, losses: 0 },
                formal: { wins: 0, losses: 0 }
            };
        }
        
        function saveStats(stats) {
            localStorage.setItem('tacticalCardBattleStats', JSON.stringify(stats));
        }
        
        function updateStats(isWin, isMultiplayer = false) {
            const stats = loadStats();
            const category = isMultiplayer ? 'formal' : 'mock';
            
            console.log(`üìä updateStats Ìò∏Ï∂ú: ÏäπÎ¶¨=${isWin}, Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥=${isMultiplayer}, Ïπ¥ÌÖåÍ≥†Î¶¨=${category}`);
            console.log(`üìä Ïó∞Ïäπ Ï≤òÎ¶¨ Ï†Ñ: ÌòÑÏû¨ ${currentWinStreak}Ïó∞Ïäπ, ÏµúÍ≥† ${maxWinStreak}Ïó∞Ïäπ`);
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
            if (!stats[category]) {
                stats[category] = { wins: 0, losses: 0 };
            }
            
            if (isWin) {
                stats[category].wins++;
                currentWinStreak++;
                if (currentWinStreak > maxWinStreak) {
                    maxWinStreak = currentWinStreak;
                }
                console.log(`üèÜ ÏäπÎ¶¨! Ïó∞Ïäπ Ï¶ùÍ∞Ä: ${currentWinStreak}Ïó∞Ïäπ (ÏµúÍ≥†: ${maxWinStreak}Ïó∞Ïäπ)`);
                console.log(`üìä Ïó∞Ïäπ Ï†ÄÏû•: localStorageÏóê ${currentWinStreak}Ïó∞Ïäπ Ï†ÄÏû•`);
            } else {
                stats[category].losses++;
                currentWinStreak = 0;
                console.log(`üíî Ìå®Î∞∞! Ïó∞Ïäπ Î¶¨ÏÖã: 0Ïó∞Ïäπ`);
                console.log(`üìä Ïó∞Ïäπ Ï†ÄÏû•: localStorageÏóê 0Ïó∞Ïäπ Ï†ÄÏû•`);
            }
            
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
            localStorage.setItem('currentWinStreak', currentWinStreak.toString());
            localStorage.setItem('maxWinStreak', maxWinStreak.toString());
            saveStats(stats);
            
            // Ï¶ùÌëú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const trophies = TrophySystem.loadTrophies();
            const trophyCount = isMultiplayer ? trophies.multiplayer : trophies.ai;
            
            // Îû≠ÌÇπ ÏóÖÎç∞Ïù¥Ìä∏ (ÏäπÎ¶¨/Ìå®Î∞∞ Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏)
            const playerName = localStorage.getItem('playerName') || 'Player';
            const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
            
            // Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Í≥ÑÏÇ∞
            const allTrophies = TrophySystem.loadTrophies();
            const otherCategory = isMultiplayer ? 'mock' : 'formal';
            const otherScore = isMultiplayer ? allTrophies.ai : allTrophies.multiplayer;
            
            if (socket) {
                // ÌòÑÏû¨ Ï†êÏàòÎ°ú Îû≠ÌÇπ ÏóÖÎç∞Ïù¥Ìä∏
                socket.emit('updateRanking', {
                    category: category,
                    playerName: playerName,
                    score: trophyCount,
                    icon: playerIcon
                });
                
                // Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨ÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏ (Ï†ÑÏ≤¥ Îû≠ÌÇπ ÎèôÍ∏∞Ìôî)
                socket.emit('updateRanking', {
                    category: otherCategory,
                    playerName: playerName,
                    score: otherScore,
                    icon: playerIcon
                });
            }
            
            console.log(`üìä Ï†ÑÏ†Å ÏóÖÎç∞Ïù¥Ìä∏: ${category} - ${playerName} (Ï¶ùÌëú: ${trophyCount}, ÏäπÎ¶¨: ${stats[category].wins}, Ìå®Î∞∞: ${stats[category].losses})`);
            console.log(`üìä Îû≠ÌÇπ ÎèôÍ∏∞Ìôî: ${otherCategory} - ${playerName} (Ï¶ùÌëú: ${otherScore})`);
        }
        

        
        // Îû≠ÌÇπ Î™®Îã¨ ÌëúÏãú Ìï®Ïàò
        function showRankingModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">üèÜ</div>
                        <h3 class="text-xl font-bold mb-2">ÎßàÎ≤ï Îû≠ÌÇπ</h3>
                        <p class="text-gray-600">Î™®Îì† ÎßàÎ≤ïÏÇ¨Ïùò ÏäπÎ¶¨Ïùò Ï¶ùÌëúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Î™®Ïùò Í≤∞Ìà¨ Îû≠ÌÇπ -->
                        <div class="bg-gray-100 rounded-lg p-4">
                            <h4 class="text-lg font-bold mb-4 text-center">üé≠ Î™®Ïùò Í≤∞Ìà¨ Îû≠ÌÇπ</h4>
                            <div id="mock-ranking-list" class="space-y-2">
                                <div class="text-center text-gray-500">Î°úÎî© Ï§ë...</div>
                            </div>
                        </div>
                        
                        <!-- Ï†ïÏãù Í≤∞Ìà¨ Îû≠ÌÇπ -->
                        <div class="bg-gray-100 rounded-lg p-4">
                            <h4 class="text-lg font-bold mb-4 text-center">‚öîÔ∏è Ï†ïÏãù Í≤∞Ìà¨ Îû≠ÌÇπ</h4>
                            <div id="formal-ranking-list" class="space-y-2">
                                <div class="text-center text-gray-500">Î°úÎî© Ï§ë...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6 space-x-2">
                        <button id="refresh-ranking-btn" class="px-4 py-2 rounded-lg font-bold bg-blue-600 hover:bg-blue-700 text-white">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <button id="close-ranking-btn" class="px-6 py-2 rounded-lg font-bold btn-secondary">Îã´Í∏∞</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadRankingData();
            
            // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            const refreshBtn = modal.querySelector('#refresh-ranking-btn');
            refreshBtn.addEventListener('click', () => {
                console.log('üîÑ ÏÇ¨Ïö©ÏûêÍ∞Ä Îû≠ÌÇπ ÏÉàÎ°úÍ≥†Ïπ® ÏöîÏ≤≠');
                loadRankingData();
            });
            
            // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            const closeBtn = modal.querySelector('#close-ranking-btn');
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò
        function loadRankingData() {
            console.log('üîÑ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ï§ë...');
            
            // Î™®Ïùò Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú
            fetch('/api/rankings/mock')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('üìä Î™®Ïùò Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú ÏôÑÎ£å:', data.rankings.length + 'Î™Ö');
                        displayRanking('mock-ranking-list', data.rankings, 'üé≠');
                    }
                })
                .catch(error => {
                    console.error('Î™®Ïùò Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú Ïò§Î•ò:', error);
                    document.getElementById('mock-ranking-list').innerHTML = '<div class="text-center text-red-500">Î°úÎî© Ïã§Ìå®</div>';
                });
            
            // Ï†ïÏãù Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú
            fetch('/api/rankings/formal')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('üìä Ï†ïÏãù Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú ÏôÑÎ£å:', data.rankings.length + 'Î™Ö');
                        displayRanking('formal-ranking-list', data.rankings, '‚öîÔ∏è');
                    }
                })
                .catch(error => {
                    console.error('Ï†ïÏãù Í≤∞Ìà¨ Îû≠ÌÇπ Î°úÎìú Ïò§Î•ò:', error);
                    document.getElementById('formal-ranking-list').innerHTML = '<div class="text-center text-red-500">Î°úÎî© Ïã§Ìå®</div>';
                });
        }
        
        // Îû≠ÌÇπ ÌëúÏãú Ìï®Ïàò
        function displayRanking(containerId, rankings, icon) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (rankings.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500">ÏïÑÏßÅ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            let html = '';
            rankings.forEach((rank, index) => {
                const rankClass = index === 0 ? 'bg-yellow-100 border-yellow-300' : 
                                index === 1 ? 'bg-gray-100 border-gray-300' : 
                                index === 2 ? 'bg-orange-100 border-orange-300' : 
                                'bg-white border-gray-200';
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                
                html += `
                    <div class="flex items-center justify-between p-3 border rounded-lg ${rankClass}">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-bold">${rankIcon}</span>
                            <span class="font-semibold">${rank.nickname}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600">${rank.score}Ï†ê</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showProfileModal() {
            // ÏÑúÎ≤ÑÏóêÏÑú ÏµúÏã† Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch(`/api/profile/${currentUserData.userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Ïú†Ï†Ä Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error', 3000);
                    return;
                }
                
                const userData = data.userData;
                const stats = loadStats();
                const mockStats = stats.mock || { wins: 0, losses: 0 };
                const formalStats = stats.formal || { wins: 0, losses: 0 };
                
                const mockTotalGames = mockStats.wins + mockStats.losses;
                const formalTotalGames = formalStats.wins + formalStats.losses;
                
                const mockWinRate = mockTotalGames > 0 ? ((mockStats.wins / mockTotalGames) * 100).toFixed(1) : 0;
                const formalWinRate = formalTotalGames > 0 ? ((formalStats.wins / formalTotalGames) * 100).toFixed(1) : 0;
                
                // Î°úÍ∑∏Ïù∏Ìïú Í≥ÑÏ†ïÏùò ÎãâÎÑ§ÏûÑ ÏÇ¨Ïö©
                const playerName = userData.nickname || '';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                
                // Ïó∞Ïäπ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const currentWinStreak = parseInt(localStorage.getItem('currentWinStreak')) || 0;
                const maxWinStreak = parseInt(localStorage.getItem('maxWinStreak')) || 0;
                
                // ÏÑúÎ≤ÑÏùò Ìä∏Î°úÌîº Ï†ïÎ≥¥ ÏÇ¨Ïö©
                const trophies = userData.trophies || { mock: 0, formal: 0 };
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-lg w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">ÎßàÎ≤ï Ïù¥Î†•ÏÑú</h3>
                    <div class="space-y-4">
                        <div class="text-center">
                            <label class="block text-sm font-bold mb-2">ÏßÄÌå°Ïù¥ Ï£ºÏù∏ Ïù¥Î¶Ñ</label>
                            <div class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-center">
                                ${playerName || 'Ïù¥Î¶ÑÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§'}
                            </div>
                        </div>
                        <div class="text-center">
                            <label class="block text-sm font-bold mb-2">ÎåÄÌëú ÏïÑÏù¥ÏΩò</label>
                            <div class="flex items-center justify-center space-x-3">
                                <div class="text-3xl">${playerIcon}</div>
                                <button id="change-icon-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                                    ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω
                                </button>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="text-center">
                                <h4 class="text-lg font-bold mb-3 text-yellow-300">ü§ñ Î™®Ïùò Í≤∞Ìà¨ ÎåÄÏ†Ñ Í∏∞Î°ù</h4>
                                <div class="grid grid-cols-4 gap-2">
                                    <div class="bg-emerald-600 bg-opacity-40 p-2 rounded-lg border border-emerald-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-emerald-100">${mockStats.wins}</div>
                                        <div class="text-xs text-emerald-50 font-semibold">ÏäπÎ¶¨</div>
                                    </div>
                                    <div class="bg-rose-600 bg-opacity-40 p-2 rounded-lg border border-rose-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-rose-100">${mockStats.losses}</div>
                                        <div class="text-xs text-rose-50 font-semibold">Ìå®Î∞∞</div>
                                    </div>
                                    <div class="bg-cyan-600 bg-opacity-40 p-2 rounded-lg border border-cyan-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-cyan-100">${mockTotalGames}Ï†Ñ</div>
                                        <div class="text-xs text-cyan-50 font-semibold">Ï¥ù Í≤åÏûÑ</div>
                                    </div>
                                    <div class="bg-violet-600 bg-opacity-40 p-2 rounded-lg border border-violet-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-violet-100">${mockWinRate}%</div>
                                        <div class="text-xs text-violet-50 font-semibold">ÏäπÎ•†</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-bold mb-3 text-green-300">üë• Ï†ïÏãù Í≤∞Ìà¨ ÎåÄÏ†Ñ Í∏∞Î°ù</h4>
                                <div class="grid grid-cols-4 gap-2">
                                    <div class="bg-teal-600 bg-opacity-40 p-2 rounded-lg border border-teal-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-teal-100">${formalStats.wins}</div>
                                        <div class="text-xs text-teal-50 font-semibold">ÏäπÎ¶¨</div>
                                    </div>
                                    <div class="bg-pink-600 bg-opacity-40 p-2 rounded-lg border border-pink-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-pink-100">${formalStats.losses}</div>
                                        <div class="text-xs text-pink-50 font-semibold">Ìå®Î∞∞</div>
                                    </div>
                                    <div class="bg-indigo-600 bg-opacity-40 p-2 rounded-lg border border-indigo-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-indigo-100">${formalTotalGames}Ï†Ñ</div>
                                        <div class="text-xs text-indigo-50 font-semibold">Ï¥ù Í≤åÏûÑ</div>
                                    </div>
                                    <div class="bg-fuchsia-600 bg-opacity-40 p-2 rounded-lg border border-fuchsia-400 border-opacity-30 shadow-lg">
                                        <div class="text-sm font-bold text-fuchsia-100">${formalWinRate}%</div>
                                        <div class="text-xs text-fuchsia-50 font-semibold">ÏäπÎ•†</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-bold mb-3 text-orange-300">üî• Ïó∞Ïäπ Í∏∞Î°ù</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-amber-600 bg-opacity-40 p-3 rounded-lg border border-amber-400 border-opacity-30 shadow-lg">
                                        <div class="text-xl font-bold text-amber-100">${maxWinStreak}Ïó∞Ïäπ</div>
                                        <div class="text-xs text-amber-50 font-semibold">ÏµúÍ≥† Ïó∞Ïäπ</div>
                                    </div>
                                    <div class="bg-lime-600 bg-opacity-40 p-3 rounded-lg border border-lime-400 border-opacity-30 shadow-lg">
                                        <div class="text-xl font-bold text-lime-100">${currentWinStreak}Ïó∞Ïäπ</div>
                                        <div class="text-xs text-lime-50 font-semibold">ÌòÑÏû¨ Ïó∞Ïäπ</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-bold mb-3 text-yellow-300">üèÜ ÏäπÎ¶¨Ïùò Ï¶ùÌëú</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-yellow-600 bg-opacity-40 p-3 rounded-lg border border-yellow-400 border-opacity-30 shadow-lg">
                                        <div class="text-xl font-bold text-yellow-100">üèÖ ${trophies.mock}Í∞ú</div>
                                        <div class="text-xs text-yellow-50 font-semibold">Î™®Ïùò Í≤∞Ìà¨ Ï†êÏàò</div>
                                    </div>
                                    <div class="bg-red-600 bg-opacity-40 p-3 rounded-lg border border-red-400 border-opacity-30 shadow-lg">
                                        <div class="text-xl font-bold text-red-100">üèÖ ${trophies.formal}Í∞ú</div>
                                        <div class="text-xs text-red-50 font-semibold">Ï†ïÏãù Í≤∞Ìà¨ Ï†êÏàò</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-4">
                        <button id="close-profile-btn" class="px-6 py-3 rounded-lg font-bold btn-secondary">Îã´Í∏∞</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
                // ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                const changeIconBtn = modal.querySelector('#change-icon-btn');
                changeIconBtn.addEventListener('click', () => {
                    showIconSelectionModal().then(() => {
                        // ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù ÌõÑ Î™®Îã¨ Îã´Í∏∞
                        document.body.removeChild(modal);
                    });
                });
                
                const closeBtn = modal.querySelector('#close-profile-btn');
                
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            })
            .catch(error => {
                console.error('ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error);
                showToast('Ïú†Ï†Ä Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error', 3000);
            });
        }
        
        // Ï°∞ÏÇ¨ Ï≤òÎ¶¨ Ìï®Ïàò
        function getJosa(name, josa) {
            const lastName = name.charAt(name.length - 1);
            const hasBatchim = (lastName.charCodeAt(0) - 44032) % 28 !== 0;
            
            switch(josa) {
                case 'ÏùÄ/Îäî':
                    return hasBatchim ? 'ÏùÄ' : 'Îäî';
                case 'Ïù¥/Í∞Ä':
                    return hasBatchim ? 'Ïù¥' : 'Í∞Ä';
                case 'ÏùÑ/Î•º':
                    return hasBatchim ? 'ÏùÑ' : 'Î•º';
                case 'Ïùò':
                    return 'Ïùò';
                default:
                    return '';
            }
        }

        function updatePlayerName() {
            const playerName = localStorage.getItem('playerName') || 'Player';
            const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
            const myTitle = DOM.get('my-title');
            if (myTitle) {
                myTitle.textContent = `ÎÇò (${getPlayerDisplayName()})`;
            }
            
            // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥Ïùò ÏïÑÏù¥ÏΩò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const currentIconDisplay = DOM.get('current-icon-display');
            if (currentIconDisplay) {
                currentIconDisplay.textContent = playerIcon;
            }
        }
        
        function updateOpponentName() {
            const opponentArea = DOM.get('opponent-area');
            const opponentTitle = opponentArea.querySelector('h2');
            if (opponentTitle) {
                let opponentDisplayName;
                let titleClass = 'text-xl font-bold text-green-300';
                
                if (multiplayerMode) {
                    // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®Îìú: Ïã§Ï†ú Ïú†Ï†Ä (ÏÉÅÎåÄÎ∞© ÏïÑÏù¥ÏΩò ÏÇ¨Ïö©)
                    opponentDisplayName = `${opponentIcon} ${opponentName || 'Player'}`;
                } else {
                    // Ïã±Í∏ÄÌîåÎ†àÏù¥Ïñ¥ Î™®Îìú: AI (Î°úÎ¥á ÏïÑÏù¥ÏΩò)
                    switch(aiDifficulty) {
                        case 'easy':
                            opponentDisplayName = 'ü§ñ Ïâ¨ÏõÄ ÌóàÏàòÏïÑÎπÑ';
                            titleClass = 'text-xl font-bold text-green-300';
                            break;
                        case 'normal':
                            opponentDisplayName = 'ü§ñ Î≥¥ÌÜµ ÌóàÏàòÏïÑÎπÑ';
                            titleClass = 'text-xl font-bold text-yellow-300';
                            break;
                        case 'hard':
                            opponentDisplayName = 'ü§ñ Ïñ¥Î†§ÏõÄ ÌóàÏàòÏïÑÎπÑ';
                            titleClass = 'text-xl font-bold text-red-300';
                            break;
                        default:
                            opponentDisplayName = 'ü§ñ Ïñ¥Î†§ÏõÄ ÌóàÏàòÏïÑÎπÑ';
                            titleClass = 'text-xl font-bold text-red-300';
                    }
                }
                
                opponentTitle.textContent = `ÏÉÅÎåÄ (${opponentDisplayName})`;
                opponentTitle.className = titleClass;
                console.log('üë§ ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏:', opponentDisplayName, 'Î™®Îìú:', multiplayerMode ? 'Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥' : 'Ïã±Í∏ÄÌîåÎ†àÏù¥Ïñ¥');
            }
        }
        
        function showSurrenderConfirmModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                                                <h3 class="text-xl font-bold mb-4">ÎèÑÎßù</h3>
                        <p class="text-gray-300 mb-6">Ï†ïÎßê ÎèÑÎßùÏπòÏãúÍ≤†ÏäµÎãàÍπå?</p>
                        <div class="flex space-x-3">
                            <button id="confirm-surrender-btn" class="flex-1 py-3 rounded-lg font-bold bg-red-600 hover:bg-red-700 text-white">ÎÑ§..</button>
                            <button id="cancel-surrender-btn" class="flex-1 py-3 rounded-lg font-bold btn-primary">ÏïÑÎãàÏò§</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            return new Promise(resolve => {
                const confirmBtn = modal.querySelector('#confirm-surrender-btn');
                const cancelBtn = modal.querySelector('#cancel-surrender-btn');
                
                confirmBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
                
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });
            });
                }
        
        // ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù Î™®Îã¨
        function showIconSelectionModal() {
            const currentIcon = localStorage.getItem('playerIcon') || 'üë§';
            const icons = [
                'üë§', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üëë', '‚ö°', 'üî•', '‚ùÑÔ∏è', 'üåô', '‚≠ê', 'üíé',
                'ü¶Ñ', 'üêâ', 'ü¶Ö', 'ü¶ä', 'üê∫', 'ü¶Å', 'üêØ', 'üê∏', 'ü¶ã', 'üå∫'
            ];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-bg';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <h3 class="text-xl font-bold mb-4">ÎåÄÌëú ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù</h3>
                        <p class="text-gray-300 mb-6">ÏûêÏã†ÏùÑ ÎÇòÌÉÄÎÇº ÏïÑÏù¥ÏΩòÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                        <div class="grid grid-cols-5 gap-3 mb-6">
                            ${icons.map(icon => `
                                <button class="icon-btn p-3 text-2xl rounded-lg border-2 transition-all hover:scale-110 ${
                                    icon === currentIcon ? 'border-blue-500 bg-blue-100 bg-opacity-20' : 'border-gray-600 hover:border-blue-400'
                                }" data-icon="${icon}">
                                    ${icon}
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex space-x-3">
                            <button id="confirm-icon-btn" class="flex-1 py-3 rounded-lg font-bold btn-primary">ÌôïÏù∏</button>
                            <button id="cancel-icon-btn" class="flex-1 py-3 rounded-lg font-bold btn-secondary">Ï∑®ÏÜå</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playCardSound();
            
            let selectedIcon = currentIcon;
            
            // ÏïÑÏù¥ÏΩò Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            const iconButtons = modal.querySelectorAll('.icon-btn');
            iconButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
                    iconButtons.forEach(b => {
                        b.classList.remove('border-blue-500', 'bg-blue-100', 'bg-opacity-20');
                        b.classList.add('border-gray-600');
                    });
                    
                    // ÌòÑÏû¨ ÏÑ†ÌÉù ÌëúÏãú
                    btn.classList.remove('border-gray-600');
                    btn.classList.add('border-blue-500', 'bg-blue-100', 'bg-opacity-20');
                    
                    selectedIcon = btn.dataset.icon;
                });
            });
            
            return new Promise(resolve => {
                const confirmBtn = modal.querySelector('#confirm-icon-btn');
                const cancelBtn = modal.querySelector('#cancel-icon-btn');
                
                confirmBtn.addEventListener('click', () => {
                    localStorage.setItem('playerIcon', selectedIcon);
                    
                    // Î°úÍ∑∏Ïù∏Ìïú ÏÉÅÌÉúÎùºÎ©¥ ÏÑúÎ≤ÑÏóêÎèÑ ÏïÑÏù¥ÏΩò Ï†ÄÏû•
                    if (isLoggedIn && currentUserData && currentSessionId) {
                        fetch('/api/change-icon', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                sessionId: currentSessionId,
                                icon: selectedIcon
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showToast('ÎåÄÌëú ÏïÑÏù¥ÏΩòÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success', 2000);
                                // ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                                if (currentUserData) {
                                    currentUserData.icon = selectedIcon;
                                    console.log('‚úÖ ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω ÏôÑÎ£å:', selectedIcon);
                                }
                            } else {
                                showToast('ÏïÑÏù¥ÏΩò Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error', 3000);
                                console.error('‚ùå ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω Ïã§Ìå®:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                            showToast('ÏïÑÏù¥ÏΩò Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error', 3000);
                        });
                    } else {
                        showToast('ÎåÄÌëú ÏïÑÏù¥ÏΩòÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success', 2000);
                    }
                    
                    updatePlayerName(); // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏Î°ú ÏïÑÏù¥ÏΩòÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
                    updateAccountUI(); // Í≥ÑÏ†ï UI ÏóÖÎç∞Ïù¥Ìä∏
                    document.body.removeChild(modal);
                    resolve();
                });
                
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve();
                });
            });
        }
        

        // Socket.IO Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî
        function initializeSocketIO() {
            if (socket) {
                socket.disconnect();
            }
            
            // Socket.IO Ïó∞Í≤∞ (Í∞úÏÑ†Îêú ÏÑ§Ï†ï)
            // Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎäî localhost, Î∞∞Ìè¨ ÌôòÍ≤ΩÏóêÏÑúÎäî ÏõêÍ≤© ÏÑúÎ≤Ñ ÏÇ¨Ïö©
            const serverUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:3000' 
                : `https://${window.location.hostname}`;
            
            console.log(`üîå ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏãúÎèÑ: ${serverUrl}`);
            socket = io(serverUrl, {
                transports: ['websocket', 'polling'],
                timeout: 60000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('üîå Socket.IO Ïó∞Í≤∞ ÏÑ±Í≥µ');
                serverConnected = true;
                
                // Ïó∞Í≤∞ ÏÑ±Í≥µ Ïãú Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® (Îû≠ÌÇπ Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÎäî Í≤ΩÏö∞)
                const rankingModal = document.querySelector('.modal-bg');
                if (rankingModal && rankingModal.innerHTML.includes('ÎßàÎ≤ï Îû≠ÌÇπ')) {
                    console.log('üîÑ Îû≠ÌÇπ Î™®Îã¨ Í∞êÏßÄ - Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
                    // Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÏûêÎèô ÏöîÏ≤≠
                    if (socket && socket.connected) {
                        socket.emit('getRanking', { category: 'ai' });
                        socket.emit('getRanking', { category: 'multiplayer' });
                        socket.emit('getRanking', { category: 'daily' });
                    }
                }
            });
            
            socket.on('disconnect', () => {
                console.log('üîå Socket.IO Ïó∞Í≤∞ Ìï¥Ï†ú');
                serverConnected = false;
                addLog('üîå ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.');
                
                // Ïó∞Í≤∞ Ìï¥Ï†ú Ïãú Îû≠ÌÇπ Î™®Îã¨Ïóê ÏóêÎü¨ ÌëúÏãú
                const rankingModal = document.querySelector('.modal-bg');
                if (rankingModal && rankingModal.innerHTML.includes('ÎßàÎ≤ï Îû≠ÌÇπ')) {
                    const containers = ['ai-ranking', 'multiplayer-ranking', 'daily-king-ranking'];
                    containers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.innerHTML = `
                                <div class="text-center text-red-400">
                                    <div class="text-lg mb-2">üîå</div>
                                    <div class="text-sm">ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ìï¥Ï†ú</div>
                                    <div class="text-xs mt-1">Ïó∞Í≤∞ Î≥µÍµ¨ Ïãú ÏûêÎèôÏúºÎ°ú ÏÉàÎ°úÍ≥†Ïπ®Îê©ÎãàÎã§</div>
                                </div>
                            `;
                        }
                    });
                }
            });
            
            // Ïó∞Í≤∞ Ïû¨ÏãúÎèÑ
            socket.on('reconnect', (attemptNumber) => {
                console.log(`üîÑ Socket.IO Ïû¨Ïó∞Í≤∞ ÏÑ±Í≥µ (ÏãúÎèÑ ${attemptNumber})`);
                serverConnected = true;
                addLog('üîÑ ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.');
            });
            
            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log(`üîÑ Socket.IO Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ${attemptNumber}`);
            });
            
            socket.on('reconnect_failed', () => {
                console.log('‚ùå Socket.IO Ïû¨Ïó∞Í≤∞ Ïã§Ìå®');
                addLog('‚ùå ÏÑúÎ≤Ñ Ïû¨Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
            
            socket.on('serverStats', (stats) => {
                console.log('üìä ÏÑúÎ≤Ñ ÏÉÅÌÉú:', stats);
            });
            
            socket.on('waitingForMatch', (data) => {
                console.log('‚è≥ Îß§Ïπ≠ ÎåÄÍ∏∞ Ï§ë:', data);
                updateMatchingMessage(data.message);
            });
            
            socket.on('matchFound', (data) => {
                console.log('‚úÖ Îß§Ïπ≠ ÏÑ±Í≥µ:', data);
                opponentName = data.opponent.name;
                isHost = data.isHost;
                
                // ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                updateOpponentName();
                
                // Îß§Ïπ≠ Î™®Îã¨ Ïà®Í∏∞Í∏∞
            const matchingModal = DOM.get('matching-modal');
                matchingModal.classList.add('hidden');
                
                // WebRTC Ïó∞Í≤∞ ÏãúÏûë
                initializeWebRTC(data.opponent.id);
            });
            
            socket.on('opponentDisconnected', (data) => {
                console.log('‚ùå ÏÉÅÎåÄÎ∞© Ïó∞Í≤∞ Ìï¥Ï†ú:', data);
                addLog(`ÏÉÅÎåÄÎ∞© ${data.disconnectedPlayerName || 'Unknown'}Ïù¥(Í∞Ä) Ïó∞Í≤∞ÏùÑ Ìï¥Ï†úÌñàÏäµÎãàÎã§.`);
                
                // ÏÉÅÎåÄÎ∞©Ïù¥ Í∞ïÏ†úÏ¢ÖÎ£åÌïú Í≤ΩÏö∞ ÎèÑÎßùÏúºÎ°ú Ïù∏Ìïú ÏäπÎ¶¨ Ï≤òÎ¶¨
                if (multiplayerMode && state && state.gameStarted && !state.isGameOver) {
                    handleOpponentDisconnect(data.disconnectedPlayerName);
                    
                    // Í∞ïÏ†úÏ¢ÖÎ£åÌïú ÌîåÎ†àÏù¥Ïñ¥Ïùò Ìå®Î∞∞ÎèÑ Í∏∞Î°ù (ÏÑúÎ≤ÑÏóê Ï†ÑÏÜ°)
                    if (data.isDisconnectedAsLoser && data.disconnectedPlayerName) {
                        // Í∞ïÏ†úÏ¢ÖÎ£åÌïú ÌîåÎ†àÏù¥Ïñ¥Ïùò Ìå®Î∞∞ Í∏∞Î°ùÏùÑ ÏÑúÎ≤ÑÏóê Ï†ÑÏÜ°
                        socket.emit('updateRanking', {
                            category: 'multiplayer',
                            playerName: data.disconnectedPlayerName,
                            stats: {
                                wins: 0,
                                losses: 1,
                                currentWinStreak: 0,
                                maxWinStreak: 0,
                                trophies: 0
                            }
                        });
                    }
                } else {
                    setTimeout(() => {
                        showTitleScreen();
                    }, 2000);
                }
            });
            
            // WebRTC ÏãúÍ∑∏ÎÑêÎßÅ Ïù¥Î≤§Ìä∏
            socket.on('offer', (data) => {
                console.log('üì• Offer ÏàòÏã†:', data);
                handleOffer(data.from, data.offer);
            });
            
            socket.on('answer', (data) => {
                console.log('üì• Answer ÏàòÏã†:', data);
                handleAnswer(data.from, data.answer);
            });
            
            socket.on('iceCandidate', (data) => {
                console.log('üì• ICE Candidate ÏàòÏã†:', data);
                handleIceCandidate(data.from, data.candidate);
            });
            
            // ÏÑúÎ≤Ñ ÏóêÎü¨ Ï≤òÎ¶¨
            socket.on('error', (error) => {
                console.error('‚ùå ÏÑúÎ≤Ñ ÏóêÎü¨:', error);
                addLog(`‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò: ${error.message}`);
                
                // Ïó∞Í≤∞ Ïû¨ÏãúÎèÑ
                if (error.context === 'offer' || error.context === 'answer') {
                    setTimeout(() => {
                        console.log('üîÑ WebRTC Ïó∞Í≤∞ Ïû¨ÏãúÎèÑ...');
                        if (peerConnection) {
                            peerConnection.close();
                            peerConnection = null;
                        }
                        initializeWebRTC(opponentId);
                    }, 2000);
                }
            });
            
            // Í≤åÏûÑ ÏÉÅÌÉú Î≥µÍµ¨
            socket.on('gameStateRecovery', (data) => {
                console.log('üîÑ Í≤åÏûÑ ÏÉÅÌÉú Î≥µÍµ¨ ÏàòÏã†:', data);
                if (data.gameState) {
                    state = data.gameState;
                    render();
                    updateButtons();
                    addLog('üîÑ Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.');
                }
            });

            // ÏπòÌä∏: Î™®Îì† ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å
            socket.on('serverDataReset', (data) => {
                console.log('üßπ Î™®Îì† ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:', data);
                showToast('Î™®Îì† ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.', 'success', 3000);
            });

            // ÏπòÌä∏: Í∞úÏù∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å
            socket.on('myDataReset', (data) => {
                console.log('üßπ Í∞úÏù∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:', data);
                showToast(`${data.playerName}Ïùò Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`, 'success', 3000);
            });
        }
        
        // Îß§Ïπ≠ Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMatchingMessage(message) {
            const matchingModal = document.getElementById('matching-modal');
            const messageEl = matchingModal.querySelector('p');
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
        
        // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function startMatching() {
            console.log('üîç WebRTC Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Îß§Ïπ≠ ÏãúÏûë');
            playerName = localStorage.getItem('playerName') || 'Player';
            
            // Socket.IO Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî
            initializeSocketIO();
            
            const matchingModal = DOM.get('matching-modal');
            matchingModal.classList.remove('hidden');
            
            // ÎûúÎç§ Îß§Ïπ≠ Î©îÏãúÏßÄ ÌëúÏãú
            const matchingMessages = [
                'Í≤∞Ìà¨Ìï† ÎßàÎ≤ïÏÇ¨Î•º ÏÜåÌôò Ï§ë...',
                'ÎßûÏß± Îú∞ ÎßàÎ≤ïÏÇ¨Î•º ÌÉêÏÉâ Ï§ë...',
                'ÏÉÅÎåÄ ÎßàÎ≤ïÏÇ¨ Ï∂îÏ†Å Ï§ë...',
                'ÎàÑÍ∞Ä Ï£ºÎ¨∏ Î®ºÏ†Ä Ïô∏ÏπòÎÇò Î≥¥Ïûê...',
                'Ïò§Îäò Ïö¥ ÏóÜÏùÑ ÏÇ¨ÎûåÏùÑ Í≥†Î•¥Îäî Ï§ë...'
            ];
            const randomMessage = matchingMessages[Math.floor(Math.random() * matchingMessages.length)];
            DOM.get('matching-message').textContent = randomMessage;
            
            // Îß§Ïπ≠ ÏöîÏ≤≠
            socket.emit('requestMatch', { playerName: playerName });
        }
        
        function cancelMatching() {
            console.log('‚ùå Îß§Ïπ≠ Ï∑®ÏÜå');
            const matchingModal = DOM.get('matching-modal');
            matchingModal.classList.add('hidden');
            
            // Socket.IO Ïó∞Í≤∞ Ìï¥Ï†ú
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // WebRTC Ïó∞Í≤∞ Ìï¥Ï†ú
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            showTitleScreen();
        }
        
        function startMultiplayerGame() {
            console.log('üéÆ WebRTC Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í≤åÏûÑ ÏãúÏûë');
            multiplayerMode = true;
            
            // Î°úÏª¨ Î©îÎ™® ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            localMemoNotes = {};
            localMemoPanelActive = false;
            
            // Îß§Ïπ≠ Î™®Îã¨ Ïà®Í∏∞Í∏∞
            const matchingModal = DOM.get('matching-modal');
            matchingModal.classList.add('hidden');
            
            // Í≤åÏûÑ ÌôîÎ©¥ ÌëúÏãú ÌôïÏã§Ìûà ÌïòÍ∏∞ (Í∞ïÏ†úÎ°ú ÌëúÏãú)
            titleScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Í≤åÏûÑ ÏãúÏûë Ìö®Í≥ºÏùå Ïû¨ÏÉù
            activateAudioContext();
            playGameStartSound();
            
            // Ï∂îÍ∞Ä ÌôïÏù∏: Í≤åÏûÑ ÌôîÎ©¥Ïù¥ Ïã§Ï†úÎ°ú ÌëúÏãúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            setTimeout(() => {
                if (gameScreen.classList.contains('hidden')) {
                    console.log('‚ö†Ô∏è Í≤åÏûÑ ÌôîÎ©¥Ïù¥ Ïó¨Ï†ÑÌûà Ïà®Í≤®Ï†∏ ÏûàÏùå - Í∞ïÏ†ú ÌëúÏãú');
                    titleScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                }
            }, 100);
            
            // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updatePlayerName();
            
            // ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ ÌëúÏãú (Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏)
            updateOpponentName();
            
            // ÏñëÏ™Ω Î™®Îëê Í∏∞Î≥∏ Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            console.log('üîÑ Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî');
            state = {
                players: [
                    { id: 1, name: playerName, health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] },
                    { id: 2, name: opponentName || 'Player2', health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] }
                ],
                secretStones: [],
                usedStones: [],
                publiclyRevealedSecretStones: [],
                currentPlayerId: 1, // Ìò∏Ïä§Ìä∏Í∞Ä Ìï≠ÏÉÅ 1Î≤à ÌîåÎ†àÏù¥Ïñ¥, Ï≤´ ÌÑ¥ÏùÄ resetGameÏóêÏÑú Í≤∞Ï†ï
                isPlayerTurn: true, // Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ ÌÑ¥ ÏãúÏûë (resetGameÏóêÏÑú Ïû¨ÏÑ§Ï†ïÎê®)
                lastSuccessfulSpell: 0,
                turnInProgress: false,
                isGameOver: false,
                gameStarted: true,
                gameLog: ['Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.']
            };
            
            // Í∏∞Î≥∏ UI Î†åÎçîÎßÅ
            createSpellButtons();
            // Í≤åÏûÑ ÏãúÏûë Ïãú Ï£ºÎ¨∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            spellButtonsDisabled = false;
            render();
            updateButtons();
            
            // Ìò∏Ïä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≤åÏûÑ Ï¥àÍ∏∞Ìôî Î∞è ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï†ÑÏÜ°
            if (isHost) {
                console.log('üéØ Ìò∏Ïä§Ìä∏: Í≤åÏûÑ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
                resetGame();
                
                            // Ìò∏Ïä§Ìä∏Ïù∏ Í≤ΩÏö∞ Í≤åÏûÑ Ï¥àÍ∏∞Ìôî ÌõÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë (Ìò∏Ïä§Ìä∏Í∞Ä Ï≤´ ÌÑ¥Ïùº ÎïåÎßå)
            if (isHost && state.currentPlayerId === 1) {
                console.log('‚è∞ Ìò∏Ïä§Ìä∏: Ï≤´ ÌÑ¥ ÌÉÄÏù¥Î®∏ ÏãúÏûë');
                startTurnTimer();
            } else if (isHost && state.currentPlayerId === 2) {
                console.log('‚è∞ Ìò∏Ïä§Ìä∏: ÏÉÅÎåÄ ÌÑ¥ ÏãúÏûë - ÌÉÄÏù¥Î®∏ ÏãúÏûë');
                startTurnTimer();
            }
                
                // Ìò∏Ïä§Ìä∏Ïù∏ Í≤ΩÏö∞ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉúÎ•º ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï†ÑÏÜ°
                setTimeout(() => {
                    if (dataChannel && dataChannel.readyState === 'open') {
                        console.log('üì§ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉú Ï†ÑÏÜ°');
                        dataChannel.send(JSON.stringify({
                            type: 'gameState',
                            state: state
                        }));
                    } else {
                        console.log('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑêÏù¥ ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏùå - Ïû¨ÏãúÎèÑ ÏòàÏ†ï');
                        // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑêÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ 1Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ
                        setTimeout(() => {
                            if (dataChannel && dataChannel.readyState === 'open') {
                                console.log('üì§ Ï¥àÍ∏∞ Í≤åÏûÑ ÏÉÅÌÉú Ï†ÑÏÜ° (Ïû¨ÏãúÎèÑ)');
                                dataChannel.send(JSON.stringify({
                                    type: 'gameState',
                                    state: state
                                }));
                            }
                        }, 1000);
                    }
                }, 500); // 0.5Ï¥à ÌõÑ Ï†ÑÏÜ°
            } else {
                console.log('‚è≥ Í≤åÏä§Ìä∏: Ìò∏Ïä§Ìä∏Ïùò Í≤åÏûÑ ÏÉÅÌÉú ÎåÄÍ∏∞ Ï§ë...');
                addLog('Ìò∏Ïä§Ìä∏Ïùò Í≤åÏûÑ Ï¥àÍ∏∞ÌôîÎ•º Í∏∞Îã§Î¶¨Îäî Ï§ë...');
                
                // Í≤åÏä§Ìä∏Í∞Ä Ìò∏Ïä§Ìä∏ÏóêÍ≤å ÏûêÏã†Ïùò ÏïÑÏù¥ÏΩò Ï†ïÎ≥¥ Ï†ÑÏÜ°
                setTimeout(() => {
                    if (dataChannel && dataChannel.readyState === 'open') {
                        console.log('üì§ Í≤åÏä§Ìä∏ ÏïÑÏù¥ÏΩò Ï†ïÎ≥¥ Ï†ÑÏÜ°');
                        dataChannel.send(JSON.stringify({
                            type: 'playerInfo',
                            guestIcon: localStorage.getItem('playerIcon') || 'üë§'
                        }));
                    }
                }, 200);
                
                // Í≤åÏä§Ìä∏ÎèÑ ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
                setTimeout(() => {
                    if (!state.players || state.players[0].hand.length === 0) {
                        console.log('‚ö†Ô∏è Ìò∏Ïä§Ìä∏Î°úÎ∂ÄÌÑ∞ Í≤åÏûÑ ÏÉÅÌÉúÎ•º Î∞õÏßÄ Î™ªÌï® - ÏûêÎèô Î≥µÍµ¨ ÏãúÎèÑ');
                        addLog('Ìò∏Ïä§Ìä∏ ÏùëÎãµÏù¥ ÏóÜÏñ¥ ÏûêÎèôÏúºÎ°ú Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§.');
                        resetGame();
                    }
                }, 5000); // 5Ï¥à ÌõÑ ÌÉÄÏûÑÏïÑÏõÉ
            }
        }

        // WebRTC Ï¥àÍ∏∞Ìôî
        function initializeWebRTC(opponentId) {
            console.log('üåê WebRTC Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...');
            
            // STUN ÏÑúÎ≤Ñ ÏÑ§Ï†ï
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            peerConnection = new RTCPeerConnection(configuration);
            
            // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê ÏÉùÏÑ± (Ìò∏Ïä§Ìä∏Ïù∏ Í≤ΩÏö∞)
            if (isHost) {
                dataChannel = peerConnection.createDataChannel('gameData');
                setupDataChannel(dataChannel);
            }

            // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel(dataChannel);
            };

            // ICE ÌõÑÎ≥¥ Ïù¥Î≤§Ìä∏
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('üì§ ICE candidate Ï†ÑÏÜ°:', event.candidate);
                    socket.emit('iceCandidate', {
                        target: opponentId,
                        candidate: event.candidate
                    });
                }
            };

            // Ïó∞Í≤∞ ÏÉÅÌÉú Î≥ÄÍ≤Ω
            peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    console.log('WebRTC Ïó∞Í≤∞ ÏÑ±Í≥µ!');
                    // Ìò∏Ïä§Ìä∏Îßå Ïó¨Í∏∞ÏÑú Í≤åÏûÑ ÏãúÏûë (Í≤åÏä§Ìä∏Îäî Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄÎ•º Î∞õÏùÑ Îïå ÏãúÏûë)
                    if (isHost) {
                        startMultiplayerGame();
                    }
                } else if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                    console.log('WebRTC Ïó∞Í≤∞ Ïã§Ìå® ÎòêÎäî Ïó∞Í≤∞ Ìï¥Ï†ú');
                }
            };

            // Ìò∏Ïä§Ìä∏Ïù∏ Í≤ΩÏö∞ Offer ÏÉùÏÑ±
            if (isHost) {
                createOffer(opponentId);
            }
        }
        
        // Offer ÏÉùÏÑ± Î∞è Ï†ÑÏÜ°
        async function createOffer(opponentId) {
            try {
                if (!peerConnection) {
                    console.log('‚ö†Ô∏è peerConnectionÏù¥ nullÏûÖÎãàÎã§. Offer ÏÉùÏÑ±ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.');
                    return;
                }
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                console.log('üì§ Offer ÏÉùÏÑ± Î∞è Ï†ÑÏÜ°');
                socket.emit('offer', {
                    target: opponentId,
                    offer: offer
                });
            } catch (error) {
                console.error('Offer ÏÉùÏÑ± Ïã§Ìå®:', error);
            }
        }
        
        // Offer Ï≤òÎ¶¨
        async function handleOffer(from, offer) {
            try {
                if (!peerConnection) {
                    console.log('‚ö†Ô∏è peerConnectionÏù¥ nullÏûÖÎãàÎã§. Offer Ï≤òÎ¶¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§.');
                    return;
                }
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                console.log('üì§ Answer ÏÉùÏÑ± Î∞è Ï†ÑÏÜ°');
                socket.emit('answer', {
                    target: from,
                    answer: answer
                });
            } catch (error) {
                console.error('Offer Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            }
        }
        
        // Answer Ï≤òÎ¶¨
        async function handleAnswer(from, answer) {
            try {
                if (!peerConnection) {
                    console.log('‚ö†Ô∏è peerConnectionÏù¥ nullÏûÖÎãàÎã§. Answer Ï≤òÎ¶¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§.');
                    return;
                }
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                console.log('üì• Answer Ï≤òÎ¶¨ ÏôÑÎ£å');
            } catch (error) {
                console.error('Answer Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            }
        }
        
        // ICE Candidate Ï≤òÎ¶¨
        async function handleIceCandidate(from, candidate) {
            try {
                if (!peerConnection) {
                    console.log('‚ö†Ô∏è peerConnectionÏù¥ nullÏûÖÎãàÎã§. ICE Candidate Ï≤òÎ¶¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§.');
                    return;
                }
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                console.log('üì• ICE Candidate Ï≤òÎ¶¨ ÏôÑÎ£å');
            } catch (error) {
                console.error('ICE Candidate Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê ÏÑ§Ï†ï
        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ïó¥Î¶º');
                // Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄ Ï†ÑÏÜ°
                if (isHost) {
                    console.log('üì§ Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄ Ï†ÑÏÜ°');
                    channel.send(JSON.stringify({
                        type: 'gameStart',
                        hostName: playerName,
                        hostIcon: localStorage.getItem('playerIcon') || 'üë§',
                        guestName: opponentName || 'Player2'
                    }));
                }
            };

            channel.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('üì• Í≤åÏûÑ Î©îÏãúÏßÄ ÏàòÏã†:', message.type);
                    handleGameMessage(message);
                } catch (error) {
                    console.error('Í≤åÏûÑ Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò:', error);
                    // ÌååÏã± Ïò§Î•ò Ïãú Í≤åÏûÑ ÏÉÅÌÉú Î≥µÍµ¨
                    setTimeout(() => {
                        safeRefreshGameState();
                    }, 1000);
                }
            };

            channel.onclose = () => {
                console.log('Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Îã´Ìûò');
            };
        }

        // Í≤åÏûÑ Î©îÏãúÏßÄ Ï≤òÎ¶¨
        function handleGameMessage(message) {
            console.log('üì® Î∞õÏùÄ Î©îÏãúÏßÄ:', message);
            
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî
            if (!state || !state.players || state.players.length < 2 || !state.players[0] || !state.players[1]) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî');
                const currentPlayerName = localStorage.getItem('playerName') || 'Player';
                state = {
                    players: [
                                        { id: 1, name: currentPlayerName, health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] },
                { id: 2, name: opponentName || 'Player2', health: GAME_CONFIG.maxHealth, hand: [], knownSecretStones: [] }
                    ],
                    secretStones: [],
                    usedStones: [],
                    publiclyRevealedSecretStones: [],
                    currentPlayerId: 1,
                    isPlayerTurn: false,
                    lastSuccessfulSpell: 0,
                    turnInProgress: false,
                    isGameOver: false,
                    gameStarted: true,
                    gameLog: ['Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.']
                };
                // Í≤åÏûÑ ÏÉÅÌÉú Î≥µÍµ¨ Ïãú Ï£ºÎ¨∏ Î≤ÑÌäº Ïû¨ÌôúÏÑ±Ìôî
                spellButtonsDisabled = false;
                console.log('‚úÖ Í≤åÏûÑ ÏÉÅÌÉú Î≥µÍµ¨ ÏôÑÎ£å:', state);
            }
            
            switch (message.type) {
                case 'gameStart':
                    opponentName = isHost ? message.guestName : message.hostName;
                    opponentIcon = isHost ? (message.guestIcon || 'üë§') : (message.hostIcon || 'üë§');
                    console.log('üë§ ÏÉÅÎåÄÎ∞© ÏïÑÏù¥ÏΩò ÏàòÏã†:', opponentIcon);
                    // Í≤åÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ÏóêÎßå startMultiplayerGame Ìò∏Ï∂ú (Ìò∏Ïä§Ìä∏Îäî Ïù¥ÎØ∏ Ìò∏Ï∂úÎê®)
                    if (!isHost) {
                        console.log('üéÆ Í≤åÏä§Ìä∏: Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄ ÏàòÏã† - Í≤åÏûÑ ÏãúÏûë');
                        startMultiplayerGame();
                    } else {
                        console.log('üéÆ Ìò∏Ïä§Ìä∏: Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄ ÏàòÏã† - Í≤åÏûÑ ÌôîÎ©¥ ÌôïÏù∏');
                        // Ìò∏Ïä§Ìä∏ÎèÑ Í≤åÏûÑ ÌôîÎ©¥Ïù¥ Ï†úÎåÄÎ°ú ÌëúÏãúÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Í∞ïÏ†ú ÌëúÏãú
                        if (gameScreen.classList.contains('hidden')) {
                            console.log('‚ö†Ô∏è Ìò∏Ïä§Ìä∏: Í≤åÏûÑ ÌôîÎ©¥Ïù¥ Ïà®Í≤®Ï†∏ ÏûàÏùå - Í∞ïÏ†ú ÌëúÏãú');
                            titleScreen.classList.add('hidden');
                            gameScreen.classList.remove('hidden');
                        }
                        // Ìò∏Ïä§Ìä∏ÎèÑ Í≤åÏûÑ ÌôîÎ©¥Ïù¥ ÌëúÏãúÎêòÏóàÎäîÏßÄ Îã§Ïãú ÌïúÎ≤à ÌôïÏù∏
                        setTimeout(() => {
                            if (gameScreen.classList.contains('hidden')) {
                                console.log('‚ö†Ô∏è Ìò∏Ïä§Ìä∏: Í≤åÏûÑ ÌôîÎ©¥Ïù¥ Ïó¨Ï†ÑÌûà Ïà®Í≤®Ï†∏ ÏûàÏùå - ÏµúÏ¢Ö Í∞ïÏ†ú ÌëúÏãú');
                                titleScreen.classList.add('hidden');
                                gameScreen.classList.remove('hidden');
                            }
                        }, 50);
                    }
                    break;
                case 'firstTurn':
                    console.log(`üéØ Ìò∏Ïä§Ìä∏Ïùò Ï≤´ Î≤àÏß∏ ÌÑ¥ Í≤∞Ï†ï ÏàòÏã†: ÌîåÎ†àÏù¥Ïñ¥ ${message.firstPlayer}`);
                    // Ìò∏Ïä§Ìä∏Ïùò Í≤∞Ï†ïÏúºÎ°ú Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
                    resetGameWithFirstPlayer(message.firstPlayer);
                    break;
                case 'gameState':
                    console.log('üì• Í≤åÏûÑ ÏÉÅÌÉú ÏàòÏã†');
                    if (message.state) {
                        updateGameState(message.state);
                        
                        // Í≤åÏä§Ìä∏Í∞Ä Ìò∏Ïä§Ìä∏Ïùò Í≤åÏûÑ ÏÉÅÌÉúÎ•º Î∞õÏïòÏùÑ Îïå ÌÉÄÏù¥Î®∏ ÏãúÏûë
                        if (!isHost) {
                            console.log(`‚è∞ Í≤åÏä§Ìä∏: Ìò∏Ïä§Ìä∏ Í≤åÏûÑ ÏÉÅÌÉú ÏàòÏã† - Ï≤´ ÌÑ¥ ÌîåÎ†àÏù¥Ïñ¥: ${message.state.currentPlayerId}`);
                            setTimeout(() => {
                                startTurnTimer();
                            }, 100); // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
                        }
                    }
                    break;
                case 'cardPlayed':
                    handleCardPlayed(message.card, message.playerId, message.gameState);
                    break;
                case 'turnEnd':
                    console.log('üì• ÌÑ¥ Ï¢ÖÎ£å Î©îÏãúÏßÄ ÏàòÏã†');
                    handleTurnEnd(message.gameState);
                    break;
                case 'gameOver':
                    handleGameOver(message.winner, message.gameState);
                    break;
                case 'surrender':
                    handleSurrender(message.surrenderingPlayerId);
                    break;
                case 'playerInfo':
                    // Í≤åÏä§Ìä∏Ïùò ÏïÑÏù¥ÏΩò Ï†ïÎ≥¥ ÏàòÏã† (Ìò∏Ïä§Ìä∏Îßå Ï≤òÎ¶¨)
                    if (isHost && message.guestIcon) {
                        opponentIcon = message.guestIcon;
                        console.log('üë§ Í≤åÏä§Ìä∏ ÏïÑÏù¥ÏΩò Ï†ïÎ≥¥ ÏàòÏã†:', opponentIcon);
                        updateOpponentName();
                    }
                    break;
                case 'spellFailed':
                    console.log('üì• ÏòÅÏ∞Ω Ïã§Ìå® Î©îÏãúÏßÄ ÏàòÏã†');
                    // ÏÉÅÎåÄÎ∞© ÏòÅÏ∞Ω Ïã§Ìå® Ïãú Ï¶âÏãú Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                    spellButtonsDisabled = true;
                    disableSpellButtons();
                    
                    // ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäºÎèÑ Ï¶âÏãú ÎπÑÌôúÏÑ±Ìôî
                    endTurnBtn.disabled = true;
                    endTurnBtn.style.opacity = '0.5';
                    endTurnBtn.style.cursor = 'not-allowed';
                    
                    // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (Î≤ÑÌäº ÏÉÅÌÉúÎäî Ïú†ÏßÄ)
                    if (message.gameState) {
                        // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî Í∞Å ÌîåÎ†àÏù¥Ïñ¥Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨
                        const currentRevealedStones = state.publiclyRevealedSecretStones;
                        
                        state = message.gameState;
                        
                        // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ïÎ≥¥Îßå Ïú†ÏßÄ
                        state.publiclyRevealedSecretStones = currentRevealedStones;
                        
                        // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑú ÌÑ¥ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
                        if (multiplayerMode) {
                            const myPlayerId = isHost ? 1 : 2;
                            const shouldBeMyTurn = (state.currentPlayerId === myPlayerId);
                            if (state.isPlayerTurn !== shouldBeMyTurn) {
                                state.isPlayerTurn = shouldBeMyTurn;
                            }
                        }
                        
                        // Í≤åÏûÑ ÏÉÅÌÉúÎßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† Î≤ÑÌäº ÏÉÅÌÉúÎäî Ïú†ÏßÄ
                        render();
                        
                        // Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
                        if (localMemoPanelActive) {
                            const memoButtons = DOM.get('memo-buttons');
                            memoButtons.classList.remove('hidden');
                        }
                    }
                    break;
            }
        }



        // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateGameState(newState) {
            console.log('üîÑ Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏');
            
            // Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
            if (!newState || !newState.players || newState.players.length < 2) {
                console.log('‚ö†Ô∏è Î∞õÏùÄ Í≤åÏûÑ ÏÉÅÌÉúÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå');
                return;
            }
            
            // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî Í∞Å ÌîåÎ†àÏù¥Ïñ¥Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨
            const currentRevealedStones = state.publiclyRevealedSecretStones;
            
            state = newState;
            
            // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ïÎ≥¥Îßå Ïú†ÏßÄ
            state.publiclyRevealedSecretStones = currentRevealedStones;
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑú ÌÑ¥ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
            if (multiplayerMode) {
                const myPlayerId = isHost ? 1 : 2;
                const shouldBeMyTurn = (state.currentPlayerId === myPlayerId);
                if (state.isPlayerTurn !== shouldBeMyTurn) {
                    state.isPlayerTurn = shouldBeMyTurn;
                }
            }
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïãú Ï£ºÎ¨∏ Î≤ÑÌäº Ïû¨ÌôúÏÑ±Ìôî
            spellButtonsDisabled = false;
            
            render();
            updateButtons();
            
            // Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
            if (localMemoPanelActive) {
                const memoButtons = DOM.get('memo-buttons');
                memoButtons.classList.remove('hidden');
            }
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
            if (isHost) {
                console.log(`‚è∞ Ìò∏Ïä§Ìä∏: Í≤åÏûÑ ÏÉÅÌÉú ÏàòÏã† ÌõÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë - Ï≤´ ÌÑ¥ ÌîåÎ†àÏù¥Ïñ¥: ${state.currentPlayerId}`);
                setTimeout(() => {
                    startTurnTimer();
                }, 100); // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
            }
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Î°úÍ∑∏
            console.log('‚úÖ Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

                    // Ï£ºÎ¨∏ ÌîåÎ†àÏù¥ Ï≤òÎ¶¨
        function handleCardPlayed(card, playerId, gameState = null) {
            console.log(`üéØ Ï£ºÎ¨∏ ÌîåÎ†àÏù¥ Ï≤òÎ¶¨: ${card}, ÌîåÎ†àÏù¥Ïñ¥ ${playerId}`);
            
            if (gameState) {
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî Í∞Å ÌîåÎ†àÏù¥Ïñ¥Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨
                const currentRevealedStones = state.publiclyRevealedSecretStones;
                
                // ÏÉÅÎåÄÎ∞©Ïù¥ Î≥¥ÎÇ∏ Í≤åÏûÑ ÏÉÅÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                state = gameState;
                
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ïÎ≥¥Îßå Ïú†ÏßÄ
                state.publiclyRevealedSecretStones = currentRevealedStones;
                
                console.log('üîÑ Í≤åÏûÑ ÏÉÅÌÉú ÎèôÍ∏∞ÌôîÎê®');
                
                // ÏÉÅÎåÄÎ∞©Ïùò Ï£ºÎ¨∏ ÌîåÎ†àÏù¥ Ìö®Í≥º Ïã§Ìñâ
                const player = state.players.find(p => p.id === playerId);
                const opponent = state.players.find(p => p.id !== playerId);
                
                // Ï£ºÎ¨∏ Ìö®Í≥º Ïã§Ìñâ (ÏÉÅÎåÄÎ∞©Ïù¥ ÌîåÎ†àÏù¥Ìïú Ï£ºÎ¨∏)
                executeSpellEffect(playerId, card);
                
                // ÏÉÅÎåÄÎ∞© ÏòÅÏ∞Ω ÏÑ±Í≥µ ÌååÌã∞ÌÅ¥ Ìö®Í≥º
                createModalParticles(card);
            } else {
                // Ï£ºÎ¨∏ Ìö®Í≥º Ï†ÅÏö©
                const player = state.players.find(p => p.id === playerId);
                const opponent = state.players.find(p => p.id !== playerId);
                
                applyCardEffect(card, player, opponent);
            }
            render();
            
            // Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
            if (localMemoPanelActive) {
                const memoButtons = DOM.get('memo-buttons');
                memoButtons.classList.remove('hidden');
            }
        }

        // ÌÑ¥ Ï¢ÖÎ£å Ï≤òÎ¶¨
        function handleTurnEnd(gameState = null) {
            console.log('üîÑ ÌÑ¥ Ï¢ÖÎ£å Ï≤òÎ¶¨');
            
            if (gameState) {
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî Í∞Å ÌîåÎ†àÏù¥Ïñ¥Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨
                const currentRevealedStones = state.publiclyRevealedSecretStones;
                
                // ÏÉÅÎåÄÎ∞©Ïù¥ Î≥¥ÎÇ∏ Í≤åÏûÑ ÏÉÅÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                state = gameState;
                
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ïÎ≥¥Îßå Ïú†ÏßÄ
                state.publiclyRevealedSecretStones = currentRevealedStones;
                
                console.log('üîÑ ÌÑ¥ Ï¢ÖÎ£å Ïãú Í≤åÏûÑ ÏÉÅÌÉú ÎèôÍ∏∞ÌôîÎê®');
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑúÎäî currentPlayerIdÎ•º Í∏∞Ï§ÄÏúºÎ°ú isPlayerTurn Ïû¨ÏÑ§Ï†ï
                if (multiplayerMode) {
                    const myPlayerId = isHost ? 1 : 2;
                    const shouldBeMyTurn = (state.currentPlayerId === myPlayerId);
                    state.isPlayerTurn = shouldBeMyTurn;
                    console.log(`üéÆ ÌÑ¥ ÎèôÍ∏∞Ìôî - ÎÇ¥ ÌîåÎ†àÏù¥Ïñ¥ID: ${myPlayerId}, ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ID: ${state.currentPlayerId}, ÎÇ¥ ÌÑ¥: ${shouldBeMyTurn}`);
                }
                
                // ÌÑ¥ Ï†ÑÌôò ÌõÑ ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ ÌÑ¥ ÏãúÏûë Î°úÍ∑∏
                const currentPlayerName = state.currentPlayerId === 1 ? state.players[0].name : state.players[1].name;
                addLog(Messages.turnStart(currentPlayerName));
                
                // ÌÉÄÏù¥Î®∏ ÏãúÏûë
                setTimeout(() => {
                    startTurnTimer();
                }, 500);
                
                // ÌÑ¥ÏùÑ Î∞õÏùÄ ÌîåÎ†àÏù¥Ïñ¥Ïùò Í≤ΩÏö∞ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ
                if (multiplayerMode && state.isPlayerTurn) {
                    console.log('üéØ ÎÇ¥ ÌÑ¥ ÏãúÏûë - ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ');
                    setTimeout(() => {
                        safeRefreshGameState();
                    }, 500);
                }
            } else {
                state.isPlayerTurn = !state.isPlayerTurn;
                state.currentPlayerId = state.currentPlayerId === 1 ? 2 : 1;
                
                // AI Î™®ÎìúÏóêÏÑúÎèÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
                setTimeout(() => {
                    startTurnTimer();
                }, 500);
            }
            render();
            updateButtons(); // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï∂îÍ∞Ä
            
            // Î©îÎ™® Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
            if (localMemoPanelActive) {
                const memoButtons = DOM.get('memo-buttons');
                memoButtons.classList.remove('hidden');
            }
        }

        // ÏÉÅÎåÄÎ∞© Ïó∞Í≤∞ Ìï¥Ï†ú Ï≤òÎ¶¨ (ÎèÑÎßùÏúºÎ°ú Ïù∏Ìïú ÏäπÎ¶¨)
        async function handleOpponentDisconnect(opponentName = 'Unknown') {
            console.log('üèÉ ÏÉÅÎåÄÎ∞© Í∞ïÏ†úÏ¢ÖÎ£å - ÎèÑÎßùÏúºÎ°ú Ïù∏Ìïú ÏäπÎ¶¨ Ï≤òÎ¶¨');
            
            // Í≤åÏûÑ ÏÉÅÌÉúÎ•º Ï¢ÖÎ£å ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
            state.isGameOver = true;
            
            // ÏäπÎ¶¨ Ï≤òÎ¶¨ (ÏÉÅÎåÄÎ∞©Ïù¥ ÎèÑÎßùÏ≥§ÏúºÎØÄÎ°ú ÎÇ¥Í∞Ä ÏäπÎ¶¨)
            updateStats(true, true);
            
            // ÏäπÎ¶¨Ïùò Ï¶ùÌëú Ï∂îÍ∞Ä (Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨)
            TrophySystem.addVictoryTrophy('multiplayer');
            
            // Ï†ÑÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ (Ïó∞Ïäπ Ï≤òÎ¶¨ Ìè¨Ìï®)
            updateStats(true, true); // ÏäπÎ¶¨, Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥
            
            // Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (socket && socket.connected) {
                const playerName = localStorage.getItem('playerName') || 'Player';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                const trophies = TrophySystem.loadTrophies();
                
                socket.emit('updateRanking', {
                    category: 'formal',
                    playerName: playerName,
                    score: trophies.multiplayer,
                    icon: playerIcon
                });
                
                console.log(`üîÑ ÏÉÅÎåÄÎ∞© Í∞ïÏ†úÏ¢ÖÎ£å ÌõÑ Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏: ${playerName}`);
            }
            
            let message = `ÏÉÅÎåÄ ${opponentName}Ïù¥(Í∞Ä) Í∞ïÏ†úÏ¢ÖÎ£åÌïòÏó¨ ÏäπÎ¶¨ÌïòÏòÄÏäµÎãàÎã§!`;
            
            // 2Ïó∞Ïäπ Ïù¥ÏÉÅÏùº Îïå Ïó∞Ïäπ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            if (currentWinStreak >= 2) {
                message += `\n\n${Messages.streak(currentWinStreak)}`;
            }
            
            message += '\n\nüèÖ ÏäπÏ†ê +3';
            
            addLog(`ÏÉÅÎåÄÎ∞© ${opponentName}Ïù¥(Í∞Ä) Í∞ïÏ†úÏ¢ÖÎ£åÌñàÏäµÎãàÎã§.`);
            addLog('ÏäπÎ¶¨Í∞Ä Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.');
            
            // ÏäπÎ¶¨Ìïú ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Î©îÏãúÏßÄ ÌëúÏãú
            await showModal('Í≤åÏûÑ Ï¢ÖÎ£å', message, true);
            
            // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            showTitleScreen();
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨
        function handleGameOver(winner, gameState = null) {
            console.log('üèÜ Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨');
            
            if (gameState) {
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî Í∞Å ÌîåÎ†àÏù¥Ïñ¥Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨
                const currentRevealedStones = state.publiclyRevealedSecretStones;
                
                // ÏÉÅÎåÄÎ∞©Ïù¥ Î≥¥ÎÇ∏ Í≤åÏûÑ ÏÉÅÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                state = gameState;
                
                // ÎπÑÎ∞Ä Ï£ºÎ¨∏ Í≥µÍ∞ú Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï†ïÎ≥¥Îßå Ïú†ÏßÄ
                state.publiclyRevealedSecretStones = currentRevealedStones;
                
                console.log('üîÑ Í≤åÏûÑ Ï¢ÖÎ£å Ïãú Í≤åÏûÑ ÏÉÅÌÉú ÎèôÍ∏∞ÌôîÎê®');
            } else {
                state.isGameOver = true;
            }
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑú ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥ ID Í≥ÑÏÇ∞
            const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
            const isPlayerWin = winner === myPlayerId;
            
            // Ï†ÑÏ†Å ÏóÖÎç∞Ïù¥Ìä∏
            updateStats(isPlayerWin, true);
            
            // Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (socket && socket.connected) {
                const playerName = localStorage.getItem('playerName') || 'Player';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                const trophies = TrophySystem.loadTrophies();
                
                socket.emit('updateRanking', {
                    category: 'formal',
                    playerName: playerName,
                    score: trophies.multiplayer,
                    icon: playerIcon
                });
                
                console.log(`üîÑ Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ Îû≠ÌÇπ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏: ${playerName} (${isPlayerWin ? 'ÏäπÎ¶¨' : 'Ìå®Î∞∞'})`);
            }
            
            // ÏäπÎ¶¨/Ìå®Î∞∞ Î©îÏãúÏßÄ ÏÉùÏÑ±
            const winnerPlayer = state.players.find(p => p.id === winner);
            if (!winnerPlayer) {
                console.error('‚ùå ÏäπÎ¶¨ ÌîåÎ†àÏù¥Ïñ¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', winner);
                return;
            }
            
            let message;
            if (isPlayerWin) {
                // ÏäπÎ¶¨Ìïú Í≤ΩÏö∞
                const myPlayer = state.players.find(p => p.id === myPlayerId);
                const opponentPlayer = state.players.find(p => p.id !== myPlayerId);
                
                if (!myPlayer || !opponentPlayer) {
                    console.error('‚ùå ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', { myPlayerId, myPlayer, opponentPlayer });
                    message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.';
                } else if (opponentPlayer.health <= 0) {
                    message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! ÏÉÅÎåÄÏùò Ï≤¥Î†•Ïù¥ 0Ïù¥ ÎêòÏóàÏäµÎãàÎã§!';
                } else if (myPlayer.hand.length === 0) {
                    message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! Î™®Îì† ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§!';
                } else {
                    message = 'ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! ÏÉÅÎåÄÍ∞Ä ÎèÑÎßùÏ≥§ÏäµÎãàÎã§!';
                }
            } else {
                // Ìå®Î∞∞Ìïú Í≤ΩÏö∞
                const myPlayer = state.players.find(p => p.id === myPlayerId);
                const opponentPlayer = state.players.find(p => p.id !== myPlayerId);
                
                if (!myPlayer || !opponentPlayer) {
                    console.error('‚ùå ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', { myPlayerId, myPlayer, opponentPlayer });
                    message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.';
                } else if (myPlayer.health <= 0) {
                    message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÏûêÏã†Ïùò Ï≤¥Î†•Ïù¥ 0Ïù¥ ÎêòÏóàÏäµÎãàÎã§.';
                } else if (opponentPlayer.hand.length === 0) {
                    message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÏÉÅÎåÄÍ∞Ä Î™®Îì† ÎßàÎ≤ï Ï£ºÎ¨∏ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.';
                } else {
                    message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÎèÑÎßùÏπòÍ≥† ÎßêÏïòÏäµÎãàÎã§.';
                }
            }
            
            // Ïó∞Ïäπ Î©îÏãúÏßÄ Ï∂îÍ∞Ä (updateStatsÏóêÏÑú Ï≤òÎ¶¨Îêú Ïó∞Ïäπ ÏÇ¨Ïö©)
            if (isPlayerWin && currentWinStreak >= 2) {
                message += `\n\n${Messages.streak(currentWinStreak)}`;
            }
            
            // ÏäπÎ¶¨/Ìå®Î∞∞ ÏÇ¨Ïö¥Îìú
            activateAudioContext();
            playGameOverSound(isPlayerWin);
            
            // Í≤åÏûÑ Ï¢ÖÎ£å Î™®Îã¨ ÌëúÏãú
            showModal('Í≤åÏûÑ Ï¢ÖÎ£å', message, true);
            addLog(`- Í≤åÏûÑ Ï¢ÖÎ£å: ${winnerPlayer.name} ÏäπÎ¶¨! -`);
            render();
        }
        
        function startAIGame() {
            console.log(`ü§ñ AI Í≤åÏûÑ ÏãúÏûë (ÎÇúÏù¥ÎèÑ: ${aiDifficulty})`);
            multiplayerMode = false;
            titleScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Í≤åÏûÑ ÏãúÏûë Ìö®Í≥ºÏùå Ïû¨ÏÉù
            activateAudioContext();
            playGameStartSound();
            
            resetGame();
            
            // AI Ï†ïÎ≥¥ ÌëúÏãú (ÎÇúÏù¥ÎèÑÎ≥Ñ)
            const aiName = aiDifficulty === 'easy' ? 'ü§ñ Ïâ¨ÏõÄ ÌóàÏàòÏïÑÎπÑ' : aiDifficulty === 'normal' ? 'ü§ñ Î≥¥ÌÜµ ÌóàÏàòÏïÑÎπÑ' : 'ü§ñ Ïñ¥Î†§ÏõÄ ÌóàÏàòÏïÑÎπÑ';
            
            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Ïãú AI Ïù¥Î¶Ñ ÏÑ§Ï†ï
            if (state.players && state.players[1]) {
                state.players[1].name = aiName;
            }
            
            // AI ÎÇúÏù¥ÎèÑÎ≥Ñ ÏãúÍ∞Ñ Ï†úÌïú ÏÑ§Ï†ï
            setTurnDurationByDifficulty();
            
            // ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateOpponentName();
        }
        
        // AI ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
        function showAIDifficultyModal() {
            const modal = DOM.get('ai-difficulty-modal');
            modal.classList.remove('hidden');
            playCardSound();
        }
        
        // ÎßàÎ≤ï Ïπ¥Îìú Ï†ïÎ≥¥ Î™®Îã¨ ÌëúÏãú
        function showSpellCardsModal() {
            const modal = DOM.get('spell-cards-modal');
            modal.classList.remove('hidden');
            playCardSound();
        }
        
        // ÎßàÎ≤ï Ïπ¥Îìú Ï†ïÎ≥¥ Î™®Îã¨ Ïà®Í∏∞Í∏∞
        function hideSpellCardsModal() {
            const modal = DOM.get('spell-cards-modal');
            modal.classList.add('hidden');
            playCardSound();
        }
        
        // AI ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Ï≤òÎ¶¨
        function selectAIDifficulty(difficulty) {
            aiDifficulty = difficulty;
            console.log(`ü§ñ AI ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù: ${difficulty}`);
            
            const modal = DOM.get('ai-difficulty-modal');
            modal.classList.add('hidden');
            
            startAIGame();
        }
        
        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showToast(message, type = 'info', duration = 3000) {
            const toast = DOM.get('toast');
            const toastMessage = DOM.get('toast-message');
            
            // Í∏∞Ï°¥ ÌÉÄÏûÖ ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            toast.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-blue-500');
            
            // ÌÉÄÏûÖÏóê Îî∞Î•∏ Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    break;
                default:
                    toast.classList.add('bg-blue-500');
                    break;
            }
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }
        
        // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ ÌëúÏãú Ìï®Ïàò
        function showTitleScreen() {
            // Í≤åÏûÑ ÏãúÏûë Ï§ëÏóêÎäî ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏßÄ ÏïäÎèÑÎ°ù Î≥¥Ìò∏
            if (GameConditions.isGameInProgress()) {
                console.log('‚ö†Ô∏è Í≤åÏûÑ ÏßÑÌñâ Ï§ë - ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏßÄ ÏïäÏùå');
                return;
            }
            
            console.log('üè† ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞');
            gameScreen.classList.add('hidden');
            titleScreen.classList.remove('hidden');
            
            // ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ Î∞è Í≤åÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
            stopTurnTimer();
            resetTurnGauge();
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
            state = {
                gameStarted: false,
                isGameOver: true,
                players: [],
                secretStones: [],
                usedStones: [],
                publiclyRevealedSecretStones: [],
                currentPlayerId: null,
                isPlayerTurn: false,
                lastSuccessfulSpell: 0,
                turnInProgress: false,
                gameLog: []
            };
            
            // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®Îìú Ï¥àÍ∏∞Ìôî
            multiplayerMode = false;
            peerConnection = null;
            dataChannel = null;
            isHost = false;
            opponentName = '';
            myPlayerId = null;
            
            // Í∏∞Î≥∏ Ïù¥Î¶Ñ Ï¥àÍ∏∞Ìôî (Ï≤´ Î∞©Î¨∏ Ïãú ÎûúÎç§ Ïù¥Î¶Ñ ÏÉùÏÑ±)
            initializePlayerName();
            
            // 3Ï¥àÍ∞Ñ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            disableTitleButtons();
        }
        
        // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        function disableTitleButtons() {
            const buttons = titleScreen.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // 1Ï¥à ÌõÑ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            setTimeout(() => {
                enableTitleButtons();
            }, 1000);
        }
        
        // ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ Î≤ÑÌäº ÌôúÏÑ±Ìôî
        function enableTitleButtons() {
            const buttons = titleScreen.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }
        
        // ÎèÑÎßù Ìï®Ïàò
        async function surrenderGame() {
            const confirmed = await showSurrenderConfirmModal();
            if (confirmed) {
                // Ìå®Î∞∞ Ìö®Í≥ºÏùå Ïû¨ÏÉù
                activateAudioContext();
                playGameOverSound(false);
                
                // Ìå®Î∞∞ Ï≤òÎ¶¨
                updateStats(false, multiplayerMode);
                
                // ÏäπÏ†ê Í∞êÏÜå Ï≤òÎ¶¨
                if (multiplayerMode) {
                    TrophySystem.addDefeatTrophy('multiplayer');
                } else {
                    TrophySystem.addDefeatTrophy('ai');
                }
                
                addLog('Í≤∞Ìà¨Î•º ÎèÑÎßùÏ≥§ÏäµÎãàÎã§.');
                addLog('Ìå®Î∞∞Í∞Ä Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.');
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú ÏÉÅÎåÄÎ∞©ÏóêÍ≤å ÎèÑÎßù Î©îÏãúÏßÄ Ï†ÑÏÜ°
                if (multiplayerMode && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'surrender',
                        surrenderingPlayerId: 1
                    }));
                }
                
                // Í≤åÏûÑ ÏÉÅÌÉú ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
                state = {
                    gameStarted: false,
                    isGameOver: true,
                    players: [],
                    secretStones: [],
                    usedStones: [],
                    publiclyRevealedSecretStones: [],
                    currentPlayerId: null,
                    isPlayerTurn: false,
                    lastSuccessfulSpell: 0,
                    turnInProgress: false,
                    gameLog: []
                };
                
                // Ïó∞Ïäπ Ï¥àÍ∏∞Ìôî (Ìå®Î∞∞ Ïãú)
                localStorage.setItem('currentWinStreak', '0');
                
                // ÎèÑÎßùÌïú ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Î©îÏãúÏßÄ ÌëúÏãú (ÏäπÏ†ê Í∞êÏÜå Ìè¨Ìï®)
                let message = 'Ìå®Î∞∞ÌñàÏäµÎãàÎã§.. ÎèÑÎßùÏπòÍ≥† ÎßêÏïòÏäµÎãàÎã§.';
                message += '\n\nüèÖ ÏäπÏ†ê -1';
                await showModal('Í≤åÏûÑ Ï¢ÖÎ£å', message, true);
                
                // Î∞îÎ°ú ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                showTitleScreen();
            }
        }
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
        DOM.get('ai-battle-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            activateAudioContext(); // AudioContext ÌôúÏÑ±Ìôî
            showAIDifficultyModal();
        });
        DOM.get('multiplayer-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            
            // Í≥ÑÏ†ï Î°úÍ∑∏Ïù∏ ÌôïÏù∏
            if (!isLoggedIn) {
                showToast('Ï†ïÏãù Í≤∞Ìà¨Îäî Í≥ÑÏ†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning', 3000);
                showAuthModal('login');
                return;
            }
            
            activateAudioContext(); // AudioContext ÌôúÏÑ±Ìôî
            startMatching();
        });
        DOM.get('cancel-matching-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            cancelMatching();
        });
        
        // AI ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Î≤ÑÌäºÎì§
        DOM.get('easy-ai-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            activateAudioContext(); // AudioContext ÌôúÏÑ±Ìôî
            selectAIDifficulty('easy');
        });
        DOM.get('normal-ai-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            activateAudioContext(); // AudioContext ÌôúÏÑ±Ìôî
            selectAIDifficulty('normal');
        });
        DOM.get('hard-ai-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            activateAudioContext(); // AudioContext ÌôúÏÑ±Ìôî
            selectAIDifficulty('hard');
        });
        DOM.get('cancel-difficulty-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            DOM.get('ai-difficulty-modal').classList.add('hidden');
        });
        
        // ÎßàÎ≤ï Ïπ¥Îìú Î≥¥Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('spell-cards-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            showSpellCardsModal();
        });
        
        // ÎßàÎ≤ï Ïπ¥Îìú Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('close-spell-cards-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            hideSpellCardsModal();
        });

        endTurnBtn.addEventListener('click', () => {
            console.log('üîÑ ÌÑ¥ Ï¢ÖÎ£å Î≤ÑÌäº ÌÅ¥Î¶≠');
            
            // Ï¶âÏãú Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÎ°ú Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
            endTurnBtn.disabled = true;
            endTurnBtn.style.opacity = '0.5';
            endTurnBtn.style.cursor = 'not-allowed';
            
            if (GameConditions.canPlaySpell()) {
                const myPlayerId = multiplayerMode ? (isHost ? 1 : 2) : 1;
                addLog(`- ${state.players[myPlayerId - 1].name}${getJosa(state.players[myPlayerId - 1].name, 'Ïù¥/Í∞Ä')} ÌÑ¥ÏùÑ ÏàòÎèôÏúºÎ°ú Ï¢ÖÎ£åÌñàÏäµÎãàÎã§.`);
                endTurn();
            } else {
                // Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÏßÄ ÏïäÏúºÎ©¥ Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                setTimeout(() => {
                    if (GameConditions.canPlaySpell()) {
                        endTurnBtn.disabled = false;
                        endTurnBtn.style.opacity = '1';
                        endTurnBtn.style.cursor = 'pointer';
                    }
                }, 100);
            }
        });
        
        // ÎèÑÎßù Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('surrender-btn').addEventListener('click', surrenderGame);
        
        // ÎÇ¥ Ï†ïÎ≥¥ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('profile-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            showProfileModal();
        });
        
        // Îû≠ÌÇπ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('ranking-btn').addEventListener('click', (e) => {
            if (e.target.disabled) {
                showToast('Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', 'info', 3000);
                return;
            }
            showRankingModal();
        });
        

        
        // Ïù¥Î¶Ñ ÏûÖÎ†• Î∞è Ï†ÄÏû• Í∏∞Îä•
        const playerNameInput = DOM.get('player-name-input');
        const saveNameBtn = DOM.get('save-name-btn');
        const nameSaveStatus = DOM.get('name-save-status');
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌòÑÏû¨ Ïù¥Î¶Ñ ÏÑ§Ï†ï
        const currentName = localStorage.getItem('playerName') || '';
        playerNameInput.value = currentName;
        updateNameSaveStatus();
        updatePlayerName(); // ÏïÑÏù¥ÏΩòÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
        
        // Ïù¥Î¶Ñ ÏûÖÎ†• Ïãú Ï†ÄÏû• ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        playerNameInput.addEventListener('input', updateNameSaveStatus);
        
        // Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠
        saveNameBtn.addEventListener('click', () => {
            const newName = playerNameInput.value.trim();
            if (newName) {
                const oldName = localStorage.getItem('playerName') || 'Player';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                
                localStorage.setItem('playerName', newName);
                console.log(`üë§ ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ Ï†ÄÏû•: ${oldName} -> ${newName}`);
                
                // ÏÑúÎ≤ÑÏóê Ïù¥Î¶Ñ Î≥ÄÍ≤Ω ÏïåÎ¶º
                if (socket && oldName !== newName) {
                    socket.emit('updateUserName', {
                        oldName: oldName,
                        newName: newName,
                        icon: playerIcon
                    });
                    console.log(`üîÑ ÏÑúÎ≤ÑÏóê Ïù¥Î¶Ñ Î≥ÄÍ≤Ω ÏïåÎ¶º: ${oldName} -> ${newName}`);
                }
                
                updatePlayerName();
                showNameSaveSuccess();
                showToast('Ïù¥Î¶ÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success', 2000);
            } else {
                showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning', 3000);
            }
        });
        
        // Ïù¥Î¶Ñ Ï†ÄÏû• ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateNameSaveStatus() {
            const currentName = localStorage.getItem('playerName') || '';
            const inputName = playerNameInput.value.trim();
            const nameSaveStatus = DOM.get('name-save-status');
            
            if (inputName === currentName && inputName !== '') {
                saveNameBtn.disabled = true;
                saveNameBtn.style.opacity = '0.5';
                saveNameBtn.style.cursor = 'not-allowed';
                if (nameSaveStatus) {
                    nameSaveStatus.classList.remove('hidden');
                }
            } else {
                saveNameBtn.disabled = false;
                saveNameBtn.style.opacity = '1';
                saveNameBtn.style.cursor = 'pointer';
                if (nameSaveStatus) {
                    nameSaveStatus.classList.add('hidden');
                }
            }
        }
        
        // ÏïÑÏù¥ÏΩò Í¥ÄÎ†® Î≥ÄÏàòÎì§
        // Ïú†Ï†Ä ID Í¥ÄÎ¶¨ Ìï®Ïàò
        function getOrCreateUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                console.log(`üÜî ÏÉàÎ°úÏö¥ Ïú†Ï†Ä ID ÏÉùÏÑ±: ${userId}`);
            }
            return userId;
        }
        
                // Ïù¥Î¶ÑÍ≥º ÏïÑÏù¥ÏΩòÏùÑ Ìï®Íªò Í∞ÄÏ†∏Ïò§Í∏∞
        function getPlayerDisplayName() {
            try {
                // isLoggedInÏù¥ Ï†ïÏùòÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò falseÏù∏ Í≤ΩÏö∞ Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú Ï≤òÎ¶¨
                if (typeof isLoggedIn !== 'undefined' && isLoggedIn && currentUserData) {
                    // Î°úÍ∑∏Ïù∏Ìïú Í≥ÑÏ†ï: ÏÑúÎ≤ÑÏùò ÏïÑÏù¥ÏΩòÍ≥º ÎãâÎÑ§ÏûÑ ÏÇ¨Ïö©
                    const playerIcon = currentUserData.icon || localStorage.getItem('playerIcon') || 'üë§';
                    return `${playerIcon} ${currentUserData.nickname}`;
                } else {
                    // Í≤åÏä§Ìä∏ Î™®Îìú: 'ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨' Í≥†Ï†ï
                    const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                    return `${playerIcon} ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨`;
                }
            } catch (error) {
                // Ïò§Î•ò Î∞úÏÉù Ïãú Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú Ï≤òÎ¶¨
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                return `${playerIcon} ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨`;
            }
        }
        
        // Ïù¥Î¶Ñ Ï†ÄÏû• ÏÑ±Í≥µ ÌëúÏãú
        function showNameSaveSuccess() {
            const nameSaveStatus = DOM.get('name-save-status');
            if (nameSaveStatus) {
                nameSaveStatus.classList.remove('hidden');
                setTimeout(() => {
                    nameSaveStatus.classList.add('hidden');
                }, 2000);
            }
        }

        // ÌÅ¥Î¶≠ Ïãú ÌôïÏù∏ ÌåùÏóÖ ÌëúÏãú
        usedStonesPile.addEventListener('click', () => {
            playCardSound();
            showCardListModal('ÏÇ¨Ïö©Ìïú Ï£ºÎ¨∏ Î™©Î°ù', state.usedStones);
        });
        
        secretStonesPile.addEventListener('click', () => {
            playCardSound();
            showCombinedSecretStonesModal();
        });

        // ÎîîÎ≤ÑÍ∑∏ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        DOM.get('debug-show-state').addEventListener('click', showDebugInfo);
        DOM.get('debug-show-player-hand').addEventListener('click', showPlayerHand);
        DOM.get('debug-show-ai-hand').addEventListener('click', showAIHand);
        DOM.get('debug-reset-game').addEventListener('click', resetGame);
        DOM.get('debug-player-win').addEventListener('click', () => {
            state.players[1].health = 0;
            checkGameOver();
        });
        DOM.get('debug-ai-win').addEventListener('click', () => {
            state.players[0].health = 0;
            checkGameOver();
        });
        DOM.get('debug-add-player-health').addEventListener('click', () => {
            if (state.players[0].health < 5) state.players[0].health++;
            render();
        });
        DOM.get('debug-add-ai-health').addEventListener('click', () => {
            if (state.players[1].health < 5) state.players[1].health++;
            render();
        });

        // Î™®Î∞îÏùº ÏµúÏ†ÅÌôî Ìï®ÏàòÎì§
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // ÌôîÎ©¥ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Í∞êÏßÄ Î∞è Ï£ºÎ¨∏ Î≤ÑÌäº Ïû¨ÏÉùÏÑ±
        function handleResize() {
            if (state && state.gameStarted) {
                createSpellButtons();
            }
        }
        
        // Î™®Î∞îÏùºÏóêÏÑú Ïª¥Ìå©Ìä∏ Î™®Îìú ÌÜ†Í∏Ä
        function toggleCompactMode() {
            const gameScreen = DOM.get('game-screen');
            gameScreen.classList.toggle('compact-mode');
            console.log('üì± Ïª¥Ìå©Ìä∏ Î™®Îìú ÌÜ†Í∏Ä');
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        window.addEventListener('resize', handleResize);
        
        // localStorageÏùò ÏäπÎ¶¨Ïùò Ï¶ùÌëú Îç∞Ïù¥ÌÑ∞Î•º ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
        const syncLocalDataToServer = () => {
            if (socket && socket.connected) {
                const playerName = localStorage.getItem('playerName') || 'Player';
                const playerIcon = localStorage.getItem('playerIcon') || 'üë§';
                const aiTrophies = parseInt(localStorage.getItem('aiTrophies')) || 0;
                const multiplayerTrophies = parseInt(localStorage.getItem('multiplayerTrophies')) || 0;
                
                console.log(`üìä localStorage Îç∞Ïù¥ÌÑ∞ ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî: ${playerName} (AI: ${aiTrophies}Ï†ê, Î©ÄÌã∞: ${multiplayerTrophies}Ï†ê)`);
                
                // AI Îû≠ÌÇπ ÏóÖÎç∞Ïù¥Ìä∏
                if (aiTrophies > 0) {
                    socket.emit('updateRanking', {
                        category: 'mock',
                        playerName: playerName,
                        score: aiTrophies,
                        icon: playerIcon
                    });
                }
                
                // Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Îû≠ÌÇπ ÏóÖÎç∞Ïù¥Ìä∏
                if (multiplayerTrophies > 0) {
                    socket.emit('updateRanking', {
                        category: 'formal',
                        playerName: playerName,
                        score: multiplayerTrophies,
                        icon: playerIcon
                    });
                }
            }
        };
        
        // Í≥ÑÏ†ï ÏãúÏä§ÌÖú Î≥ÄÏàòÎì§
        let currentSessionId = null;
        let currentUserData = null;
        let isLoggedIn = false;

        // Í≥ÑÏ†ï ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        function initializeAccountSystem() {
            // Ï†ÄÏû•Îêú ÏÑ∏ÏÖò ÌôïÏù∏
            const savedSessionId = localStorage.getItem('sessionId');
            if (savedSessionId) {
                verifySession(savedSessionId);
            }
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateAccountUI();
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            setupAccountEventListeners();
        }

        // ÏÑ∏ÏÖò ÌôïÏù∏
        async function verifySession(sessionId) {
            try {
                const response = await fetch('/api/verify-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = sessionId;
                    currentUserData = data.userData;
                    isLoggedIn = true;
                    
                    // ÏÑúÎ≤Ñ ÏùëÎãµ ÌôïÏù∏
                    console.log('üîç ÏÑúÎ≤Ñ ÏùëÎãµ userData:', data.userData);
                    
                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                    localStorage.setItem('sessionId', sessionId);
                    localStorage.setItem('userData', JSON.stringify(data.userData));
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateAccountUI();
                    updateTrophyDisplay();
                    
                    console.log(`üîê ÏÑ∏ÏÖò ÌôïÏù∏ ÏÑ±Í≥µ: ${currentUserData.nickname}`);
                } else {
                    // ÏÑ∏ÏÖòÏù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏÇ≠Ï†ú
                    localStorage.removeItem('sessionId');
                    localStorage.removeItem('userData');
                    currentSessionId = null;
                    currentUserData = null;
                    isLoggedIn = false;
                    updateAccountUI();
                }
            } catch (error) {
                console.error('‚ùå ÏÑ∏ÏÖò ÌôïÏù∏ Ïò§Î•ò:', error);
                localStorage.removeItem('sessionId');
                localStorage.removeItem('userData');
                currentSessionId = null;
                currentUserData = null;
                isLoggedIn = false;
                updateAccountUI();
            }
        }

        // Î°úÍ∑∏Ïù∏ Ìï®Ïàò
        async function login(username, password) {
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    currentUserData = data.userData;
                    isLoggedIn = true;
                    
                    // ÏÑúÎ≤Ñ ÏùëÎãµ ÌôïÏù∏
                    console.log('üîç ÏÑúÎ≤Ñ ÏùëÎãµ userData:', data.userData);
                    
                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                    localStorage.setItem('sessionId', data.sessionId);
                    localStorage.setItem('userData', JSON.stringify(data.userData));
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateAccountUI();
                    updateTrophyDisplay();
                    
                    console.log(`üîê Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ: ${currentUserData.nickname}`);
                    return { success: true };
                } else {
                    return { success: false, error: data.error };
                }
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                return { success: false, error: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' };
            }
        }

        // ÌöåÏõêÍ∞ÄÏûÖ Ìï®Ïàò
        async function register(username, password, nickname) {
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, nickname })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    currentUserData = data.userData;
                    isLoggedIn = true;
                    
                    // ÏÑúÎ≤Ñ ÏùëÎãµ ÌôïÏù∏
                    console.log('üîç ÏÑúÎ≤Ñ ÏùëÎãµ userData:', data.userData);
                    
                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                    localStorage.setItem('sessionId', data.sessionId);
                    localStorage.setItem('userData', JSON.stringify(data.userData));
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateAccountUI();
                    updateTrophyDisplay();
                    
                    console.log(` ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ: ${currentUserData.nickname}`);
                    return { success: true };
                } else {
                    return { success: false, error: data.error };
                }
            } catch (error) {
                console.error('‚ùå ÌöåÏõêÍ∞ÄÏûÖ Ïò§Î•ò:', error);
                return { success: false, error: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' };
            }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ Ìï®Ïàò
        function logout() {
            currentSessionId = null;
            currentUserData = null;
            isLoggedIn = false;
            
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Í≥ÑÏ†ï Ï†ïÎ≥¥ ÏÇ≠Ï†ú
            localStorage.removeItem('sessionId');
            localStorage.removeItem('userData');
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateAccountUI();
            updateTrophyDisplay();
            
            console.log('üîê Î°úÍ∑∏ÏïÑÏõÉÎê®');
            showToast('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§.', 'info', 2000);
        }

        // UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§
        function updateAccountUI() {
            const guestDisplay = DOM.get('guest-mode-display');
            const accountDisplay = DOM.get('account-mode-display');
            const guestNameInput = DOM.get('guest-name-input');
            const accountStatus = DOM.get('account-status');
            const nameInput = DOM.get('player-name-input');
            const saveBtn = DOM.get('save-name-btn');
            const profileBtn = DOM.get('profile-btn');
            const trophyDisplay = DOM.get('trophy-display');
            
            if (isLoggedIn && currentUserData) {
                // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú
                guestDisplay.classList.add('hidden');
                accountDisplay.classList.remove('hidden');
                guestNameInput.classList.add('hidden');
                accountStatus.classList.remove('hidden');
                
                // Í≥ÑÏ†ï Ï†ïÎ≥¥ ÌëúÏãú
                DOM.get('account-nickname').textContent = currentUserData.nickname;
                
                // ÏÑúÎ≤ÑÏùò ÏïÑÏù¥ÏΩò ÌëúÏãú
                const accountIcon = DOM.get('account-mode-display').querySelector('.text-xl');
                if (accountIcon && currentUserData) {
                    console.log('üîç ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏:', currentUserData.icon || 'üë§');
                    console.log('üîç Ï†ÑÏ≤¥ userData:', currentUserData);
                    accountIcon.textContent = currentUserData.icon || 'üë§';
                }
                
                // Ïù¥Î¶Ñ ÏûÖÎ†• ÎπÑÌôúÏÑ±Ìôî
                nameInput.disabled = true;
                nameInput.style.opacity = '0.6';
                saveBtn.style.display = 'none';
                
                // ÎÇ¥ Ï†ïÎ≥¥ Î≤ÑÌäºÍ≥º Ìä∏Î°úÌîº ÌëúÏãú (Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†ÄÎßå)
                profileBtn.classList.remove('hidden');
                trophyDisplay.classList.remove('hidden');
                
                // Îû≠ÌÇπ Î≤ÑÌäºÏùÄ Ìï≠ÏÉÅ ÌëúÏãú (Í≤åÏä§Ìä∏ÎèÑ Î≥º Ïàò ÏûàÏùå)
                DOM.get('ranking-btn').classList.remove('hidden');
                
            } else {
                // Í≤åÏä§Ìä∏ ÏÉÅÌÉú
                guestDisplay.classList.remove('hidden');
                accountDisplay.classList.add('hidden');
                guestNameInput.classList.remove('hidden');
                accountStatus.classList.add('hidden');
                
                // Í≤åÏä§Ìä∏ ÎãâÎÑ§ÏûÑÏùÑ 'ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨'Î°ú Í≥†Ï†ï
                DOM.get('account-nickname').textContent = 'ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨';
                
                // Ïù¥Î¶Ñ ÏûÖÎ†• ÎπÑÌôúÏÑ±Ìôî (Í≤åÏä§Ìä∏Îäî ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Î∂àÍ∞Ä)
                nameInput.disabled = true;
                nameInput.style.opacity = '0.6';
                nameInput.value = 'ÏßÄÎÇòÍ∞ÄÎäî ÎßàÎ≤ïÏÇ¨';
                saveBtn.style.display = 'none';
                
                // ÎÇ¥ Ï†ïÎ≥¥ Î≤ÑÌäºÍ≥º Ìä∏Î°úÌîº Ïà®ÍπÄ (Í≤åÏä§Ìä∏Îäî Î≥º Ïàò ÏóÜÏùå)
                profileBtn.classList.add('hidden');
                trophyDisplay.classList.add('hidden');
                
                // Îû≠ÌÇπ Î≤ÑÌäºÏùÄ Í≤åÏä§Ìä∏ÎèÑ Î≥º Ïàò ÏûàÏùå
                DOM.get('ranking-btn').classList.remove('hidden');
            }
        }

        function updateTrophyDisplay() {
            const aiTrophyCount = DOM.get('ai-trophy-count');
            const multiplayerTrophyCount = DOM.get('multiplayer-trophy-count');
            
            if (isLoggedIn && currentUserData) {
                aiTrophyCount.textContent = currentUserData.trophies.mock || 0;
                multiplayerTrophyCount.textContent = currentUserData.trophies.formal || 0;
            } else {
                // Í≤åÏä§Ìä∏ Î™®Îìú: 0ÏúºÎ°ú ÌëúÏãú
                aiTrophyCount.textContent = '0';
                multiplayerTrophyCount.textContent = '0';
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupAccountEventListeners() {
            // Î°úÍ∑∏Ïù∏ Î≤ÑÌäº
            DOM.get('login-btn').addEventListener('click', () => {
                showAuthModal('login');
            });
            
            // Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº
            DOM.get('logout-btn').addEventListener('click', logout);
            
            // Ïù∏Ï¶ù Î™®Îã¨ Ïù¥Î≤§Ìä∏
            setupAuthModalEvents();
            
            // Í≤åÏûÑ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ÏàòÏ†ï (Í≥ÑÏ†ï ÏãúÏä§ÌÖúÍ≥º Ïó∞Îèô)
            // Ï†ïÏãù Í≤∞Ìà¨ Î≤ÑÌäºÏùÄ Ïù¥ÎØ∏ ÏúÑÏóêÏÑú Ï≤òÎ¶¨Îê®
        }

        // Ïù∏Ï¶ù Î™®Îã¨ ÌëúÏãú
        function showAuthModal(mode = 'login') {
            const modal = DOM.get('auth-modal');
            const loginForm = DOM.get('login-form');
            const registerForm = DOM.get('register-form');
            const title = DOM.get('auth-title');
            const subtitle = DOM.get('auth-subtitle');
            
            if (mode === 'login') {
                title.textContent = 'Î°úÍ∑∏Ïù∏';
                subtitle.textContent = 'Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏ÌïòÏó¨ Ï†êÏàòÎ•º Ï†ÄÏû•ÌïòÏÑ∏Ïöî';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                title.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
                subtitle.textContent = 'ÏÉà Í≥ÑÏ†ïÏùÑ ÎßåÎì§Ïñ¥ Ï†êÏàòÎ•º Ï†ÄÏû•ÌïòÏÑ∏Ïöî';
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        // Ïù∏Ï¶ù Î™®Îã¨ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        function setupAuthModalEvents() {
            const modal = DOM.get('auth-modal');
            const loginForm = DOM.get('login-form');
            const registerForm = DOM.get('register-form');
            const switchToRegister = DOM.get('switch-to-register');
            const switchToLogin = DOM.get('switch-to-login');
            const closeBtn = DOM.get('close-auth-btn');
            
            // Ìèº Ï†ÑÌôò
            switchToRegister.addEventListener('click', () => {
                showAuthModal('register');
            });
            
            switchToLogin.addEventListener('click', () => {
                showAuthModal('login');
            });
            
            // Î°úÍ∑∏Ïù∏ Ìèº Ï†úÏ∂ú
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = DOM.get('login-username').value;
                const password = DOM.get('login-password').value;
                
                const result = await login(username, password);
                
                if (result.success) {
                    modal.classList.add('hidden');
                    showToast('Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§.', 'success', 2000);
                } else {
                    showToast(result.error, 'error', 3000);
                }
            });
            
            // ÌöåÏõêÍ∞ÄÏûÖ Ìèº Ï†úÏ∂ú
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = DOM.get('register-username').value;
                const password = DOM.get('register-password').value;
                const nickname = DOM.get('register-nickname').value;
                
                const result = await register(username, password, nickname);
                
                if (result.success) {
                    modal.classList.add('hidden');
                    showToast('ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.', 'success', 2000);
                } else {
                    showToast(result.error, 'error', 3000);
                }
            });
            
            // Îã´Í∏∞ Î≤ÑÌäº
            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }

        // Í≤åÏûÑ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        async function updateGameResult(gameType, isWin, opponentNickname = null) {
            if (!isLoggedIn || !currentSessionId) {
                console.log('Í≤åÏä§Ìä∏ Î™®Îìú: Ï†êÏàò Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùå');
                return;
            }
            
            try {
                const response = await fetch('/api/update-trophies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        category: gameType,
                        change: isWin ? 2 : -1
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUserData.trophies = data.trophies;
                    updateTrophyDisplay();
                    
                    console.log(` Í≤åÏûÑ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏: ${gameType} ${isWin ? 'ÏäπÎ¶¨' : 'Ìå®Î∞∞'}`);
                    
                    // Îû≠ÌÇπ Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÎã§Î©¥ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                    const rankingModal = document.querySelector('#ranking-modal');
                    if (rankingModal && !rankingModal.classList.contains('hidden')) {
                        console.log('üîÑ Í≤åÏûÑ Í≤∞Í≥º Î∞òÏòÅÌïòÏó¨ Îû≠ÌÇπ ÏÉàÎ°úÍ≥†Ïπ®');
                        loadRankingData();
                    }
                }
            } catch (error) {
                console.error('‚ùå Í≤åÏûÑ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Î≥∏ Ïù¥Î¶Ñ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ ÌéòÏù¥ÏßÄ Î°úÎìú - Í∏∞Î≥∏ Ïù¥Î¶Ñ Ï¥àÍ∏∞Ìôî');
            DOM.init(); // DOM Ï∫êÏãú Ï¥àÍ∏∞Ìôî
            TrophySystem.init(); // Ï¶ùÌëú ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            getOrCreateUserId(); // Ïú†Ï†Ä ID Ï¥àÍ∏∞Ìôî
            initializePlayerName();
            
            // Í≥ÑÏ†ï ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï∂îÍ∞Ä
            initializeAccountSystem();
            
            // AudioContext Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
            console.log('üîä AudioContext ÏÉÅÌÉú:', audioContext.state);
            if (audioContext.state === 'suspended') {
                console.log('üîä AudioContext ÏùºÏãú Ï§ëÎã® ÏÉÅÌÉú - ÏÇ¨Ïö©Ïûê ÏÉÅÌò∏ÏûëÏö© ÎåÄÍ∏∞ Ï§ë');
            }
            
            // ÏÜåÏºì Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî (Îû≠ÌÇπ Í∏∞Îä•ÏùÑ ÏúÑÌï¥)
            console.log('üîå ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÜåÏºì Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî');
            initializeSocketIO();
            
            // ÏÜåÏºì Ïó∞Í≤∞ ÌõÑ localStorage Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            setTimeout(() => {
                if (socket && socket.connected) {
                    syncLocalDataToServer();
                } else {
                    // ÏÜåÏºì Ïó∞Í≤∞ ÎåÄÍ∏∞ ÌõÑ Îã§Ïãú ÏãúÎèÑ
                    socket.on('connect', () => {
                        syncLocalDataToServer();
                    });
                }
            }, 1000);
        });

    </script>
</body>
</html>
 