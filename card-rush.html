<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@400&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@latest/dist/web/static/pretendard.css" />
  <title>CARD-RUSH</title>
  <style>
    @font-face{
      font-family:'Peepo';
      src:url('PEEPO.ttf') format('truetype');
      font-weight:400 900;
      font-style:normal;
      font-display:swap;
    }
    :root{
      --bg:#ffffff;--panel:#ffffff;--panel2:#f7f7f8;--text:#111111;--muted:#6b7280;--accent:#111111;--good:#16a34a;--bad:#dc2626;--warn:#111111;
      --card-w:96px;--card-h:120px;--grid-gap:12px
    }
    /* Dark theme tokens */
    body.theme-dark{
      --bg:#0b0f1a;--panel:#0e1424;--panel2:#0e1424;--text:#e8ecf6;--muted:#9aa4bf;--accent:#e8ecf6;--good:#22c55e;--bad:#ef4444;--warn:#e8ecf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Pretendard Variable","Pretendard",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #e5e9f5;background:linear-gradient(180deg,#fff,#f6f9ff)}
    header h1{margin:0;font-size:16px;color:#1f2a44;letter-spacing:.4px}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;background:linear-gradient(90deg,#eef3ff,#f7faff);border:1px solid #d9e2ff;color:#3f4d77}

    .wrap{max-width:960px;margin:0 auto;padding:16px;flex:1;display:flex;align-items:center;justify-content:center}
    .grid{display:flex;flex-direction:column;align-items:center;gap:12px}
    .title-brand{font-family:"Peepo","Bangers", system-ui, sans-serif; font-size:42px; letter-spacing:2px; color:#ebebeb; margin:0 0 2px}
    .title-brand .brand-c{color:#c02626}
    .title-brand .brand-h{color:#0f172a}
    .title-brand .title-emoji{font-size:28px;margin-left:10px;vertical-align:middle;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12))}

    .board{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);width:100%;max-width:720px}
    .theme-dark .board{background:#0e1424;border-color:#1f2a44;box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .board h2{font-size:14px;margin:0 0 10px;color:#1f2a44;font-weight:800}

    .status{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
    .chip{background:var(--panel);border:1px solid #e4e9f6;border-radius:12px;padding:10px 12px;text-align:center}
    .theme-dark .chip{background:#0e1424;border-color:#1e293b}
    .chip .label{display:block;font-size:11px;color:var(--muted)}
    .chip .value{display:block;font-size:18px;font-weight:900;margin-top:2px}

    .target{display:flex;flex-direction:column;align-items:center;gap:8px;background:#f6f7fb;border:1px solid #e5e7eb;border-radius:14px;padding:18px;text-align:center}
    .theme-dark .target{background:#0d1526;border-color:#1e293b}
    .tg-num{min-width:96px;height:96px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#ffffff;border:1px solid #e5e7eb;font-size:56px;font-weight:900;color:#111;padding:8px 16px}
    .theme-dark .tg-num{background:#0b0f1a;border-color:#1e293b;color:#e8ecf6}
    .tg-meta{width:100%}
    .tg-title{margin:0 0 4px;font-weight:900;font-size:16px;color:#2b3a66}
    .tg-desc{margin:2px 0 0;color:#5f6e91;font-size:13px}
    .game-desc{background:var(--panel2);border:none;color:#333;border-radius:12px;padding:10px 12px;margin-bottom:12px;font-weight:700;text-align:center}
    .theme-dark .game-desc{color:#e6ebf7}

    .hand{display:grid;grid-template-columns:repeat(5, var(--card-w));gap:var(--grid-gap);justify-content:center;margin-top:12px;min-height:calc(var(--card-h)*2 + var(--grid-gap));grid-auto-rows:var(--card-h);align-items:start;align-content:center}
    .card{position:relative;display:flex;align-items:center;justify-content:center;width:var(--card-w);height:var(--card-h);border-radius:14px;background:#fff;border:1px solid #e5e7eb;color:#111;font-size:32px;font-weight:900;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,opacity .12s;will-change:transform;backface-visibility:hidden;transform-style:preserve-3d;filter:brightness(1.02)}
    .theme-dark .card{background:#10172a;border-color:#1f2a44;color:#f8fafc;filter:brightness(1.1)}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,.06)}
    .theme-dark .card:hover{box-shadow:0 8px 16px rgba(0,0,0,.35)}
    .card.disabled{opacity:.55;pointer-events:none}
    .card .small{position:absolute;bottom:8px;right:10px;font-size:11px;color:#6c7aa0}
    .card.red{color:#c02626}
    .theme-dark .card.red{color:#f87171}
    .card .corner{position:absolute;display:flex;flex-direction:column;align-items:center;line-height:1}
    .card .corner .rank{font-size:18px}
    .card .corner .suit{display:none}
    .card .corner.tl{top:8px;left:10px}
    .card .corner.br{bottom:8px;right:10px;transform:rotate(180deg)}
    .card .suit-large{display:none}
    .theme-dark .card .suit-large{opacity:.18}
    .card.placeholder{background:linear-gradient(180deg,#fbfdff,#f7faff);border-style:dashed;color:#a3aed0}
    .theme-dark .card.placeholder{background:linear-gradient(180deg,#10192b,#0b1220);color:#64748b;border-color:#243045}
    .spacer{width:var(--card-w);height:var(--card-h);display:block}
    .card.concealed{background:linear-gradient(180deg,#f7f9ff,#f3f6ff);border-color:#e3e9f8;color:#7b89a9}
    .theme-dark .card.concealed{background:linear-gradient(180deg,#10192b,#0b1220);border-color:#243045;color:#9aa4bf}
    .question-large{font-size:42px;opacity:.5}
    .card.flip{animation:flipIn .38s ease both}

    @keyframes idleWobble{
      0%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-2px) rotate(-0.6deg)}
      100%{transform:translateY(0) rotate(0.4deg)}
    }
    @keyframes flipIn{
      0%{transform:rotateY(-90deg) scale(.98);opacity:.0}
      60%{transform:rotateY(12deg) scale(1);opacity:1}
      100%{transform:rotateY(0)}
    }

    /* Pips (suit icons arranged like real cards) */
    .pips{position:absolute;inset:0;pointer-events:none}
    .pip{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:18px;line-height:1;opacity:.5}
    .theme-dark .pip{filter:none;opacity:.5}

    /* Floating +1s text */
    .penalty-float{position:fixed;left:0;top:0;transform:translate(-50%,-50%);font-weight:900;color:#dc2626;font-size:18px;pointer-events:none;z-index:60;opacity:0;}
    @keyframes floatUp{0%{transform:translate(-50%,-20%);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:translate(-50%,-120%);opacity:0}}
    .penalty-float.show{animation:floatUp .9s ease forwards}

    /* Tiny particle burst */
    .particle{position:fixed;left:0;top:0;width:6px;height:6px;border-radius:50%;pointer-events:none;z-index:60;opacity:0.9}
    @keyframes pop{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(0.6);opacity:0}}

    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center}
    .controls.top{margin-bottom:6px}
    .controls.top .btn{min-width:96px}
    .controls.between{width:100%;max-width:720px;margin:4px 0}
    .btn{background:linear-gradient(180deg,#f5f5f5,#ececec);border:1px solid #d1d5db;color:#111;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#eeeeee,#e3e3e3);border-color:#cfd3d8;color:#111}
    .btn.warn{background:linear-gradient(180deg,#f5f5f5,#ececec);border-color:#d1d5db;color:#111}
    /* Controls buttons styling aligned to difficulty scheme */
    .controls.between .btn{background:linear-gradient(180deg,#fbfbfb,#f6f6f6);border-color:#ececec;color:#111}
    .controls.between #startBtn{background:linear-gradient(180deg,#e8e8e8,#dfdfdf);border-color:#cfd3d8;color:#111;min-width:160px}
    .controls.between #rankBtn{min-width:160px}
    .theme-dark .controls.between .btn{background:linear-gradient(180deg,#293448,#1b2435);border-color:#35435a;color:#e5e7eb}
    .theme-dark .controls.between #startBtn{background:linear-gradient(180deg,#3b4a62,#2a364b);border-color:#475569;color:#fff}
    .btn .lead-icon{margin-right:8px;}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .controls.secondary{justify-content:center;margin-top:14px}
    .btn.ghost{background:#fff;border:1px dashed #d6def5;color:#2b3a66}
    .btn.ghost:hover{box-shadow:0 6px 14px rgba(15,23,42,.08)}
    .target .inline-actions{margin-top:10px;display:flex;gap:8px;justify-content:center}
    .difficulty-head{font-size:12px;color:#5f6e91;text-align:center;margin:4px 0 6px;letter-spacing:.2px}
    #difficulty .btn{display:inline-flex;align-items:center;gap:8px}
    #difficulty .btn .icon-img{width:22px;height:22px;object-fit:contain;display:inline-block;border-radius:4px;box-shadow:inset 0 1px 0 #fff;background:#fff}
    /* Emphasize selected difficulty by washing out unselected buttons */
    #difficulty .btn{background:linear-gradient(180deg,#fbfbfb,#f6f6f6);border-color:#ececec;color:#9ca3af}
    #difficulty .btn.primary{background:linear-gradient(180deg,#e8e8e8,#dfdfdf);border-color:#cfd3d8;color:#111}
    .theme-dark #difficulty .btn{background:linear-gradient(180deg,#202a3f,#151e30);border-color:#2a3850;color:#8b95a7}
    .theme-dark #difficulty .btn.primary{background:linear-gradient(180deg,#374151,#1f2937);border-color:#4b5563;color:#fff}
    
    /* Rankings modal */
    .rank-list{margin:8px 0 0;padding:0;list-style:none;max-height:300px;overflow:auto;border-top:1px solid #eee}
    .rank-list li{display:flex;justify-content:space-between;padding:8px 2px;border-bottom:1px solid #f2f2f2;font-size:14px}
    .rank-list .nick{color:#111;font-weight:700}
    .rank-list .time{color:#444}

    .log{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;height:160px;overflow:auto;line-height:1.4}
    .log p{margin:6px 0;font-size:13px;color:#354872}
    .log .good{color:var(--good)}
    .log .bad{color:var(--bad)}
    .log .muted{color:#6c7aa0}

    footer{padding:14px;text-align:center;color:#556084;font-size:12px}
    
    /* Result Modal */
    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.35);backdrop-filter:blur(2px);z-index:50}
    .modal .dialog{width:100%;max-width:420px;background:linear-gradient(180deg,#ffffff,#f7f9ff);border:1px solid #e5e9f5;border-radius:16px;box-shadow:0 12px 40px rgba(15,23,42,.18);padding:18px}
    .modal .dialog h3{margin:0 0 8px;color:#1f2a44;font-size:18px}
    .modal .dialog p{margin:6px 0;color:#354872;font-size:14px}
    .modal .row{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .modal .row .btn{min-width:120px}

    @media (max-width:900px){
      .status{grid-template-columns:repeat(3,1fr)}
    }
  </style>
</head>
<body>
  

  <div class="wrap">
    <div class="grid">
      <h1 class="title-brand"><span class="brand-c">C</span>ARD RUS<span class="brand-h">H</span><span class="title-emoji" aria-hidden="true">🂡</span></h1>
      <div class="controls top" id="difficulty">
        <button class="btn" data-hand="3"><img class="icon-img" src="jack.png" alt="Jack" /> 잭 </button>
        <button class="btn primary" data-hand="5"><img class="icon-img" src="queen.png" alt="Queen" /> 퀸</button>
        <button class="btn" data-hand="10"><img class="icon-img" src="king.png" alt="King" /> 킹</button>
      </div>
      <div class="difficulty-head">난이도를 선택하고, 게임을 시작하세요!</div>
      <!-- Game -->
      <section class="board">
        <div class="status">
          
          
          <div class="chip"><span class="label">기록 시간</span><span class="value" id="time">0.00s</span></div>
          <div class="chip"><span class="label">남은 카드</span><span class="value" id="piles">0</span></div>
          <div class="chip"><span class="label">최고 기록</span><span class="value" id="best">-</span></div>
        </div>

        <div class="game-desc">같은 숫자를 맞추세요!<br>40장의 카드를 모두 맞추면 게임이 종료됩니다.</div>

        

        <div class="target">
          <p class="tg-title">목표 숫자</p>
          <div class="tg-num" id="targetNum">-</div>
        </div>

        

        <div class="hand" id="hand"></div>

        
      </section>

      <div class="controls between">
        <button class="btn primary" id="startBtn"><span class="lead-icon" aria-hidden="true">⚔️</span>게임 시작</button>
        <button class="btn" id="resetBtn"><span class="lead-icon" aria-hidden="true">🔄</span>새로고침</button>
        <button class="btn" id="rankBtn"><span class="lead-icon" aria-hidden="true">🏆</span>랭킹 보기</button>
      </div>
      <div class="controls" style="margin-top:6px">
        <button class="btn" id="themeBtn" style="background:linear-gradient(180deg,#fbfbfb,#f6f6f6);border-color:#ececec;color:#111"><span class="lead-icon" aria-hidden="true">🌙</span><span id="themeText">다크모드</span></button>
      </div>
      

      
    </div>
  </div>

  <footer>© 카드 러시 프로토타입 · v1</footer>

  <div class="modal" id="resultModal" hidden>
    <div class="dialog">
      <h3>게임 결과</h3>
      <p>최고 기록: <b id="resultBest">-</b></p>
      <p>기록 시간: <b id="resultCombo">-</b></p>
      <div class="row">
        <button class="btn primary" id="againBtn">다시 하기</button>
        <button class="btn" id="closeModalBtn">닫기</button>
      </div>
    </div>
  </div>

  <div class="modal" id="rankModal" hidden>
    <div class="dialog">
      <h3>랭킹</h3>
      <p style="margin:0 0 6px;color:#555">현재 난이도: <b id="rankDifficulty">-</b></p>
      <ul class="rank-list" id="rankList"></ul>
      <div class="row">
        <button class="btn" id="closeRankBtn">닫기</button>
      </div>
    </div>
  </div>

  <div class="modal" id="submitModal" hidden>
    <div class="dialog">
      <h3>기록 제출</h3>
      <p>기록 <b id="submitTime">0.00s</b>를 달성했습니다! 랭킹에 등록하시겠습니까?</p>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <input id="nicknameInput" class="btn" style="flex:1;text-align:left" placeholder="닉네임 입력" />
        <button class="btn primary" id="submitConfirm">확인</button>
        <button class="btn" id="submitCancel">취소</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const ROUND_TIME = null; // unused (stopwatch)
  let HAND_SIZE = 5;

  let deck = [];
  let discard = [];
  let hand = [];
  let target = null;
  let score = 0; // deprecated
  let combo = 0; // deprecated
  let timer = null;
  let startTimeMs = 0;
  let elapsedMs = 0;
  let lastElapsedMs = 0; // 마지막 종료 기록 보존 (제출용)
  let running = false;
  let shuffledThisTurn = false; // (미사용) 1회 제한 제거
  let flipIndices = new Set(); // 교체된 슬롯들만 플립 애니메이션

  // Trump suits (1~10)
  const SUITS = ['♠','♥','♦','♣'];
  const SUIT_NAME_KO = { '♠':'스페이드', '♥':'하트', '♦':'다이아', '♣':'클럽' };
  function isRedSuit(s){ return s==='♥' || s==='♦'; }
  function formatCard(c){ return `${c.rank}${c.suit}`; }

  // UI refs
  const el = {
    target: document.getElementById('targetNum'),
    hand: document.getElementById('hand'),
    // score/combo UI 제거됨
    time: document.getElementById('time'),
    piles: document.getElementById('piles'),
    best: document.getElementById('best'),
    // 로그 UI 제거됨
    log: document.getElementById('log'),
    start: document.getElementById('startBtn'),
    shuffle: null,
    reset: document.getElementById('resetBtn'),
    rank: document.getElementById('rankBtn'),
    tip: document.getElementById('tip')
  };

  function init(){
    // 초기 테마 적용
    try{
      const saved = localStorage.getItem('cardrush_theme') || 'light';
      setTheme(saved);
    }catch(_){ setTheme('light'); }
    updateBestHUDFromStorage();
    wire();
    setupAudio();
    reset();
  }

  function wire(){
    el.start.addEventListener('click', start);
    
    el.reset.addEventListener('click', ()=>{stop(); reset();});
    // accessibility toggle
    // removed accessibility toggle
    // modal buttons
    document.getElementById('againBtn').addEventListener('click', ()=>{ hideResultModal(); stop(); reset(); start(); });
    document.getElementById('closeModalBtn').addEventListener('click', hideResultModal);
    // ranking modal
    el.rank.addEventListener('click', openRankingModal);
    document.getElementById('closeRankBtn').addEventListener('click', ()=> document.getElementById('rankModal').hidden = true);
    // submit modal events
    document.getElementById('submitConfirm').addEventListener('click', submitScore);
    document.getElementById('submitCancel').addEventListener('click', ()=> document.getElementById('submitModal').hidden = true);
    // difficulty buttons
    document.querySelectorAll('#difficulty .btn').forEach((b)=>{
      b.addEventListener('click', ()=>{
        const n = Number(b.getAttribute('data-hand'));
        if(Number.isFinite(n)){
          HAND_SIZE = n;
          document.querySelectorAll('#difficulty .btn').forEach(x=>x.classList.remove('primary'));
          b.classList.add('primary');
          stop(); reset();
          updateBestHUDFromStorage();
        }
      });
    });

    // theme toggle
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', ()=>{
      const next = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
      setTheme(next);
      try{ localStorage.setItem('cardrush_theme', next); }catch(_){ }
    });
  }

  function setTheme(mode){
    const isDark = mode === 'dark';
    document.body.classList.toggle('theme-dark', isDark);
    const icon = document.querySelector('#themeBtn .lead-icon');
    const txt = document.getElementById('themeText');
    const btn = document.getElementById('themeBtn');
    if(icon) icon.textContent = isDark ? '☀️' : '🌙';
    if(txt) txt.textContent = isDark ? '라이트모드' : '다크모드';
    if(btn){
      if(isDark){
        btn.style.background = 'linear-gradient(180deg,#293448,#1b2435)';
        btn.style.borderColor = '#35435a';
        btn.style.color = '#e5e7eb';
      } else {
        btn.style.background = 'linear-gradient(180deg,#fbfbfb,#f6f6f6)';
        btn.style.borderColor = '#ececec';
        btn.style.color = '#111';
      }
    }
  }

  function reset(){
    stop();
    deck = makeDeck();
    discard = [];
    hand = [];
    score = 0; combo = 0; elapsedMs = 0; running=false; shuffledThisTurn=false;
    drawHand(HAND_SIZE);
    target = null; el.target.textContent = '-';
    updateHUD();
    log('🟦 준비 완료. 시작을 누르세요.', 'muted');
    updateBestHUDFromStorage();
  }

  function start(){
    if(running) return;
    running = true;
    el.start.disabled = true;
    
    // 일부 브라우저에서 초기 상태 suspend 방지
    try{ if(audioCtx && audioCtx.state === 'suspended'){ audioCtx.resume(); } }catch(_){ }
    // 시작 사운드 (빠밤~)
    sfx.start && sfx.start();

    // 시작 시 손패를 재렌더링하여 초기 비활성화 클래스를 제거 (플립 없음)
    renderHand();
    nextTarget();
    log('🎮 게임 시작! 같은 숫자를 내세요.');
    startTimeMs = performance.now();
    timer = requestAnimationFrame(function tick(now){
      elapsedMs = now - startTimeMs;
      el.time.textContent = (elapsedMs/1000).toFixed(2) + 's';
      timer = requestAnimationFrame(tick);
    });
  }

  function stop(){ if(timer){ cancelAnimationFrame(timer); timer=null; } running=false; el.start.disabled=false; }

  function finish(){
    stop();
    lastElapsedMs = elapsedMs; // 제출을 위해 보존
    const timeSec = (lastElapsedMs/1000).toFixed(2);
    log(`🏁 종료! 기록 <b>${timeSec}s</b>`);
    const bestKey = getBestTimeKey();
    const bestTime = Number(localStorage.getItem(bestKey)||'Infinity');
    if(lastElapsedMs>0 && lastElapsedMs<bestTime){ localStorage.setItem(bestKey, String(lastElapsedMs)); el.best.textContent = (lastElapsedMs/1000).toFixed(2) + 's'; log('⏱️ 최고 기록 시간 갱신!', 'good'); }
    
    // 화면을 즉시 준비 상태로 돌려 마지막 카드가 남지 않게 처리
    const prevHandSize = HAND_SIZE;
    stop();
    deck = makeDeck();
    discard = [];
    hand = [];
    score = 0; combo = 0; elapsedMs = 0; running=false; shuffledThisTurn=false;
    drawHand(prevHandSize);
    target = null; el.target.textContent = '-';
    updateHUD();
    
    // 결과 모달 표시
    showResultModal({ score: null, best: null, comboMax: null, timeSec });
    // 제출 모달 표시
    document.getElementById('submitTime').textContent = Number(timeSec).toFixed(2)+'s';
    document.getElementById('submitModal').hidden = false;
  }

  // Deck
  function makeDeck(){
    const arr=[];
    for(const s of SUITS){
      for(let n=1;n<=10;n++){
        arr.push({ rank:n, suit:s });
      }
    }
    shuffle(arr); return arr;
  }
  function draw(){
    if(deck.length===0){
      return null; // 재구성 없이 고갈되면 종료 조건으로 진입
    }
    return deck.shift();
  }
  function drawHand(n){
    for(let i=0;i<n;i++){
      const c = draw(); if(c==null) break; hand.push(c);
    }
    renderHand(); updatePiles();
  }

  function drawInto(index){
    // 내부 리롤 규칙: 같은 카드(랭크+무늬) 재등장 회피
    const forbidden = new Set();
    const prev = hand[index];
    if(prev) forbidden.add(cardKey(prev));
    const c = drawAvoiding(forbidden);
    if(c==null) return;
    hand[index] = c;
    flipIndices.add(index);
    renderHand(); updatePiles();
  }
  function updatePiles(){
    const handCount = hand.reduce((sum, c)=> sum + (c ? 1 : 0), 0);
    el.piles.textContent = String(deck.length + handCount);
  }

  // Target
  function randomTarget(){ return 1 + Math.floor(Math.random()*10); }
  function getAvailableRanks(){
    const present = new Set();
    for(const c of hand){ if(c) present.add(c.rank); }
    return Array.from(present);
  }
  function nextTarget(avoidValue=null){
    let choices = getAvailableRanks();
    if(choices.length === 0){
      // 더 이상 낼 수 있는 숫자가 없으면 종료 고려
      target = '-'; el.target.textContent = '-';
      return;
    }
    if(avoidValue!=null && choices.length>1){ choices = choices.filter(n=>n!==avoidValue); }
    const n = choices[Math.floor(Math.random()*choices.length)];
    target = n; el.target.textContent = target;
  }

  // Render Hand
  function renderHand(){
    el.hand.innerHTML='';
    const slots = HAND_SIZE === 10 ? 10 : 5;
    const offset = HAND_SIZE === 3 ? 1 : 0; // 3장일 때 중앙 정렬용 시프트
    for(let slot=0; slot<slots; slot++){
      const handIdx = slot - offset;
      const card = handIdx>=0 && handIdx<hand.length ? hand[handIdx] : null;
      if(HAND_SIZE === 3 && (slot===0 || slot===slots-1)){
        // 가장 좌/우 칸은 완전 빈 공간으로 렌더링
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        el.hand.appendChild(spacer);
        continue;
      }
      const btn = document.createElement('button');
      if(card){
        if(!running){
          btn.className = 'card concealed';
          btn.setAttribute('aria-label','카드 비공개');
          btn.innerHTML = `<div class="question-large">?</div>`;
        } else {
          const red = isRedSuit(card.suit);
          btn.className = 'card' + (red ? ' red' : '');
          if(flipIndices.has(handIdx)) btn.classList.add('flip');
          btn.setAttribute('aria-label',`카드 ${SUIT_NAME_KO[card.suit]} ${card.rank}`);
          btn.dataset.rank = String(card.rank);
          btn.dataset.suit = card.suit;
          btn.dataset.idx = String(handIdx);
          btn.innerHTML = `
            <div class="corner tl"><span class="rank">${card.rank}</span></div>
            <div class="corner br"><span class="rank">${card.rank}</span></div>
            ${pipsHTML(card.rank, card.suit)}
          `;
        }
      } else {
        btn.className = 'card placeholder';
        btn.innerHTML = '';
      }
      if(!running) btn.classList.add('disabled');
      if(card) btn.addEventListener('click', ()=> play(handIdx));
      el.hand.appendChild(btn);
    }
    // 한 번 표시한 플립 인덱스는 초기화 (1회성 애니메이션)
    flipIndices.clear();
  }

  // Gameplay
  let comboMax = 0;
  function play(i){
    if(!running) return;
    const c = hand[i]; if(c==null) return;

    const v = c.rank;
    if(v===target){
      // 성공 파티클 이펙트 (카드 위치에서)
      try{
        const cardEl = el.hand.querySelector(`.card[data-idx="${i}"]`);
        if(cardEl){
          const rect = cardEl.getBoundingClientRect();
          burstAt(rect.left + rect.width/2, rect.top + rect.height/2, isRedSuit(c.suit) ? '#c02626' : '#111');
        }
      }catch(_){/* ignore */}
      // 정답: 해당 슬롯을 비우고 새 카드를 보충, 목표도 재설정
      hand[i] = null;
      log(`✅ 정답! ${formatCard(c)} = ${target}`,'good');
      sfx.correct();
      // 정답이면 카드 소모
      discard.push(c);
      drawInto(i);
      nextTarget();
    } else {
      // 오답 패널티: 기록에 +1s 가산
      startTimeMs -= 1000; // 경과시간에 1초를 추가하는 효과
      log(`❌ 오답… ${formatCard(c)} ≠ ${target} → <b class=bad>+1.0s</b>`,'bad');
      shake(el.target);
      sfx.wrong();
      // 오답 텍스트 +1s 플로팅 이펙트 (목표 숫자 위)
      try{
        const cardEl = el.hand.querySelector(`.card[data-idx="${i}"]`);
        if(cardEl){
          const r = cardEl.getBoundingClientRect();
          showPenaltyFloat(r.left + r.width/2, r.top - 6);
        } else {
          const r = el.time.getBoundingClientRect();
          showPenaltyFloat(r.left + r.width/2, r.top);
        }
      }catch(_){/* ignore */}
      // 오답: 손패와 목표를 그대로 유지 (카드/목표 교체 없음)
    }

    // 모든 카드를 사용했는지 확인 (덱이 비었고 손패도 모두 비었을 때)
    if(deck.length===0 && hand.every(x=>!x)){ finish(); return; }
    updateHUD();
  }

  // 패스 기능 제거

  // 셔플 기능 제거

  // HUD
  function updateHUD(){
    const seconds = (elapsedMs/1000);
    el.time.textContent = (Number.isFinite(seconds) ? seconds.toFixed(2) : '0.00') + 's';
    renderHand();
    updatePiles();
  }

  // Best time helpers (per difficulty)
  function getBestTimeKey(){
    return `cardrush_best_time_${HAND_SIZE}`; // e.g., 3/5/10
  }
  function updateBestHUDFromStorage(){
    const ms = Number(localStorage.getItem(getBestTimeKey())||'NaN');
    el.best.textContent = Number.isFinite(ms) ? (ms/1000).toFixed(2)+'s' : '-';
  }

  // Rankings - simple client-server integration (placeholder endpoints)
  function getDifficultyLabel(){
    if(HAND_SIZE===3) return 'Jack';
    if(HAND_SIZE===5) return 'Queen';
    if(HAND_SIZE===10) return 'King';
    return String(HAND_SIZE);
  }
  async function openRankingModal(){
    const modal = document.getElementById('rankModal');
    document.getElementById('rankDifficulty').textContent = getDifficultyLabel();
    const list = document.getElementById('rankList');
    list.innerHTML = '<li><span class="nick">불러오는 중…</span><span class="time">&nbsp;</span></li>';
    modal.hidden = false;
    try{
      const res = await fetch(`/api/rank?hand=${HAND_SIZE}`);
      const data = await res.json();
      list.innerHTML = '';
      (data.ranks||[]).forEach((r,idx)=>{
        const li = document.createElement('li');
        const name = document.createElement('span'); name.className='nick'; name.textContent = `${idx+1}. ${r.nickname}`;
        const time = document.createElement('span'); time.className='time'; time.textContent = `${(r.ms/1000).toFixed(2)}s`;
        li.appendChild(name); li.appendChild(time); list.appendChild(li);
      });
      if(!list.children.length){ list.innerHTML = '<li><span class="nick">기록이 없습니다.</span><span class="time"></span></li>'; }
    }catch(e){
      list.innerHTML = '<li><span class="nick">불러오기에 실패했습니다.</span><span class="time"></span></li>';
    }
  }
  async function submitScore(){
    const input = document.getElementById('nicknameInput');
    const nickname = (input.value||'').trim();
    if(!nickname){ input.focus(); return; }
    const ms = lastElapsedMs || elapsedMs;
    try{
      await fetch('/api/submit',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ hand: HAND_SIZE, nickname, ms })
      });
      document.getElementById('submitModal').hidden = true;
      // 제출 후 랭킹 보기로 안내
      openRankingModal();
    }catch(e){
      alert('제출에 실패했습니다. 잠시 후 다시 시도해주세요.');
    }
  }

  // FX
  function pulse(node){ node.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:180}); }
  function shake(node){ node.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:200}); }
  function showPenaltyFloat(x, y){
    const elFloat = document.createElement('div');
    elFloat.className = 'penalty-float show';
    elFloat.textContent = '+1s';
    elFloat.style.left = `${x}px`;
    elFloat.style.top = `${y}px`;
    document.body.appendChild(elFloat);
    setTimeout(()=>{ elFloat.remove(); }, 1000);
  }
  function burstAt(x, y, color){
    const count = 10;
    for(let i=0;i<count;i++){
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.background = color || '#111';
      const angle = (Math.PI*2) * (i/count);
      const dist = 30 + Math.random()*20;
      const dx = Math.cos(angle)*dist;
      const dy = Math.sin(angle)*dist;
      p.style.setProperty('--dx', `${dx}px`);
      p.style.setProperty('--dy', `${dy}px`);
      p.style.left = `${x}px`;
      p.style.top = `${y}px`;
      p.style.animation = 'pop 480ms ease-out forwards';
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 520);
    }
  }

  // Utils
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function log(msg, cls){
    if(!el.log){ console && console.log && console.log(msg); return; }
    const p=document.createElement('p'); p.innerHTML=msg; if(cls) p.classList.add(cls); el.log.appendChild(p); el.log.scrollTop = el.log.scrollHeight;
  }
  function cardKey(c){ return String(c.rank) + c.suit; }
  function drawAvoiding(forbiddenSet){
    let attempts = 0;
    const maxAttempts = (deck.length + discard.length) + 4;
    while(attempts < maxAttempts){
      const c = draw();
      if(c==null) return null;
      if(!forbiddenSet || !forbiddenSet.has(cardKey(c))){
        return c;
      }
      // 피해야 할 카드면 덱 하단으로 보내고 다시 시도
      deck.push(c);
      attempts++;
    }
    // 안전장치: 더 이상 시도하지 않고 일반 드로우
    return draw();
  }

  // Pips helper
  function pipsHTML(rank, suit){
    const size = 16; // base font-size for pips
    const pip = (xPct, yPct, rot=0) => `<span class="pip" style="left:${xPct}%;top:${yPct}%;transform:translate(-50%,-50%) rotate(${rot}deg);font-size:${size}px">${suit}</span>`;
    // Layout presets (percent positions). Using standard-ish pip patterns for 1-10
    const mid=50, left=26, right=74, top=22, v2=35, v3=50, v4=65, bottom=78;
    switch(rank){
      case 1: return `<div class="pips">${pip(mid,mid)}</div>`;
      case 2: return `<div class="pips">${pip(mid,top)}${pip(mid,bottom)}</div>`;
      case 3: return `<div class="pips">${pip(mid,top)}${pip(mid,mid)}${pip(mid,bottom)}</div>`;
      case 4: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,bottom)}${pip(right,bottom)}</div>`;
      case 5: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(mid,mid)}${pip(left,bottom)}${pip(right,bottom)}</div>`;
      case 6: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,mid)}${pip(right,mid)}${pip(left,bottom)}${pip(right,bottom)}</div>`;
      case 7: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,mid)}${pip(right,mid)}${pip(left,bottom)}${pip(right,bottom)}${pip(mid,35)}</div>`;
      case 8: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,mid)}${pip(right,mid)}${pip(left,bottom)}${pip(right,bottom)}${pip(mid,35)}${pip(mid,65)}</div>`;
      case 9: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,mid)}${pip(right,mid)}${pip(left,bottom)}${pip(right,bottom)}${pip(mid,32)}${pip(mid,50)}${pip(mid,68)}</div>`;
      case 10: return `<div class="pips">${pip(left,top)}${pip(right,top)}${pip(left,v2)}${pip(right,v2)}${pip(left,v4)}${pip(right,v4)}${pip(left,bottom)}${pip(right,bottom)}${pip(mid,40)}${pip(mid,60)}</div>`;
      default: return `<div class="pips"></div>`;
    }
  }

  // Audio (tiny oscillator-based beeps)
  let audioCtx = null;
  const sfx = {
    // 빠밤~ (메이저 4도 → 1도 느낌의 강세 이중음)
    start: ()=> { beep(523.25, 0.02, 0.08, 0.10); setTimeout(()=>beep(392.00, 0.02, 0.14, 0.12), 90); },
    // 밝은 3음 상승 (띠-로-롱)
    correct: ()=> { beep(660, 0.02, 0.04, 0.04); setTimeout(()=>beep(784, 0.02, 0.05, 0.05), 70); setTimeout(()=>beep(988, 0.02, 0.08, 0.06), 150); },
    // 짧은 하강 2음
    wrong: ()=> { beep(196, 0.03, 0.04, 0.06); setTimeout(()=>beep(174, 0.03, 0.05, 0.08), 80); },
    pass: ()=> beep(330, 0.05, 0.02, 0.05),
    shuffle: ()=> { beep(520, 0.03, 0.01, 0.03); setTimeout(()=>beep(620, 0.03, 0.01, 0.03), 45); }
  };
  function setupAudio(){
    try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    catch(e){ audioCtx = null; }
  }
  function beep(freq, attack=0.01, sustain=0.04, release=0.04){
    if(!audioCtx) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq;
    const now = ctx.currentTime;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.15, now+attack);
    g.gain.setValueAtTime(0.15, now+attack+sustain);
    g.gain.linearRampToValueAtTime(0, now+attack+sustain+release);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(now+attack+sustain+release+0.02);
  }

  // Modal helpers
  function showResultModal(data){
    const modal = document.getElementById('resultModal');
    document.getElementById('resultBest').textContent = (function(){ const ms = Number(localStorage.getItem(getBestTimeKey())||'NaN'); return Number.isFinite(ms) ? (ms/1000).toFixed(2)+'s' : '-'; })();
    document.getElementById('resultCombo').textContent = (data.timeSec ? Number(data.timeSec).toFixed(2) + 's' : '-');
    modal.hidden = false;
  }
  function hideResultModal(){
    const modal = document.getElementById('resultModal');
    modal.hidden = true;
  }

  init();
})();
</script>
</body>
</html>
